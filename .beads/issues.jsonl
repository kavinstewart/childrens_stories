{"id":"story-015","title":"Deduplicate GenerationType enum","description":"GenerationType is defined in both src/api/models/requests.py:7-12 and src/api/models/responses.py:18-23. Move to a shared location and import from there.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:54:22.848338-08:00","updated_at":"2025-12-17T11:57:12.657671-08:00","closed_at":"2025-12-17T11:57:12.657671-08:00"}
{"id":"story-027","title":"Add retry with exponential backoff for LLM calls","description":"Wrap DSPy LLM calls with tenacity - 3 retries, exponential backoff (2s, 4s, 8s), only retry on network/timeout errors (not validation errors). Apply to individual LLM calls, not entire story generation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:08:21.576484-08:00","updated_at":"2025-12-19T15:26:24.29166-08:00","closed_at":"2025-12-19T15:26:24.29166-08:00"}
{"id":"story-04ax","title":"Audit: Auth Flow","description":"**Code Path**: Backend + Frontend Auth\n\n**Files to examine**:\n- backend/api/auth/routes.py\n- backend/api/auth/tokens.py\n- backend/api/dependencies.py (auth-related)\n- frontend/features/auth/store.ts\n- frontend/lib/auth-storage.ts\n- frontend/app/login.tsx\n\n**Investigation goals**:\n1. Look for duplicated token handling (creation vs verification)\n2. Check for duplicated auth header injection\n3. Identify non-KISS complexity in auth flow\n4. Look for duplicated login/logout state management\n5. Check for SRP violations in auth components\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:50.399202755Z","created_by":"kavin","updated_at":"2026-01-03T19:28:50.399202755Z"}
{"id":"story-0b9","title":"Audit DirectStoryGenerator for dead code","description":"Review backend/core/modules/direct_story_generator.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:26:49.309294-08:00","updated_at":"2025-12-26T15:39:12.787007-08:00","closed_at":"2025-12-26T15:39:12.787007-08:00"}
{"id":"story-0fe","title":"Test full illustration pipeline with Nano Banana Pro","description":"Run end-to-end test generating an illustrated story. Verify character consistency across all pages.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:13:18.248827-08:00","updated_at":"2025-12-16T11:27:56.494286-08:00","closed_at":"2025-12-16T11:27:56.494286-08:00","dependencies":[{"issue_id":"story-0fe","depends_on_id":"story-9on","type":"blocks","created_at":"2025-12-16T11:13:53.217755-08:00","created_by":"kavinstewart"}]}
{"id":"story-0fo","title":"Create VLM eval admin API routes","description":"Add /admin/vlm-evals routes: GET list (paginated), GET by id (with images as base64), POST annotate (human ground truth), GET export (GEPA dataset). Mount under admin router.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:11:51.850378-08:00","updated_at":"2025-12-27T10:26:02.809412-08:00","closed_at":"2025-12-27T10:26:02.809412-08:00","dependencies":[{"issue_id":"story-0fo","depends_on_id":"story-xfg","type":"blocks","created_at":"2025-12-27T06:12:07.933541-08:00","created_by":"kavinstewart"}]}
{"id":"story-0k9","title":"Audit frontend Root Layout for dead code","description":"Review frontend/app/_layout.tsx looking for redundant and/or dead code. Check for unused imports, deprecated patterns, and unused components.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:53.150554-08:00","updated_at":"2025-12-26T15:39:12.795767-08:00","closed_at":"2025-12-26T15:39:12.795767-08:00"}
{"id":"story-0mf","title":"Flatten modules/qa_metrics/ into modules/","description":"Move vlm_judge.py and vqa_scorer.py from modules/qa_metrics/ directly into modules/. Delete the qa_metrics/ subdirectory. Update all imports accordingly. Premature nesting hurts discoverability - keep flat until 10+ related files.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:24.810218-08:00","updated_at":"2025-12-17T09:04:10.045925-08:00","closed_at":"2025-12-17T09:04:10.045925-08:00","dependencies":[{"issue_id":"story-0mf","depends_on_id":"story-849","type":"blocks","created_at":"2025-12-17T08:31:25.162446-08:00","created_by":"kavinstewart"}]}
{"id":"story-0vd3","title":"Remove deprecated page-by-page generation pattern","description":"Search for and remove all references to the old PageGenerator/PageWriter pattern that generated pages one at a time. This includes:\n- PageGenerator module\n- PageWriterSignature, PageCritiqueSignature, PageRevisionSignature\n- StoryPage type (if only used by old pattern)\n- Any optimization files for page_writer\n- Documentation references\n- Test files\n\nVerify tests pass after removal.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T18:19:05.773502078Z","created_by":"kavin","updated_at":"2025-12-30T18:23:39.391451097Z","closed_at":"2025-12-30T18:23:39.391451097Z","close_reason":"Removed PageGenerator, PageWriter signatures, StoryPage alias, optimize_page_writer.py, debug_page.py. Updated README and __init__ exports. All 45 tests pass."}
{"id":"story-15a","title":"Add progress callbacks to StoryGenerator for granular updates","description":"Currently progress only updates at stage boundaries (5 updates total). Add on_progress callback to generate_illustrated(), CharacterSheetGenerator, and SpreadIllustrator to report per-character and per-spread progress. This gives smooth progress bar updates instead of chunky jumps.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-25T10:28:00.841774-08:00","updated_at":"2025-12-25T10:38:15.523404-08:00","closed_at":"2025-12-25T10:38:15.523404-08:00","dependencies":[{"issue_id":"story-15a","depends_on_id":"story-pn2","type":"blocks","created_at":"2025-12-25T10:28:11.841849-08:00","created_by":"kavinstewart"}]}
{"id":"story-1aa6","title":"Rewrite repository.py with raw SQL","description":"Replace SQLAlchemy ORM queries with raw asyncpg parameterized queries. Use $1, $2 placeholders. Use explicit transactions for save_completed_story. Update _model_to_response to handle asyncpg.Record.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.383570667Z","created_by":"kavin","updated_at":"2025-12-30T00:26:41.152231386Z","closed_at":"2025-12-30T00:26:41.152231386Z","close_reason":"Converted repository.py to raw asyncpg SQL with parameterized queries, transactions, and executemany","dependencies":[{"issue_id":"story-1aa6","depends_on_id":"story-w025","type":"blocks","created_at":"2025-12-30T00:24:18.402874731Z","created_by":"daemon"}]}
{"id":"story-1f5","title":"Add Nano Banana Pro config to config.py","description":"Add get_image_lm() function returning gemini-3-pro-image-preview model. Add GOOGLE_API_KEY to env loading.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:12:51.768234-08:00","updated_at":"2025-12-16T11:19:08.427556-08:00","closed_at":"2025-12-16T11:19:08.427556-08:00"}
{"id":"story-1j3","title":"Add granular progress tracking to story generation","description":"Add granular progress tracking with ProgressTracker class.\n\nSCHEMA:\n- stage: 'outline' | 'spreads' | 'quality' | 'character_refs' | 'illustrations' | 'failed'\n- stage_detail: Human-readable message (e.g., 'Illustrating spread 7 of 12')\n- percentage: 0-100 weighted (outline 0-15%, spreads 15-25%, quality 25-30%, character_refs 30-40%, illustrations 40-100%)\n- characters_total/completed: For character ref stage\n- spreads_total/completed: For illustration stage  \n- quality_attempt/max/score: For quality loop\n- warnings: Non-fatal issues (e.g., image QA failed but accepted)\n- updated_at: Timestamp\n\nCHECKPOINTS (ILLUSTRATED story):\n1. 0% - Crafting outline\n2. 15% - Writing story (12 spreads)\n3. 25-30% - Quality review (with retry context)\n4. 30-40% - Creating character: {name} (per character)\n5. 40-100% - Illustrating spread {N} of 12 (per spread, with retry context)\n\nIMPLEMENTATION:\n- ProgressTracker class with sync interface + async DB writes\n- Debounce at 500ms to limit DB load\n- Inject optionally into generators\n- Add progress JSON column to stories table\n- Silent fail on DB errors","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:08:28.123023-08:00","updated_at":"2025-12-19T15:26:24.293926-08:00","closed_at":"2025-12-19T15:26:24.293926-08:00"}
{"id":"story-1o4","title":"Create DSPy modules","description":"Implement OutlineGenerator, PageGenerator, and QualityJudge modules in src/modules/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:10.505417-08:00","updated_at":"2025-12-11T09:46:02.978276-08:00","closed_at":"2025-12-11T09:46:02.978276-08:00","dependencies":[{"issue_id":"story-1o4","depends_on_id":"story-ffw","type":"blocks","created_at":"2025-12-11T09:38:38.733875-08:00","created_by":"kavinstewart"},{"issue_id":"story-1o4","depends_on_id":"story-ggb","type":"blocks","created_at":"2025-12-11T09:39:00.658325-08:00","created_by":"kavinstewart"},{"issue_id":"story-1o4","depends_on_id":"story-5d3","type":"blocks","created_at":"2025-12-11T09:39:05.810296-08:00","created_by":"kavinstewart"}]}
{"id":"story-1p5","title":"Audit CLI entry points for dead code","description":"Review cli/generate_story.py, cli/run_api.py, and cli/debug_page.py looking for redundant and/or dead code. Check for unused arguments, deprecated paths, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:04.774853-08:00","updated_at":"2025-12-26T15:39:12.79431-08:00","closed_at":"2025-12-26T15:39:12.79431-08:00"}
{"id":"story-1qa","title":"Create character extractor from completed story","description":"Create a signature/module that takes a completed story and extracts the characters that actually appear. Should identify: character names, what spreads they appear in, key actions/traits shown in the text. This replaces the outline's character field.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T19:44:03.816805-08:00","updated_at":"2025-12-19T20:24:07.303989-08:00","closed_at":"2025-12-19T20:24:07.303989-08:00","dependencies":[{"issue_id":"story-1qa","depends_on_id":"story-m3r","type":"blocks","created_at":"2025-12-19T19:44:43.89334-08:00","created_by":"kavinstewart"}]}
{"id":"story-1qk","title":"Audit BibleGenerator for dead code","description":"Review backend/core/modules/bible_generator.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:01.91496-08:00","updated_at":"2025-12-26T15:39:12.788792-08:00","closed_at":"2025-12-26T15:39:12.788792-08:00"}
{"id":"story-2141","title":"Make eviction atomic (index-first ordering)","description":"In story-cache.ts evictStory() (lines 156-159):\n- Currently: delete files THEN update index\n- If crash between: index points to missing files (phantom cache entry)\n\nFix: Reverse order - remove from index FIRST, then delete files.\nIf crash after index update but before file delete:\n- Index says 'not cached' ‚úì (correct pessimistic state)\n- Orphaned files cleaned up by verifyCacheIntegrity()\n\nThis is fail-safe vs fail-dangerous ordering.","status":"closed","priority":1,"issue_type":"bug","estimated_minutes":15,"created_at":"2026-01-05T04:20:20.347089817Z","created_by":"kavin","updated_at":"2026-01-05T04:39:47.987822157Z","closed_at":"2026-01-05T04:39:47.987822157Z","close_reason":"Reversed eviction order: remove from index first, then delete files. Fail-safe ordering.","dependencies":[{"issue_id":"story-2141","depends_on_id":"story-s7y5","type":"blocks","created_at":"2026-01-05T04:20:20.353518272Z","created_by":"daemon"}]}
{"id":"story-24w","title":"Test QA pipeline end-to-end","description":"Generate illustrated story with QA enabled, verify regeneration works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:40.410193-08:00","updated_at":"2025-12-16T12:18:01.914429-08:00","closed_at":"2025-12-16T12:18:01.914429-08:00","dependencies":[{"issue_id":"story-24w","depends_on_id":"story-cz1","type":"blocks","created_at":"2025-12-16T11:49:17.501138-08:00","created_by":"kavinstewart"}]}
{"id":"story-2b1a","title":"Add unit tests for ARQ worker","description":"Test task enqueueing, worker execution, and error handling. Mock Redis for unit tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:31.204986891Z","created_by":"kavin","updated_at":"2025-12-29T23:43:43.239371017Z","closed_at":"2025-12-29T23:43:43.239371017Z","close_reason":"Added 12 unit tests for ARQ worker: task function, worker settings, and arq_pool module. All tests pass.","dependencies":[{"issue_id":"story-2b1a","depends_on_id":"story-6l27","type":"blocks","created_at":"2025-12-29T22:23:46.569527031Z","created_by":"daemon"}]}
{"id":"story-2bfy","title":"DRY: Extract background task lifecycle pattern","description":"**Problem**: Both `story_generation.py` and `spread_regeneration.py` duplicate the same lifecycle pattern:\n1. Create asyncpg pool\n2. Update status to 'running'\n3. Execute main logic in try block\n4. Update status to 'failed' with error in except\n5. Close pool in finally\n\n**Locations**:\n- story_generation.py:54-159\n- spread_regeneration.py:44-158\n\n**Fix**: Consider a context manager or decorator that handles pool lifecycle and status updates:\n```python\nasync with background_task_context(story_id, repo) as pool:\n    # main logic\n```\n\nNote: May be acceptable duplication given the two tasks have slightly different status update methods. Evaluate if abstraction adds clarity or obscures.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:40:05.755205953Z","created_by":"kavin","updated_at":"2026-01-03T22:49:53.326193401Z","closed_at":"2026-01-03T22:49:53.326193401Z","close_reason":"Won't fix - acceptable structural similarity. The two tasks use different status update methods, track different entities, and have different auxiliary concerns (ProgressTracker). Abstracting would add indirection without clear benefit. The try/except/finally pattern is a common, self-documenting async task lifecycle."}
{"id":"story-2gc","title":"Create job manager and story service","description":"Create src/api/services/ with job_manager.py and story_service.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:23:57.751706-08:00","updated_at":"2025-12-17T11:27:59.054549-08:00","closed_at":"2025-12-17T11:27:59.054549-08:00","dependencies":[{"issue_id":"story-2gc","depends_on_id":"story-41h","type":"blocks","created_at":"2025-12-17T11:24:33.811969-08:00","created_by":"kavinstewart"},{"issue_id":"story-2gc","depends_on_id":"story-mgx","type":"blocks","created_at":"2025-12-17T11:24:38.986538-08:00","created_by":"kavinstewart"}]}
{"id":"story-2hu","title":"Protect story routes with auth","description":"Add Depends(get_current_user) to all story routes in backend/api/routes/stories.py. Update main.py to include auth router.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:12.640978361Z","created_by":"kavin","updated_at":"2025-12-29T01:37:13.943939444Z","closed_at":"2025-12-29T01:37:13.943939444Z","close_reason":"Protected all story routes with CurrentUser dependency","dependencies":[{"issue_id":"story-2hu","depends_on_id":"story-qtg","type":"blocks","created_at":"2025-12-29T01:30:31.955485997Z","created_by":"daemon"},{"issue_id":"story-2hu","depends_on_id":"story-up5","type":"blocks","created_at":"2025-12-29T01:30:31.969650513Z","created_by":"daemon"}]}
{"id":"story-2k0","title":"Split config.py into focused modules","description":"Split the monolithic config.py into separate concerns:\n- src/config/llm.py - LLM providers, fallbacks, configure_dspy()\n- src/config/story.py - Story constants (page count, word limits, etc.)\n- src/config/image.py - Nano Banana/Gemini image generation setup\nCreate src/config/__init__.py with convenient re-exports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:37.740627-08:00","updated_at":"2025-12-17T09:05:24.386858-08:00","closed_at":"2025-12-17T09:05:24.386858-08:00","dependencies":[{"issue_id":"story-2k0","depends_on_id":"story-849","type":"blocks","created_at":"2025-12-17T08:31:12.377791-08:00","created_by":"kavinstewart"}]}
{"id":"story-2kac","title":"Audit: DSPy Signatures","description":"**Code Path**: backend/core/signatures/\n\n**Files to examine**:\n- backend/core/signatures/direct_story.py\n- backend/core/signatures/story_outline.py\n- backend/core/signatures/character_bible.py\n- backend/core/signatures/illustration_style.py\n- backend/core/signatures/quality_judge.py\n- All other signature files\n\n**Investigation goals**:\n1. Look for duplicated field definitions across signatures\n2. Check for duplicated docstring/constraint patterns\n3. Identify overly verbose or redundant signature descriptions\n4. Look for signatures that could be consolidated\n5. Check for unused or deprecated signatures\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:41.549218977Z","created_by":"kavin","updated_at":"2026-01-04T14:28:32.388600878Z","closed_at":"2026-01-04T14:28:32.388600878Z","close_reason":"Audit complete. Created 4 sub-beads:\n- story-2kac.1: DirectStorySignature output field duplicates docstring (P3)\n- story-2kac.2: StoryJudgeSignature repeats Chekhov's Gun 7+ times (P3)\n- story-2kac.3: IllustrationStyleSignature lacks guidance vs peers (P3)\n- story-2kac.4: Shared character format constant - low priority (P4)\n\nNo unused/deprecated signatures found - all 5 are actively used."}
{"id":"story-2kac.1","title":"Fix: DirectStorySignature output field duplicates class docstring","description":"**File**: backend/core/signatures/direct_story.py\n\n**Issue**: The `story` output field description (lines 83-99) duplicates most of the OUTPUT FORMAT section from the class docstring (lines 53-71).\n\n**Evidence**:\n- Class docstring lines 53-71 define the output format\n- Output field desc lines 83-99 repeat nearly the same format specification\n\n**Proposed fix**: Remove the duplicated format from the output field desc. Keep just a brief reference: `desc=\"Complete story following the format specified in the signature docstring\"`. The docstring is already part of the prompt.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T14:27:48.679261507Z","created_by":"kavin","updated_at":"2026-01-05T03:46:02.053550305Z","closed_at":"2026-01-05T03:46:02.053550305Z","close_reason":"Fixed by removing duplicated format from output field desc","dependencies":[{"issue_id":"story-2kac.1","depends_on_id":"story-2kac","type":"parent-child","created_at":"2026-01-04T14:27:48.68032116Z","created_by":"daemon"}]}
{"id":"story-2kac.2","title":"Fix: StoryJudgeSignature repeats Chekhov's Gun rule 7+ times","description":"**File**: backend/core/signatures/story_judge.py\n\n**Issue**: The Chekhov's Gun rule is mentioned in 7 different places:\n1. Line 20-21 (AUTOMATIC FAILURES)\n2. Line 28-29 (MAJOR PROBLEMS)  \n3. Lines 30-34 (dedicated section)\n4. Line 42-43 (GOOD stories)\n5. Lines 49-50 (EXCELLENT stories)\n6. Lines 87-95 (chekhov_violations field desc)\n7. Lines 97-99 (chekhov_score field desc)\n\n**Impact**: Token waste and potential for inconsistent guidance.\n\n**Proposed fix**: Consolidate into ONE authoritative section. Other references become brief pointers: \"(see Chekhov's Gun section above)\". The detailed rule lives in one place.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T14:28:00.570211104Z","created_by":"kavin","updated_at":"2026-01-04T14:37:50.047246108Z","closed_at":"2026-01-04T14:37:50.047246108Z","close_reason":"Moot - parent bead story-ug8n will remove StoryJudgeSignature entirely","dependencies":[{"issue_id":"story-2kac.2","depends_on_id":"story-2kac","type":"parent-child","created_at":"2026-01-04T14:28:00.575728309Z","created_by":"daemon"}]}
{"id":"story-2kac.3","title":"Fix: IllustrationStyleSignature has minimal guidance vs peers","description":"**File**: backend/core/signatures/illustration_style.py\n\n**Issue**: This signature has only a 1-line docstring (`Select an illustration style for a children's book.`) while peer signatures have 20-50 line docstrings with detailed guidance.\n\n**Evidence**:\n- DirectStorySignature: ~60 lines of docstring\n- StoryJudgeSignature: ~40 lines of docstring\n- CharacterBibleSignature: ~25 lines of docstring\n- IllustrationStyleSignature: 1 line\n\n**Impact**: LLM may make arbitrary style choices without context about what makes styles appropriate for different stories.\n\n**Proposed fix**: Add guidance about style-story matching criteria:\n- When to use watercolor_ink vs digital_cartoon\n- How tone/mood maps to style choices\n- Age appropriateness considerations\n\nKeep it concise (10-15 lines) to match KISS principles.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T14:28:12.694298962Z","created_by":"kavin","updated_at":"2026-01-05T03:46:47.358659441Z","closed_at":"2026-01-05T03:46:47.358659441Z","close_reason":"Added style-story matching guidance to docstring","dependencies":[{"issue_id":"story-2kac.3","depends_on_id":"story-2kac","type":"parent-child","created_at":"2026-01-04T14:28:12.699667312Z","created_by":"daemon"}]}
{"id":"story-2kac.4","title":"Consider: Extract shared character format constant","description":"**Files**: \n- backend/core/signatures/character_extractor.py\n- backend/core/signatures/character_bible.py\n- backend/core/modules/character_extractor.py\n- backend/core/modules/bible_generator.py\n\n**Observation**: The `NAME: [name] | DETAILS: [description]` format is defined in:\n1. CharacterExtractorSignature docstring (lines 20-27)\n2. CharacterExtractorSignature output field (line 38-39)\n3. CharacterBibleSignature input field (line 45-47)\n4. character_extractor.py module parsing (line 44-48)\n5. bible_generator.py module formatting (line 32)\n\n**Trade-off analysis**:\n- **Pro**: Single source of truth, easier to change format\n- **Con**: Adds indirection, format is unlikely to change\n\n**Recommendation**: LOW priority. The format is stable and the duplication is benign. Only fix if making other changes to these files. Mark as P4/wontfix unless it causes actual problems.","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-04T14:28:23.860471514Z","created_by":"kavin","updated_at":"2026-01-05T03:52:05.224498509Z","closed_at":"2026-01-05T03:52:05.224498509Z","close_reason":"Wontfix: Format is stable, duplication is benign, and constants can't be used in docstrings where most usage occurs. The added indirection isn't worth the minimal benefit.","dependencies":[{"issue_id":"story-2kac.4","depends_on_id":"story-2kac","type":"parent-child","created_at":"2026-01-04T14:28:23.865663249Z","created_by":"daemon"}]}
{"id":"story-2r2b","title":"Add stale job cleanup mechanism","description":"Spread regen jobs can get stuck in 'pending' if worker fails. Need:\n1. A timeout mechanism to mark old pending jobs as failed (e.g., jobs pending \u003e 10 min)\n2. Or a startup cleanup that marks all pending/running jobs as failed when worker restarts\n3. Better error propagation from ARQ to PostgreSQL","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T03:31:39.40871172Z","created_by":"kavin","updated_at":"2026-01-03T16:27:09.995862793Z","closed_at":"2026-01-03T16:27:09.995862793Z","close_reason":"Implemented: 1) Timeout filter in get_active_spread_regen_job (pending\u003e2min, running\u003e12min), 2) cleanup_stale_spread_regen_jobs repo method, 3) Cron job every minute, 4) Worker startup cleanup","comments":[{"id":2,"issue_id":"story-2r2b","author":"kavin","text":"## Technical Details\n\n**Affected files:**\n- `backend/api/routes/stories.py:198-204` - checks for active jobs\n- `backend/api/services/story_service.py:87` - creates job record\n- `backend/worker.py` - ARQ worker entry point\n\n**Implementation options:**\n\n1. **Worker startup cleanup** (simplest):\n   - In `WorkerSettings.on_startup`, mark all pending/running jobs as failed\n   - Pros: Simple, handles worker restarts\n   - Cons: Loses in-flight jobs on restart\n\n2. **Timeout-based cleanup**:\n   - Add `created_at` check in `get_active_spread_regen_job()`\n   - Only consider jobs 'active' if created \u003c 10 minutes ago\n   - Pros: More robust, works without worker restart\n   - Cons: 10 min delay before retry possible\n\n3. **ARQ result callback**:\n   - Use ARQ's `on_job_end` to update PostgreSQL status on failure\n   - Pros: Immediate failure detection\n   - Cons: More complex, need to handle edge cases\n\n**Recommended**: Option 2 (timeout) is safest - add to repository query:\n```sql\nWHERE status IN ('pending', 'running')\n  AND created_at \u003e NOW() - INTERVAL '10 minutes'\n```","created_at":"2026-01-02T03:32:51Z"},{"id":3,"issue_id":"story-2r2b","author":"kavin","text":"## Expert Panel Recommendations\n\n**Option 4 (Recommended): Hybrid approach**\nCombine ARQ callback (immediate failure detection) + timeout (backstop for crashes):\n\n```python\n# In WorkerSettings\nasync def on_job_end(ctx, result, exc):\n    if exc and 'job_id' in ctx:\n        await mark_job_failed(ctx['job_id'], str(exc))\n```\n\n**Differentiate timeouts by status:**\n```sql\nWHERE (status = 'pending' AND created_at \u003e NOW() - INTERVAL '2 minutes')\n   OR (status = 'running' AND started_at \u003e NOW() - INTERVAL '12 minutes')\n```\n- Pending: 2 min (should be picked up quickly)\n- Running: job_timeout (600s) + 2 min buffer\n\n**Add observability:**\n- Metric: `spread_regen_job_age_seconds{status}`\n- Alert: Any job pending \u003e 2 min or running \u003e 12 min\n- Dashboard: Job state transitions over time\n\n**Add heartbeat for long-running jobs:**\n- Add `last_heartbeat` column to `spread_regen_jobs`\n- Update periodically during image generation\n- Consider 'running' jobs stale if heartbeat \u003e 2 min old\n\n**Testing strategy:**\n- Add dev endpoint to simulate stuck jobs\n- Integration test: create job, kill worker, verify cleanup\n- Load test: verify no race conditions with concurrent requests\n\n**Runbook for manual intervention:**\n```sql\n-- View stuck jobs\nSELECT id, spread_number, status, created_at \nFROM spread_regen_jobs \nWHERE status IN ('pending', 'running')\nORDER BY created_at;\n\n-- Clear stuck jobs\nUPDATE spread_regen_jobs \nSET status = 'failed', error_message = 'Manual cleanup: stale job'\nWHERE status IN ('pending', 'running') \n  AND created_at \u003c NOW() - INTERVAL '10 minutes';\n```","created_at":"2026-01-02T03:38:02Z"}]}
{"id":"story-2wc3","title":"DRY: Extract DSN conversion to helper function","description":"**Problem**: DSN conversion logic `DATABASE_URL.replace(\"+asyncpg\", \"\")` is duplicated in 4 places:\n- backend/api/database/db.py:36\n- backend/api/services/progress_tracker.py:47\n- backend/api/services/spread_regeneration.py:47\n- backend/api/services/story_generation.py:57\n\n**Fix**: Add `get_dsn()` helper to `backend/api/config.py` and use it everywhere.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:39:34.295473264Z","created_by":"kavin","updated_at":"2026-01-03T22:46:59.070067435Z","closed_at":"2026-01-03T22:46:59.070067435Z","close_reason":"Fixed in commit 5744dae"}
{"id":"story-2xmk","title":"Add PostgreSQL environment configuration","description":"Add DATABASE_URL and PostgreSQL connection settings to .env and config module","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:40.842207871Z","created_by":"kavin","updated_at":"2025-12-29T14:57:36.463487139Z","closed_at":"2025-12-29T14:57:36.463487139Z","close_reason":"Added DATABASE_URL env var to config","dependencies":[{"issue_id":"story-2xmk","depends_on_id":"story-5vv","type":"blocks","created_at":"2025-12-29T14:44:10.012035379Z","created_by":"daemon"}]}
{"id":"story-2xzc","title":"Make caching atomic (files-first ordering)","description":"In story-cache.ts cacheStory():\n- Index is updated AFTER files written (good)\n- BUT catch block (line 114) only deletes files, doesn't remove partial index entry\n\nIf error happens after partial index write somehow, orphaned entry remains.\n\nFix: In catch block, also call cacheStorage.removeStoryEntry(storyId) to ensure cleanup is complete.","status":"closed","priority":1,"issue_type":"bug","estimated_minutes":15,"created_at":"2026-01-05T04:20:28.617273197Z","created_by":"kavin","updated_at":"2026-01-05T04:40:35.260239186Z","closed_at":"2026-01-05T04:40:35.260239186Z","close_reason":"Added index cleanup to cacheStory catch block. Cleanup now removes both index entry and files.","dependencies":[{"issue_id":"story-2xzc","depends_on_id":"story-2141","type":"blocks","created_at":"2026-01-05T04:20:28.624949399Z","created_by":"daemon"}]}
{"id":"story-3dc","title":"Audit JobManager for dead code","description":"Review backend/api/services/job_manager.py looking for redundant and/or dead code. Check for unused methods, deprecated patterns, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:20.587718-08:00","updated_at":"2025-12-26T15:39:12.792158-08:00","closed_at":"2025-12-26T15:39:12.792158-08:00"}
{"id":"story-3g1","title":"Audit VLMJudge for dead code","description":"Review backend/core/modules/vlm_judge.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:39.601604-08:00","updated_at":"2025-12-26T15:39:12.790865-08:00","closed_at":"2025-12-26T15:39:12.790865-08:00"}
{"id":"story-3i2","title":"Add CharacterBible to story outline","description":"Extend StoryOutlineSignature to output structured character definitions with locked visual attributes (face, hair, clothing, colors, age, style tags) for each character","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T10:35:00.58306-08:00","updated_at":"2025-12-13T10:38:12.346119-08:00","closed_at":"2025-12-13T10:38:12.346119-08:00"}
{"id":"story-3iv2","title":"Audit: Character Processing \u0026 Name Matching","description":"**Code Path**: backend/core/ (character-related)\n\n**Files to examine**:\n- backend/core/types.py (especially _names_match and related)\n- backend/core/modules/character_extractor.py\n- backend/core/modules/bible_generator.py\n- Any other files with character name normalization\n\n**Investigation goals**:\n1. Look for duplicated name normalization logic across files\n2. Check for duplicated character lookup/matching patterns\n3. Identify overly complex matching heuristics\n4. Look for scattered character-related utilities\n5. Check if character processing should be consolidated\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:36.663619944Z","created_by":"kavin","updated_at":"2026-01-03T19:28:36.663619944Z"}
{"id":"story-3li","title":"Refactor StoryGenerator to use story-first pipeline","description":"Update StoryGenerator to use new workflow: 1) Generate story in one shot, 2) Extract characters from story, 3) Generate character bibles, 4) Select illustration style. Remove OutlineGenerator dependency.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T19:44:17.093939-08:00","updated_at":"2025-12-20T09:47:39.85171-08:00","closed_at":"2025-12-20T09:47:39.85171-08:00","dependencies":[{"issue_id":"story-3li","depends_on_id":"story-m3r","type":"blocks","created_at":"2025-12-19T19:44:54.202771-08:00","created_by":"kavinstewart"},{"issue_id":"story-3li","depends_on_id":"story-1qa","type":"blocks","created_at":"2025-12-19T19:44:59.362339-08:00","created_by":"kavinstewart"},{"issue_id":"story-3li","depends_on_id":"story-bwr","type":"blocks","created_at":"2025-12-19T19:45:04.515728-08:00","created_by":"kavinstewart"}]}
{"id":"story-3vc9","title":"Unit tests: spread regeneration service logic","description":"Test the core regeneration logic in spread_regeneration.py.\n\n## Test File\n`backend/tests/unit/test_spread_regeneration_service.py`\n\n## Test Cases\n\n### test_regenerate_spread_calls_illustrator_with_correct_params\n- Mock SpreadIllustrator.illustrate_spread\n- Verify called with:\n  - Correct spread object\n  - Story outline\n  - Character reference sheets\n- Verify image bytes returned\n\n### test_regenerate_spread_saves_image_atomically\n- Mock filesystem operations\n- Verify writes to temp file first\n- Verify atomic rename/move to final path\n- Final path: `{STORIES_DIR}/{story_id}/images/spread_{num:02d}.png`\n\n### test_regenerate_spread_updates_database_on_success\n- Mock illustrator to return image bytes\n- Verify repository.save_regenerated_spread called\n- Verify job status updated to 'completed'\n- Verify illustration_updated_at is set\n\n### test_regenerate_spread_handles_illustrator_failure\n- Mock illustrator to raise exception\n- Verify job status updated to 'failed'\n- Verify error_message is set\n- Verify old image is NOT deleted (error recovery)\n\n### test_regenerate_spread_handles_missing_character_refs\n- Story has no character references\n- Regeneration still succeeds (refs are optional)\n- Illustrator called with empty refs\n\n### test_regenerate_spread_loads_correct_spread_data\n- Story has 12 spreads\n- Request regeneration for spread 7\n- Verify correct spread object passed to illustrator\n\n### test_regenerate_spread_preserves_original_prompt\n- Spread has illustration_prompt set\n- After regeneration, prompt is unchanged\n- Only image changes\n\n### test_regenerate_spread_timeout_handling\n- Mock illustrator to hang/timeout\n- Verify job marked as failed after timeout\n- Verify appropriate error message\n\n## Fixtures\n- Sample GeneratedStory with spreads and character refs\n- Mock SpreadIllustrator\n- Test database connection","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:57:24.795158977Z","created_by":"kavin","updated_at":"2026-01-03T14:28:11.902294843Z","closed_at":"2026-01-03T14:28:11.902294843Z","close_reason":"Tests already implemented in tests/unit/test_spread_regen_service.py (6 tests, all passing)","dependencies":[{"issue_id":"story-3vc9","depends_on_id":"story-o13s","type":"blocks","created_at":"2026-01-01T17:58:18.792679507Z","created_by":"daemon"}]}
{"id":"story-3xy","title":"Add executable examples directory","description":"Create examples/ directory with 2-3 working examples showing real outputs:\n- examples/simple_story/ - Basic story without illustrations\n- examples/illustrated_story/ - Story with character sheets and page illustrations\nInclude the generated JSON/text outputs and a README explaining each example. Real outputs are better than documentation.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:44.207889-08:00","updated_at":"2025-12-17T09:09:41.483526-08:00","closed_at":"2025-12-17T09:09:41.483526-08:00"}
{"id":"story-3y8","title":"Move src/ to backend/ using git mv","description":"Use git mv to move: src/api/ ‚Üí backend/api/, src/modules/ ‚Üí backend/core/modules/, src/signatures/ ‚Üí backend/core/signatures/, src/programs/ ‚Üí backend/core/programs/, src/types.py ‚Üí backend/core/types.py, src/config/ ‚Üí backend/config/, src/metrics/ ‚Üí backend/metrics/, src/optimization/ ‚Üí backend/optimization/. Copy src/__init__.py content to backend/core/__init__.py (it re-exports types).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:00.590664-08:00","updated_at":"2025-12-18T08:18:07.916098-08:00","closed_at":"2025-12-18T08:18:07.916098-08:00","dependencies":[{"issue_id":"story-3y8","depends_on_id":"story-qba","type":"blocks","created_at":"2025-12-18T07:32:53.615499-08:00","created_by":"kavinstewart"},{"issue_id":"story-3y8","depends_on_id":"story-70s","type":"blocks","created_at":"2025-12-18T07:32:58.776241-08:00","created_by":"kavinstewart"}]}
{"id":"story-41h","title":"Create database schema and connection","description":"Create src/api/database/ with schema.sql, db.py, repository.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:23:44.122487-08:00","updated_at":"2025-12-17T11:26:58.105907-08:00","closed_at":"2025-12-17T11:26:58.105907-08:00","dependencies":[{"issue_id":"story-41h","depends_on_id":"story-9r7","type":"blocks","created_at":"2025-12-17T11:24:23.493777-08:00","created_by":"kavinstewart"}]}
{"id":"story-42u","title":"Create VLMJudge wrapper module","description":"Use Gemini 2.0 Flash for detailed checks: text-free, character consistency, composition","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:21.023852-08:00","updated_at":"2025-12-16T12:06:56.513034-08:00","closed_at":"2025-12-16T12:06:56.513034-08:00","dependencies":[{"issue_id":"story-42u","depends_on_id":"story-j79","type":"blocks","created_at":"2025-12-16T11:48:56.874545-08:00","created_by":"kavinstewart"}]}
{"id":"story-48g","title":"Remove global state from LM configuration","description":"Refactor modules to accept LM explicitly rather than relying on global configure_dspy() state:\n1. Add optional lm parameter to module __init__ methods\n2. Use passed LM or fall back to get_default_lm()\n3. This enables easier testing and avoids order-of-import issues\nExample: def __init__(self, lm: dspy.LM = None): self.lm = lm or get_default_lm()","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:57.327659-08:00","updated_at":"2025-12-17T09:07:09.699839-08:00","closed_at":"2025-12-17T09:07:09.699839-08:00","dependencies":[{"issue_id":"story-48g","depends_on_id":"story-2k0","type":"blocks","created_at":"2025-12-17T08:31:18.76971-08:00","created_by":"kavinstewart"}]}
{"id":"story-4dm8","title":"Unit tests: SpreadEditOverlay component","description":"Test the SpreadEditOverlay React Native component.\n\n## Test File\n`frontend/__tests__/components/SpreadEditOverlay.test.tsx`\n\n## Test Cases\n\n### test_renders_when_visible\n- Pass isVisible={true}\n- Verify overlay container is rendered\n- Verify 'Edit Illustration' header is visible\n\n### test_hidden_when_not_visible\n- Pass isVisible={false}\n- Verify overlay is not rendered (or has display: none)\n\n### test_displays_current_prompt\n- Pass currentPrompt='A fox in the forest'\n- Verify TextInput shows the prompt text\n\n### test_displays_spread_number_in_title\n- Pass spreadNumber={3}\n- Verify 'Edit Illustration' or 'Spread 3' appears\n\n### test_regenerate_button_calls_onRegenerate\n- Render with onRegenerate mock\n- Press 'Regenerate' button\n- Verify onRegenerate called once\n\n### test_close_button_calls_onDismiss\n- Render with onDismiss mock\n- Press X button\n- Verify onDismiss called once\n\n### test_shows_loading_state_when_regenerating\n- Pass isRegenerating={true}\n- Verify ActivityIndicator is visible\n- Verify 'Regenerating...' text is shown\n- Verify buttons are disabled\n\n### test_buttons_disabled_when_regenerating\n- Pass isRegenerating={true}\n- Verify 'Regenerate' button is disabled\n- Verify 'Cancel' button is disabled (or hidden)\n\n### test_shows_error_state\n- Pass error='Failed to regenerate'\n- Verify error message is displayed\n- Verify 'Try Again' button is visible\n\n### test_swipe_down_calls_onDismiss\n- Simulate pan gesture downward \u003e 100px\n- Verify onDismiss called\n- (May need to mock gesture handler)\n\n### test_prompt_text_is_readonly\n- Verify TextInput is not editable\n- (For MVP, prompt editing comes later)\n\n## Test Setup\n- Use @testing-library/react-native\n- Mock react-native-reanimated\n- Mock react-native-gesture-handler","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:57:53.424439255Z","created_by":"kavin","updated_at":"2026-01-03T14:28:11.954080874Z","closed_at":"2026-01-03T14:28:11.954080874Z","close_reason":"Stale - SpreadEditOverlay component was never built. Feature implemented as edit-prompt.tsx fullScreenModal instead","dependencies":[{"issue_id":"story-4dm8","depends_on_id":"story-qypv","type":"blocks","created_at":"2026-01-01T17:58:18.821733346Z","created_by":"daemon"}]}
{"id":"story-4fqg","title":"Offline mode: show only cached stories in library and recommendations","description":"When offline (network fails or unavailable):\n\n**Library screen (index.tsx)**:\n- When useStories() fails due to network, show cached stories instead of error\n- Load cached stories via StoryCacheManager.getCachedStoryIds() + loadCachedStory()\n- StoryCard should receive story objects with file:// URLs for images\n\n**End screen recommendations ([id].tsx)**:\n- Filter useRecommendations() results to only include stories that are cached\n- Use StoryCacheManager.isStoryCached() to check each recommendation\n- Pass cached story data to StoryCard (with file:// URLs)\n\n**Implementation notes**:\n- StoryCacheManager already has getCachedStoryIds() and loadCachedStory()\n- May need useNetInfo hook from @react-native-community/netinfo for detecting offline state\n- Alternatively, can detect offline via API request failures\n- StoryCard currently uses api.getSpreadImageUrl() - needs to use cached file:// URLs when story is from cache","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-05T00:07:08.087165724Z","created_by":"kavin","updated_at":"2026-01-05T00:12:39.827103884Z","closed_at":"2026-01-05T00:12:39.827103884Z","close_reason":"Implemented offline mode: library falls back to cached stories when network fails, recommendations only show cached stories with file:// URLs"}
{"id":"story-4hf7","title":"Add Redis systemd service for boot startup","description":"Create user systemd service to ensure Redis starts on boot, similar to existing expo-frontend and stories-backend services.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:32:48.168964893Z","created_by":"kavin","updated_at":"2025-12-29T22:33:31.772082968Z","closed_at":"2025-12-29T22:33:31.772082968Z","close_reason":"Redis already installed as system service (redis-server.service) and enabled for boot startup"}
{"id":"story-4mf","title":"Create VQAScorer wrapper module","description":"Wrap t2v-metrics VQAScore for fast alignment checking","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:14.426541-08:00","updated_at":"2025-12-16T12:06:51.354919-08:00","closed_at":"2025-12-16T12:06:51.354919-08:00","dependencies":[{"issue_id":"story-4mf","depends_on_id":"story-j79","type":"blocks","created_at":"2025-12-16T11:48:51.726431-08:00","created_by":"kavinstewart"}]}
{"id":"story-4n8","title":"Fix: The End screen overlays last page content","description":"**Problem**: When reading a story, the last page's content is never shown. The 'The End' UI is displayed over the last page's illustration, but the actual story text for that page is replaced by The End screen.\n\n**Location**: frontend/app/read/[id].tsx\n\n**Root cause**: Line 25 sets `isLastSpread = currentSpread \u003e= totalSpreads - 1`. When true (lines 243-369), the normal page UI (with story text) is replaced by The End UI. The reader sees the last illustration but never reads the last page's text.\n\n**Expected behavior**: \n1. User reads page N (last page) with its text and illustration\n2. User taps forward\n3. User sees 'The End' screen with recommendations\n\n**Current behavior**:\n1. User reads page N-1\n2. User taps forward  \n3. User sees 'The End' screen with page N's illustration (but page N's text is skipped)\n\n**Solution**: Treat 'The End' as a virtual spread that comes AFTER all story spreads. Change navigation logic so:\n- totalSpreads stays the same (count of actual story pages)\n- Add a new state like `isEndScreen = currentSpread \u003e= totalSpreads`\n- Allow goForward() to go one past totalSpreads - 1\n- Show normal page content for spreads 0 to totalSpreads-1\n- Show The End screen only when currentSpread === totalSpreads","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-25T10:27:08.738371-08:00","updated_at":"2025-12-25T10:30:58.898836-08:00","closed_at":"2025-12-25T10:30:58.898836-08:00"}
{"id":"story-4qt","title":"Audit QualityJudge for dead code","description":"Review backend/core/modules/quality_judge.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:08.179843-08:00","updated_at":"2025-12-26T15:39:12.78914-08:00","closed_at":"2025-12-26T15:39:12.78914-08:00"}
{"id":"story-4sy","title":"Remove generation mode picker from frontend","description":"Remove the Quick/Standard/Illustrated radio button group from new.tsx. Hardcode generation_type to 'illustrated' in the API call.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:04:03.970227-08:00","updated_at":"2025-12-26T16:09:48.554773-08:00","closed_at":"2025-12-26T16:09:48.554773-08:00"}
{"id":"story-4t9","title":"Remove deprecated page image endpoint and aliases","description":"Dead code in backend API:\n\n1. backend/api/routes/stories.py lines 132-156:\n   - Deprecated /pages/{page_number}/image endpoint (never called)\n   - page_path fallback logic can never succeed (only spread_*.png files exist)\n\n2. backend/api/models/responses.py:\n   - Line 27: StoryPageResponse alias (never imported)\n   - Lines 121-131: page_count and pages computed fields (add ~150 bytes to responses, never consumed by frontend)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T13:25:40.723548-08:00","updated_at":"2025-12-26T13:31:30.631545-08:00","closed_at":"2025-12-26T13:31:30.631545-08:00"}
{"id":"story-4z8","title":"Audit optimization scripts for dead code","description":"Review backend/optimization/ directory looking for redundant and/or dead code. Check for unused optimization scripts, deprecated patterns, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:34.197176-08:00","updated_at":"2025-12-26T15:39:12.794901-08:00","closed_at":"2025-12-26T15:39:12.794901-08:00"}
{"id":"story-5170","title":"Fix illustration_url returned for spreads without images","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-05T00:33:43.822229953Z","created_by":"kavin","updated_at":"2026-01-05T00:37:23.681867298Z","closed_at":"2026-01-05T00:37:23.681867298Z","close_reason":"Fixed: frontend now only downloads images for spreads that have illustration_url. Added test to catch regression."}
{"id":"story-531w","title":"Auto-restart workers on code changes","description":"Add git post-commit hook to restart ARQ workers when backend worker code changes. Prevents stale code issues.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T14:00:37.428759609Z","created_by":"kavin","updated_at":"2026-01-02T14:01:20.954173118Z","closed_at":"2026-01-02T14:01:20.954173118Z","close_reason":"Implemented post-commit hook to auto-restart workers","comments":[{"id":4,"issue_id":"story-531w","author":"kavin","text":"Implemented git post-commit hook at `.git/hooks/post-commit`\n\n**Triggers restart when these paths change:**\n- `backend/worker.py`\n- `backend/api/services/*`\n- `backend/core/modules/*`\n\n**Actions:**\n1. Kills existing workers (including orphans) via pkill\n2. Waits 2 seconds for cleanup\n3. Restarts via systemd if available, otherwise starts directly\n\n**Note:** Hook is in `.git/hooks/` (not tracked by git). If repo is cloned fresh, hook needs to be recreated or stored in a tracked location and symlinked.","created_at":"2026-01-02T14:01:14Z"}]}
{"id":"story-53w","title":"Add 'The End' animation and button delay to story reader","description":"When reaching the last page of a story:\n\n**'The End' Animation:**\n- Fade in over 300ms while scaling 0.85 ‚Üí 1.0\n- Single soft pulse: scale to 1.05 at 500ms, back to 1.0 at 650ms\n- Total animation duration: ~650ms\n- Text: 'The End ‚ú®' in amber color (#F97316), Nunito Bold 28px\n\n**Button Activation Delay:**\n- 1000ms delay before buttons become interactive\n- Buttons start with opacity: 0 and pointerEvents: 'none'\n- After 1000ms, fade in over 200ms\n- Left button: üìñ 'Again' (cream) ‚Üí goes to page 1\n- Right button: üè† 'Done' (amber/orange gradient) ‚Üí goes to library\n\n**Timeline:**\n- 0ms: Reach last page, story text fades out, 'The End' begins animation\n- 300ms: 'The End' fully visible at scale 1.0\n- 500ms: Pulse to 1.05\n- 650ms: Settle to 1.0\n- 1000ms: Buttons begin fade in\n- 1200ms: Buttons fully visible and interactive","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T11:43:52.832177-08:00","updated_at":"2025-12-24T15:53:01.118662-08:00","closed_at":"2025-12-24T15:53:01.118662-08:00"}
{"id":"story-59is","title":"Fix Playwright installation","description":"Need to investigate and fix Playwright installation issues in the frontend","status":"in_progress","priority":2,"issue_type":"bug","created_at":"2025-12-29T19:05:21.921150501Z","created_by":"kavin","updated_at":"2025-12-29T19:05:30.597798031Z","comments":[{"id":1,"issue_id":"story-59is","author":"kavin","text":"Investigation findings:\n1. @playwright/test v1.57.0 is listed in devDependencies in package.json\n2. npx playwright --version shows 1.57.0 (global install)\n3. But node_modules/@playwright/ directory is empty - npm didn't install it properly\n4. Running tests fails with 'Cannot find module @playwright/test'\n\nRoot cause: npm install did not properly install @playwright/test into node_modules","created_at":"2025-12-29T19:06:15Z"}]}
{"id":"story-5bx","title":"Connect frontend to FastAPI backend","description":"Create features/stories/api.ts with TanStack Query hooks: useStories, useStory, useCreateStory, useStoryJob. Configure API base URL for dev/prod","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:59.163243-08:00","updated_at":"2025-12-18T09:11:15.547256-08:00","closed_at":"2025-12-18T09:11:15.547256-08:00","dependencies":[{"issue_id":"story-5bx","depends_on_id":"story-vzv","type":"blocks","created_at":"2025-12-18T08:52:52.790324-08:00","created_by":"kavinstewart"}]}
{"id":"story-5d3","title":"Set up DSPy configuration","description":"Create src/config.py with LM setup using load_dotenv(), dual-model architecture for inference and reflection","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:36.731065-08:00","updated_at":"2025-12-11T09:43:00.025853-08:00","closed_at":"2025-12-11T09:43:00.025853-08:00","dependencies":[{"issue_id":"story-5d3","depends_on_id":"story-ffw","type":"blocks","created_at":"2025-12-11T09:38:49.029857-08:00","created_by":"kavinstewart"}]}
{"id":"story-5m8t","title":"Add pull-to-refresh to Library screen","description":"Add RefreshControl to the Library screen's ScrollView to enable pull-to-refresh functionality. Infrastructure already exists (useStories hook exposes refetch and isLoading), just need to add the RefreshControl component.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-31T19:36:13.796923743Z","created_by":"kavin","updated_at":"2025-12-31T19:37:25.204975897Z","closed_at":"2025-12-31T19:37:25.204975897Z","close_reason":"Implemented pull-to-refresh using RefreshControl with isFetching state and refetch callback"}
{"id":"story-5oav","title":"Update StoryService to enqueue via ARQ","description":"Replace job_manager.submit() calls with ARQ enqueue_job(). Remove old ThreadPoolExecutor-based job_manager.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:30.333736317Z","created_by":"kavin","updated_at":"2025-12-29T22:33:03.990947219Z","closed_at":"2025-12-29T22:33:03.990947219Z","close_reason":"StoryService updated to use ARQ enqueue_job. Created arq_pool.py module to avoid circular imports.","dependencies":[{"issue_id":"story-5oav","depends_on_id":"story-6l27","type":"blocks","created_at":"2025-12-29T22:23:46.555168913Z","created_by":"daemon"}]}
{"id":"story-5p6w","title":"Audit: LLM \u0026 Image Configuration","description":"**Code Path**: backend/config/\n\n**Files to examine**:\n- backend/config/llm.py\n- backend/config/image.py\n- backend/api/config.py\n\n**Investigation goals**:\n1. Look for duplicated retry/fallback logic\n2. Check for duplicated environment variable loading\n3. Identify non-KISS complexity in LLM selection\n4. Look for duplicated timeout/error handling configuration\n5. Check if configuration should be consolidated or simplified\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:40.342809108Z","created_by":"kavin","updated_at":"2026-01-04T01:56:36.703176048Z","closed_at":"2026-01-04T01:56:36.703176048Z","close_reason":"Audit complete. Found 4 issues:\n\n**P2 Issues:**\n1. story-5p6w.1: DRY violation - LLM provider selection logic duplicated 3x in llm.py\n2. story-5p6w.2: SRP violation - Logging infrastructure (60 lines) mixed into api/config.py\n3. story-5p6w.3: Inconsistency - LLM has retry decorator, image API does not\n\n**P3 Issues:**\n4. story-5p6w.4: Cleanup - load_dotenv() called in 5 places (works but messy)\n\nNo blockers for any sub-issues. Ready for implementation."}
{"id":"story-5p6w.1","title":"Refactor: Extract LLM provider selection to reduce duplication","description":"**File**: backend/config/llm.py\n\n**Issue**: DRY violation - the same if-elif-else chain checking GOOGLE_API_KEY/ANTHROPIC_API_KEY/OPENAI_API_KEY is repeated in:\n- get_inference_lm() (lines 43-81)\n- get_reflection_lm() (lines 84-117)\n- get_inference_model_name() (lines 130-139)\n\nModel names are duplicated as magic strings across all three.\n\n**Proposed fix**: Extract provider detection and model configuration to a single place:\n```python\n_PROVIDERS = {\n    'GOOGLE_API_KEY': {'inference': 'gemini/gemini-3-pro-preview', 'reflection': 'gemini/gemini-3-pro-preview'},\n    'ANTHROPIC_API_KEY': {'inference': 'anthropic/claude-opus-4-5-20251101', 'reflection': 'anthropic/claude-sonnet-4-20250514'},\n    'OPENAI_API_KEY': {'inference': 'gpt-5.2', 'reflection': 'gpt-5.2'},\n}\n\ndef _get_provider() -\u003e tuple[str, str]:\n    for key, models in _PROVIDERS.items():\n        if os.getenv(key):\n            return key, os.getenv(key)\n    raise ValueError(...)\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T01:55:53.198130068Z","created_by":"kavin","updated_at":"2026-01-04T03:56:56.886953533Z","closed_at":"2026-01-04T03:56:56.886953533Z","close_reason":"Refactored LLM provider selection:\n- Added ProviderConfig dataclass with all provider-specific settings\n- Added _PROVIDERS list as single source of truth for provider priority and config\n- Added _get_active_provider() and _get_active_provider_or_none() helpers\n- Simplified get_inference_lm() from 28 lines to 8 lines\n- Simplified get_reflection_lm() from 28 lines to 8 lines  \n- Simplified get_inference_model_name() from 9 lines to 6 lines\n\nTotal: ~75 lines of duplicated if-elif chains replaced with ~50 lines of DRY config.\nAll 105 unit tests pass.","dependencies":[{"issue_id":"story-5p6w.1","depends_on_id":"story-5p6w","type":"parent-child","created_at":"2026-01-04T01:55:53.199329461Z","created_by":"daemon"}]}
{"id":"story-5p6w.2","title":"SRP: Extract logging infrastructure from api/config.py","description":"**File**: backend/api/config.py\n\n**Issue**: SRP violation - the file mixes multiple concerns:\n1. Directory paths (API_DIR, BACKEND_DIR, etc.)\n2. Database configuration (DATABASE_URL, get_dsn)\n3. Story generation defaults\n4. JSON logging infrastructure (JSONFormatter class, 25 lines)\n5. StoryLogger class (35 lines)\n\nThe logging infrastructure (~60 lines, 45% of the file) is a separate concern from API configuration.\n\n**Proposed fix**: Extract to `backend/api/logging.py`:\n- JSONFormatter class\n- configure_logging() function\n- StoryLogger class\n- story_logger singleton\n\nKeep in api/config.py:\n- Directory paths\n- Database config\n- Story generation defaults","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T01:56:00.530751954Z","created_by":"kavin","updated_at":"2026-01-04T14:14:08.472519416Z","closed_at":"2026-01-04T14:14:08.472519416Z","close_reason":"Extracted logging infrastructure to backend/api/logging.py:\n- JSONFormatter class\n- configure_logging() function  \n- StoryLogger class\n- story_logger singleton\n\nUpdated imports in spread_regeneration.py and story_generation.py.\napi/config.py reduced from 137 lines to 37 lines (73% reduction).\n\nAll 105 unit tests pass.","dependencies":[{"issue_id":"story-5p6w.2","depends_on_id":"story-5p6w","type":"parent-child","created_at":"2026-01-04T01:56:00.537058874Z","created_by":"daemon"}]}
{"id":"story-5p6w.3","title":"Consistency: Add retry decorator for image API calls","description":"**File**: backend/config/image.py\n\n**Issue**: Inconsistent error handling between LLM and image APIs:\n- LLM calls have `llm_retry` decorator with tenacity for network errors (ConnectionError, TimeoutError, etc.)\n- Image generation via `get_image_client()` has no equivalent retry for network errors\n- The `max_attempts` in spread_illustrator.py is for QA-based regeneration, NOT network retries\n\n**Impact**: Transient network errors during image generation will fail the entire story instead of retrying.\n\n**Proposed fix**: Add `image_retry` decorator in image.py:\n```python\nfrom tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type\n\nRETRYABLE_EXCEPTIONS = (ConnectionError, TimeoutError, BrokenPipeError, OSError)\n\nimage_retry = retry(\n    stop=stop_after_attempt(3),\n    wait=wait_exponential(multiplier=2, min=2, max=10),\n    retry=retry_if_exception_type(RETRYABLE_EXCEPTIONS),\n    reraise=True,\n)\n```\n\n**Alternative**: If this is intentional (e.g., image API is more reliable), document why retry is not needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T01:56:12.434404003Z","created_by":"kavin","updated_at":"2026-01-04T13:40:29.001043632Z","closed_at":"2026-01-04T13:40:29.001043632Z","close_reason":"Implemented image_retry decorator in backend/config/image.py mirroring the existing llm_retry pattern. Applied to:\n- spread_illustrator.py:_generate_image()\n- character_sheet_generator.py:_generate_image() (extracted)\n- vlm_judge.py:_call_vlm() (extracted)\n\nAll 105 unit tests pass.","dependencies":[{"issue_id":"story-5p6w.3","depends_on_id":"story-5p6w","type":"parent-child","created_at":"2026-01-04T01:56:12.440363781Z","created_by":"daemon"}]}
{"id":"story-5p6w.4","title":"Cleanup: Consolidate or document scattered load_dotenv() calls","description":"**Files affected**:\n- backend/config/llm.py (line 26)\n- backend/config/image.py (line 13)\n- backend/api/main.py (line 9)\n- backend/api/dependencies.py (line 11)\n- backend/worker.py (line 17)\n\n**Issue**: `load_dotenv()` is called in 5 different places. While idempotent, this is:\n- Unclear for new contributors (which is the 'real' one?)\n- Slightly wasteful (file system access on each import)\n\n**Context**: The current pattern exists because:\n- Entry points (main.py, worker.py) load env before importing config\n- Config modules (llm.py, image.py) also load as a safety measure\n\n**Options**:\n1. **Keep as-is** but add a comment explaining the pattern\n2. **Consolidate** to a single `backend/env.py` imported first by all entry points\n3. **Remove from config modules** and rely on entry points to load first\n\n**Recommendation**: Option 1 (document) or Option 3 (trust entry points) - low priority.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T01:56:28.269649363Z","created_by":"kavin","updated_at":"2026-01-05T03:48:35.250081268Z","closed_at":"2026-01-05T03:48:35.250081268Z","close_reason":"Added clarifying comments explaining the idempotent load_dotenv pattern","dependencies":[{"issue_id":"story-5p6w.4","depends_on_id":"story-5p6w","type":"parent-child","created_at":"2026-01-04T01:56:28.275452747Z","created_by":"daemon"}]}
{"id":"story-5vv","title":"Add asyncpg and SQLAlchemy async dependencies","description":"Add asyncpg driver and SQLAlchemy async support to pyproject.toml via poetry","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:42:48.876227827Z","created_by":"kavin","updated_at":"2025-12-29T14:55:23.387884737Z","closed_at":"2025-12-29T14:55:23.387884737Z","close_reason":"Added asyncpg 0.31.0 and sqlalchemy 2.0.45 with asyncio extras"}
{"id":"story-617","title":"Update API models and database for spreads","description":"Update StoryResponse, StoryPageResponse ‚Üí StorySpreadResponse. Update database schema (story_pages ‚Üí story_spreads). Add migration for llm_model column if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:38:37.316272-08:00","updated_at":"2025-12-18T14:58:39.750309-08:00","closed_at":"2025-12-18T14:58:39.750309-08:00","dependencies":[{"issue_id":"story-617","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:41:08.901158-08:00","created_by":"kavinstewart"},{"issue_id":"story-617","depends_on_id":"story-9ii","type":"blocks","created_at":"2025-12-18T14:42:42.690169-08:00","created_by":"kavinstewart"},{"issue_id":"story-617","depends_on_id":"story-hdt","type":"blocks","created_at":"2025-12-18T14:42:47.852818-08:00","created_by":"kavinstewart"}]}
{"id":"story-68t","title":"Add illustration_prompt to page writer","description":"Extend PageWriterSignature to output illustration_prompt field describing scene visually: character poses, expressions, environment, composition","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T10:35:13.666814-08:00","updated_at":"2025-12-13T10:40:55.290197-08:00","closed_at":"2025-12-13T10:40:55.290197-08:00","dependencies":[{"issue_id":"story-68t","depends_on_id":"story-3i2","type":"blocks","created_at":"2025-12-13T10:35:47.101589-08:00","created_by":"kavinstewart"}]}
{"id":"story-69g","title":"Create main ImageQA module","description":"Hybrid QA with fast pass (VQAScore) + detailed pass (VLM) + regeneration logic","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:27.49157-08:00","updated_at":"2025-12-16T12:07:59.667996-08:00","closed_at":"2025-12-16T12:07:59.667996-08:00","dependencies":[{"issue_id":"story-69g","depends_on_id":"story-4mf","type":"blocks","created_at":"2025-12-16T11:49:02.027641-08:00","created_by":"kavinstewart"},{"issue_id":"story-69g","depends_on_id":"story-42u","type":"blocks","created_at":"2025-12-16T11:49:07.185185-08:00","created_by":"kavinstewart"}]}
{"id":"story-6ath","title":"Audit: Quality Metrics","description":"**Code Path**: backend/metrics/\n\n**Files to examine**:\n- backend/metrics/story_quality.py\n- Any other metrics files\n\n**Investigation goals**:\n1. Look for duplicated scoring/feedback logic\n2. Check for duplicated metric calculation patterns\n3. Identify non-KISS complexity in metric functions\n4. Look for metrics that could be consolidated\n5. Check for SRP violations (metrics doing too much)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:49.036674192Z","created_by":"kavin","updated_at":"2026-01-04T15:21:19.821466644Z","closed_at":"2026-01-04T15:21:19.821466644Z","close_reason":"Audit complete. Both metrics are dead code - outline_quality_metric references removed outline system, story_quality_metric has no imports. Created sub-bead for cleanup."}
{"id":"story-6ath.1","title":"Remove dead backend/metrics/ directory","description":"**Files to delete**:\n- backend/metrics/story_quality.py\n- backend/metrics/outline_quality.py\n- backend/metrics/__init__.py\n- backend/metrics/ directory\n\n**Reason**: Both metrics are dead code:\n- outline_quality_metric: Outline system was removed\n- story_quality_metric: Never imported/used anywhere\n\n**Note**: If GEPA optimization is planned for the future, these could be kept as templates. But currently they're unused.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T15:21:28.430441531Z","created_by":"kavin","updated_at":"2026-01-04T15:22:02.68577175Z","closed_at":"2026-01-04T15:22:02.68577175Z","close_reason":"Removed backend/metrics/ directory (3 files deleted)","dependencies":[{"issue_id":"story-6ath.1","depends_on_id":"story-6ath","type":"parent-child","created_at":"2026-01-04T15:21:28.436432153Z","created_by":"daemon"}]}
{"id":"story-6d5y","title":"Fix Expo web dev server 500 error","description":"## Problem\nExpo web dev server returns 500 error on the JavaScript bundle, causing blank page.\n\n## Error\n```\nFailed to load resource: the server responded with a status of 500 (Internal Server Error)\nRefused to execute script from '.../entry.bundle?platform=web...' because its MIME type ('application/json') is not executable\n```\n\n## Impact\n- Playwright tests fail (app never renders)\n- Web version of app unusable\n\n## Next Steps\n- Check Expo/Metro bundler logs for the actual error\n- May be a dependency issue, TypeScript error, or bundler config problem","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T20:15:17.173070635Z","created_by":"kavin","updated_at":"2025-12-29T20:18:38.402454453Z","closed_at":"2025-12-29T20:18:38.402454453Z","close_reason":"Fixed: Metro cache was stale. Cleared with 'rm -rf node_modules/.cache .expo' and restarted with '--clear'. App now renders correctly. Tests fail because they need auth handling (separate issue)."}
{"id":"story-6f5","title":"Simplify CreateStoryRequest to only accept goal","description":"Remove target_age_range, generation_type, quality_threshold, and max_attempts from the API request model. The API should only accept 'goal' as input.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:04:16.627157-08:00","updated_at":"2025-12-26T16:09:48.553461-08:00","closed_at":"2025-12-26T16:09:48.553461-08:00"}
{"id":"story-6jr","title":"Audit StoryGenerator program for dead code","description":"Review backend/core/programs/story_generator.py main program looking for redundant and/or dead code. Check for unused methods, deprecated code paths, unreachable branches, and redundant logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:14.438502-08:00","updated_at":"2025-12-26T15:39:12.789554-08:00","closed_at":"2025-12-26T15:39:12.789554-08:00"}
{"id":"story-6k1","title":"Audit frontend API layer for dead code","description":"Review frontend/lib/api.ts looking for redundant and/or dead code. Check for unused API functions, deprecated endpoints, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:24.514099-08:00","updated_at":"2025-12-26T15:39:12.797256-08:00","closed_at":"2025-12-26T15:39:12.797256-08:00"}
{"id":"story-6l27","title":"Create ARQ worker module","description":"Create backend/worker.py with ARQ task definitions and WorkerSettings. Task should wrap the standalone generation function.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:29.060264716Z","created_by":"kavin","updated_at":"2025-12-29T22:27:12.641817786Z","closed_at":"2025-12-29T22:27:12.641817786Z","close_reason":"Created backend/worker.py with ARQ task and cli/run_worker.py script","dependencies":[{"issue_id":"story-6l27","depends_on_id":"story-eenf","type":"blocks","created_at":"2025-12-29T22:23:46.538104386Z","created_by":"daemon"}]}
{"id":"story-6v8","title":"Update API client with auth header","description":"Modify frontend/lib/api.ts fetchApi() to include Authorization: Bearer \u003ctoken\u003e header from auth storage.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:17.887695443Z","created_by":"kavin","updated_at":"2025-12-29T01:35:27.485530375Z","closed_at":"2025-12-29T01:35:27.485530375Z","close_reason":"Updated fetchApi to include Authorization header","dependencies":[{"issue_id":"story-6v8","depends_on_id":"story-kz6","type":"blocks","created_at":"2025-12-29T01:30:34.304854709Z","created_by":"daemon"}]}
{"id":"story-70s","title":"Convert story_service.py relative imports to absolute","description":"In src/api/services/story_service.py, convert the relative imports (from ...programs.story_generator, from ...config) to absolute imports. This prevents breakage when directory depth changes. Must be done BEFORE moving src/ to backend/.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:30:39.729679-08:00","updated_at":"2025-12-18T07:47:27.328747-08:00","closed_at":"2025-12-18T07:47:27.328747-08:00"}
{"id":"story-71r","title":"Audit frontend hooks for dead code","description":"Review frontend/features/stories/hooks/ directory looking for redundant and/or dead code. Check for unused hooks, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:41.243052-08:00","updated_at":"2025-12-26T15:39:12.797548-08:00","closed_at":"2025-12-26T15:39:12.797548-08:00"}
{"id":"story-79x","title":"Implement ErrorScreen","description":"Port error-screen.jsx to app/+not-found.tsx and components/ErrorScreen.tsx. Contextual error messages, retry/go-home buttons, sad sparkles animation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:43.566942-08:00","updated_at":"2025-12-18T09:15:22.680461-08:00","closed_at":"2025-12-18T09:15:22.680461-08:00","dependencies":[{"issue_id":"story-79x","depends_on_id":"story-gpk","type":"blocks","created_at":"2025-12-18T08:53:47.179854-08:00","created_by":"kavinstewart"}]}
{"id":"story-7bk","title":"Add Makefile for common commands","description":"Create a Makefile (or justfile) documenting common commands:\n- make run - Generate a story with default goal\n- make debug - Run debug script\n- make optimize - Run GEPA optimization\n- make test - Run tests (when added)\nThis serves as executable documentation and clarifies entry points.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:50.747604-08:00","updated_at":"2025-12-17T08:45:45.504003-08:00","closed_at":"2025-12-17T08:45:45.504003-08:00"}
{"id":"story-7ju","title":"Audit CharacterSheetGenerator for dead code","description":"Review backend/core/modules/character_sheet_generator.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:20.721167-08:00","updated_at":"2025-12-26T15:39:12.789924-08:00","closed_at":"2025-12-26T15:39:12.789924-08:00"}
{"id":"story-7li","title":"Add structured logging for story generation","description":"Add JSON-formatted logging for key events: story start, pipeline stages, errors (with retry attempt count), completion (with duration). Use Python logging with JSON formatter.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:08:47.369785-08:00","updated_at":"2025-12-19T15:26:24.293576-08:00","closed_at":"2025-12-19T15:26:24.293576-08:00"}
{"id":"story-7vs","title":"Remove redundant is_illustrated flag","description":"GeneratedStory.is_illustrated and generation_type convey the same info. If generation_type == 'illustrated', is_illustrated is always True. Consider deriving one from the other or removing the redundant field. Affected: src/types.py:308, src/api/models/responses.py:90, src/api/database/schema.sql:12, src/api/services/story_service.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:54:29.275147-08:00","updated_at":"2025-12-17T11:59:00.841413-08:00","closed_at":"2025-12-17T11:59:00.841413-08:00"}
{"id":"story-800","title":"Audit frontend Reader screen for dead code","description":"Review frontend/app/read/[id].tsx looking for redundant and/or dead code. Check for unused imports, deprecated patterns, and unused functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:18.162651-08:00","updated_at":"2025-12-26T15:39:12.796931-08:00","closed_at":"2025-12-26T15:39:12.796931-08:00"}
{"id":"story-80e","title":"Configure fonts + haptics","description":"Install expo-font, expo-haptics. Bundle Nunito and Baloo 2 fonts. Create useHaptics hook for button/page feedback","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:50:50.858604-08:00","updated_at":"2025-12-18T09:09:19.391707-08:00","closed_at":"2025-12-18T09:09:19.391707-08:00","dependencies":[{"issue_id":"story-80e","depends_on_id":"story-b69","type":"blocks","created_at":"2025-12-18T08:52:29.624121-08:00","created_by":"kavinstewart"}]}
{"id":"story-849","title":"Centralize dataclasses into types.py","description":"Create src/types.py containing all domain dataclasses currently scattered across modules: StoryOutline, CharacterBible, StoryPage, QualityJudgment, GeneratedStory, ImageQAResult, RegenerationRequest, StyleDefinition, CharacterReferenceSheet, StoryReferenceSheets. Update all imports. This makes data flow obvious at a glance.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T08:30:31.275337-08:00","updated_at":"2025-12-17T08:45:45.502475-08:00","closed_at":"2025-12-17T08:45:45.502475-08:00"}
{"id":"story-8m6b","title":"Fix Playwright system dependencies","description":"## Problem\nPlaywright tests fail to run because Chromium is missing system libraries.\n\n## Error\n```\nlibcairo.so.2: cannot open shared object file: No such file or directory\n```\n\n## Root Cause\nThe Playwright browsers are downloaded but require system libraries that aren't installed. Chromium (chromium-1200) exists in ~/.cache/ms-playwright/ but can't load without libcairo and other deps.\n\n## Solution\nRun the following command to install all required system dependencies:\n```bash\nsudo npx playwright install-deps\n```\n\nThis will run:\n```bash\nsudo apt-get update \u0026\u0026 apt-get install -y --no-install-recommends \\\n  libcairo2 libpango-1.0-0 libgdk-pixbuf-2.0-0 libgtk-3-0t64 \\\n  libasound2t64 libatk-bridge2.0-0t64 libnss3 libxcomposite1 \\\n  libxdamage1 libxrandr2 libgbm1 ... (many more)\n```\n\n## Verification\nAfter installing deps, run:\n```bash\ncd frontend \u0026\u0026 npx playwright test\n```\n\n## Notes\n- Tests themselves are written correctly (6 tests in e2e/story-library.spec.ts)\n- @playwright/test package was initially missing from node_modules but has been installed\n- This is a system-level issue requiring sudo access","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T19:54:15.470359712Z","created_by":"kavin","updated_at":"2025-12-29T20:14:40.62958758Z","closed_at":"2025-12-29T20:14:40.62958758Z","close_reason":"Fixed: installed system deps via apt-get. Playwright now works. Remaining test failures are due to Expo dev server 500 error (separate issue)."}
{"id":"story-8na","title":"Audit test files for dead code","description":"Review tests/unit/ and tests/integration/ directories looking for redundant and/or dead test code. Check for tests that no longer run, deprecated test utilities, and tests for removed features.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:53.967567-08:00","updated_at":"2025-12-26T15:39:12.798109-08:00","closed_at":"2025-12-26T15:39:12.798109-08:00"}
{"id":"story-8ry","title":"Set up NativeWind v4 + Tailwind","description":"Install nativewind@4.1.x, tailwindcss@3.4.x, configure babel/metro, port tailwind.config.js from prototypes (keyframes, animations)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:50:31.453406-08:00","updated_at":"2025-12-18T09:09:19.389034-08:00","closed_at":"2025-12-18T09:09:19.389034-08:00","dependencies":[{"issue_id":"story-8ry","depends_on_id":"story-b69","type":"blocks","created_at":"2025-12-18T08:52:14.126626-08:00","created_by":"kavinstewart"}]}
{"id":"story-8st","title":"Enhance creation loading screen","description":"Add 9 whimsical stages, rotating character emoji, bobbing animation, floating decorations, magic particles, user prompt echo, theme badge, stage history icons, gradient progress bar, Read Your Story button","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T11:17:38.607192-08:00","updated_at":"2025-12-19T11:26:22.47414-08:00","closed_at":"2025-12-19T11:26:22.47414-08:00","dependencies":[{"issue_id":"story-8st","depends_on_id":"story-kbb","type":"blocks","created_at":"2025-12-19T11:18:00.698235-08:00","created_by":"kavinstewart"}]}
{"id":"story-8zgc","title":"Investigate voice assistant for story creation","description":"Research and evaluate implementation options for a simple voice assistant that allows users to create stories through voice interaction.\n\n**Blocked on**: User (Kavin) to research the right platform/framework for voice recognition and processing.\n\n**Areas to investigate**:\n- Voice recognition APIs (e.g., Web Speech API, Whisper, cloud services)\n- Voice-to-text accuracy for children's story prompts\n- Integration patterns with existing story generation pipeline\n- Platform support (web, mobile, desktop)","status":"blocked","priority":2,"issue_type":"feature","created_at":"2026-01-04T00:29:40.403727021Z","created_by":"kavin","updated_at":"2026-01-04T00:29:44.30532962Z"}
{"id":"story-90b","title":"Remove unused getPageImageUrl and StoryPage from frontend","description":"Dead code in frontend/lib/api.ts:\n- Line 39: StoryPage type alias (never imported/used)\n- Lines 89-90: page_count and pages fields in Story interface (never accessed)\n- Lines 203-205: getPageImageUrl function (never called)\n\nAlso remove fallback logic in frontend/app/read/[id].tsx line 23:\n- story?.spreads || story?.pages - the pages fallback never triggers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T13:25:28.038707-08:00","updated_at":"2025-12-26T13:31:30.629707-08:00","closed_at":"2025-12-26T13:31:30.629707-08:00"}
{"id":"story-96n9","title":"Investigate frontend console errors on load","description":"## Context\nParent issue: story-j2fn (E2E tests fail: blank page)\n\n## Task\nUse Playwright's console capture or browser DevTools to identify JavaScript errors during app initialization.\n\n## Approach\n1. Add console error capture to Playwright tests:\n   ```typescript\n   page.on('console', msg =\u003e console.log('CONSOLE:', msg.type(), msg.text()));\n   page.on('pageerror', err =\u003e console.log('PAGE ERROR:', err.message));\n   ```\n\n2. Or manually inspect:\n   ```bash\n   cd frontend \u0026\u0026 npm run dev\n   # Open http://localhost:3000 in browser\n   # Check DevTools Console tab for errors\n   ```\n\n3. Check for:\n   - Missing environment variables (API_URL, etc.)\n   - Failed network requests to backend\n   - React/Expo initialization errors\n   - Import/module resolution failures\n\n## Key Files\n- `frontend/lib/api.ts` - API client configuration\n- `frontend/app/_layout.tsx` - Root layout (first to render)\n- `frontend/app/index.tsx` - Home screen\n\n## Deliverable\nDocument the specific error(s) causing the blank page, then create fix bead if needed.","status":"closed","priority":0,"issue_type":"task","created_at":"2026-01-03T21:47:13.764894348Z","created_by":"kavin","updated_at":"2026-01-03T22:04:21.748902826Z","closed_at":"2026-01-03T22:04:21.748902826Z","close_reason":"Root cause: missing react-refresh dependency. Metro bundler failed with 'Cannot find module react-refresh/babel'. Fixed by running npm install react-refresh --save-dev"}
{"id":"story-9b2","title":"Migrate ProgressTracker to async","description":"Convert ProgressTracker to use async database operations for progress updates","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:13.658218245Z","created_by":"kavin","updated_at":"2025-12-29T15:00:38.836620403Z","closed_at":"2025-12-29T15:00:38.836620403Z","close_reason":"Migrated ProgressTracker to async PostgreSQL writes","dependencies":[{"issue_id":"story-9b2","depends_on_id":"story-ng3","type":"blocks","created_at":"2025-12-29T14:44:14.353499902Z","created_by":"daemon"},{"issue_id":"story-9b2","depends_on_id":"story-a47","type":"blocks","created_at":"2025-12-29T14:44:14.367438116Z","created_by":"daemon"}]}
{"id":"story-9b3","title":"Create JWT token utilities","description":"Create backend/api/auth/tokens.py with generate_token() and verify_token() functions. Use JWT_SECRET from env, 30-day expiration.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:09.64579156Z","created_by":"kavin","updated_at":"2025-12-29T01:33:55.34963104Z","closed_at":"2025-12-29T01:33:55.34963104Z","close_reason":"Created backend/api/auth/tokens.py with create_access_token and verify_token","dependencies":[{"issue_id":"story-9b3","depends_on_id":"story-tnj","type":"blocks","created_at":"2025-12-29T01:30:31.914333433Z","created_by":"daemon"}]}
{"id":"story-9cm","title":"Audit metrics layer for dead code","description":"Review backend/metrics/ directory (story_quality.py, outline_quality.py, etc.) looking for redundant and/or dead code. Check for unused metrics, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:27.922274-08:00","updated_at":"2025-12-26T15:39:12.794614-08:00","closed_at":"2025-12-26T15:39:12.794614-08:00"}
{"id":"story-9ii","title":"Simplify SpreadGenerator module","description":"Replace page-by-page generation loop with single LLM call using FullStorySignature. Parse output into 12 StorySpread objects. Remove per-page critique loop (rely on story-level quality check).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:38:01.852928-08:00","updated_at":"2025-12-18T14:49:53.277692-08:00","closed_at":"2025-12-18T14:49:53.277692-08:00","dependencies":[{"issue_id":"story-9ii","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:40:53.444976-08:00","created_by":"kavinstewart"},{"issue_id":"story-9ii","depends_on_id":"story-lxd","type":"blocks","created_at":"2025-12-18T14:42:27.203173-08:00","created_by":"kavinstewart"},{"issue_id":"story-9ii","depends_on_id":"story-fjf","type":"blocks","created_at":"2025-12-18T14:42:32.356419-08:00","created_by":"kavinstewart"}]}
{"id":"story-9kf","title":"Audit image config for dead code","description":"Review backend/config/image.py looking for redundant and/or dead code. Check for unused functions, deprecated configurations, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:52.128793-08:00","updated_at":"2025-12-26T15:39:12.793704-08:00","closed_at":"2025-12-26T15:39:12.793704-08:00"}
{"id":"story-9n7","title":"Audit ProgressTracker for dead code","description":"Review backend/api/services/progress_tracker.py looking for redundant and/or dead code. Check for unused methods, deprecated patterns, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:26.832323-08:00","updated_at":"2025-12-26T15:39:12.79251-08:00","closed_at":"2025-12-26T15:39:12.79251-08:00"}
{"id":"story-9nkz","title":"Remove stale SQLite file","description":"Remove empty data/stories.db file - leftover from SQLite migration to PostgreSQL","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-02T03:29:34.085399805Z","created_by":"kavin","updated_at":"2026-01-03T16:25:05.40572Z","closed_at":"2026-01-03T16:25:05.40572Z","close_reason":"Removed empty data/stories.db file"}
{"id":"story-9on","title":"Update story_generator to use new illustration modules","description":"Update generate_illustrated() method in story_generator.py to work with the rewritten Nano Banana Pro modules.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:13:11.757318-08:00","updated_at":"2025-12-16T11:21:28.215014-08:00","closed_at":"2025-12-16T11:21:28.215014-08:00","dependencies":[{"issue_id":"story-9on","depends_on_id":"story-bbl","type":"blocks","created_at":"2025-12-16T11:13:42.848033-08:00","created_by":"kavinstewart"},{"issue_id":"story-9on","depends_on_id":"story-z6r","type":"blocks","created_at":"2025-12-16T11:13:48.011355-08:00","created_by":"kavinstewart"}]}
{"id":"story-9r7","title":"Add FastAPI dependencies","description":"Add fastapi, uvicorn, aiosqlite to pyproject.toml","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:23:37.535076-08:00","updated_at":"2025-12-17T11:25:19.156752-08:00","closed_at":"2025-12-17T11:25:19.156752-08:00"}
{"id":"story-9s6","title":"Create FastAPI routes and app","description":"Create src/api/routes/stories.py and src/api/main.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:24:04.254561-08:00","updated_at":"2025-12-17T11:28:42.318028-08:00","closed_at":"2025-12-17T11:28:42.318028-08:00","dependencies":[{"issue_id":"story-9s6","depends_on_id":"story-2gc","type":"blocks","created_at":"2025-12-17T11:24:44.139355-08:00","created_by":"kavinstewart"}]}
{"id":"story-a47","title":"Convert SQLAlchemy models to async-compatible","description":"Update database models to work with async SQLAlchemy sessions and PostgreSQL types","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:06.497333229Z","created_by":"kavin","updated_at":"2025-12-29T14:57:36.449719757Z","closed_at":"2025-12-29T14:57:36.449719757Z","close_reason":"Created SQLAlchemy ORM models for all tables","dependencies":[{"issue_id":"story-a47","depends_on_id":"story-5vv","type":"blocks","created_at":"2025-12-29T14:44:09.998704299Z","created_by":"daemon"}]}
{"id":"story-a56","title":"Clean up and verify restructure","description":"Delete all __pycache__ directories. Run 'poetry install' to refresh. Run 'poetry run pytest tests/' to verify all tests pass. Run 'make api' to verify API starts. Run 'make run GOAL=test' to verify CLI works. Fix any issues found.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:32:35.483131-08:00","updated_at":"2025-12-18T08:28:21.197136-08:00","closed_at":"2025-12-18T08:28:21.197136-08:00","dependencies":[{"issue_id":"story-a56","depends_on_id":"story-vof","type":"blocks","created_at":"2025-12-18T07:34:42.309826-08:00","created_by":"kavinstewart"},{"issue_id":"story-a56","depends_on_id":"story-enl","type":"blocks","created_at":"2025-12-18T07:34:47.483542-08:00","created_by":"kavinstewart"},{"issue_id":"story-a56","depends_on_id":"story-aov","type":"blocks","created_at":"2025-12-18T07:34:52.675957-08:00","created_by":"kavinstewart"},{"issue_id":"story-a56","depends_on_id":"story-d2r","type":"blocks","created_at":"2025-12-18T07:34:57.837241-08:00","created_by":"kavinstewart"},{"issue_id":"story-a56","depends_on_id":"story-s1y","type":"blocks","created_at":"2025-12-18T07:35:02.996551-08:00","created_by":"kavinstewart"}]}
{"id":"story-a6w4","title":"Config: Extract default illustration style to constants","description":"**Problem**: Fallback illustration style is hardcoded inline in spread_regeneration.py:96-103:\n```python\nStyleDefinition(\n    name=\"children's book illustration\",\n    description=\"Warm, inviting children's book illustration style\",\n    prompt_prefix=\"Warm, inviting children's book illustration...\",\n    ...\n)\n```\n\n**Fix**: Move to a constants file or config. This style definition is a domain constant that should live with other style definitions.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:39:49.309184074Z","created_by":"kavin","updated_at":"2026-01-03T22:49:19.760572887Z","closed_at":"2026-01-03T22:49:19.760572887Z","close_reason":"Fixed in commit 82b19a7"}
{"id":"story-ac3","title":"Audit story config for dead code","description":"Review backend/config/story.py looking for redundant and/or dead code. Check for unused constants, deprecated configurations, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:58.415767-08:00","updated_at":"2025-12-26T15:39:12.794003-08:00","closed_at":"2025-12-26T15:39:12.794003-08:00"}
{"id":"story-aea","title":"Enhance new story input screen","description":"Add floating decorations, gradient theme pills, wiggle animation on create button, inspiration tip box, gradient title text","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T11:17:44.860708-08:00","updated_at":"2025-12-19T11:28:17.429427-08:00","closed_at":"2025-12-19T11:28:17.429427-08:00","dependencies":[{"issue_id":"story-aea","depends_on_id":"story-kbb","type":"blocks","created_at":"2025-12-19T11:18:05.824306-08:00","created_by":"kavinstewart"}]}
{"id":"story-aeax","title":"Add ARQ dependency","description":"Add arq package via poetry. Verify Redis connection works.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:25.176508245Z","created_by":"kavin","updated_at":"2025-12-29T22:24:39.056501787Z","closed_at":"2025-12-29T22:24:39.056501787Z","close_reason":"ARQ 0.26.3 installed via poetry, Redis connection verified working"}
{"id":"story-ahc8","title":"Update JobManager for async operations","description":"Modify JobManager to work with async story service and background task handling","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:21.342125017Z","created_by":"kavin","updated_at":"2025-12-29T15:05:43.966044227Z","closed_at":"2025-12-29T15:05:43.966044227Z","close_reason":"JobManager unchanged - already works with sync wrappers that create async loops","dependencies":[{"issue_id":"story-ahc8","depends_on_id":"story-x7f0","type":"blocks","created_at":"2025-12-29T14:44:18.603325626Z","created_by":"daemon"}]}
{"id":"story-akf","title":"Remove VQAScorer and related code","description":"VQAScorer is not being used. Remove:\n- src/modules/vqa_scorer.py\n- VQAScorer/FastPassResult exports from modules/__init__.py\n- VQAScorer imports and fallback code from image_qa.py\n- Any t2v_metrics dependency references","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:29.709745-08:00","updated_at":"2025-12-17T09:27:54.33325-08:00","closed_at":"2025-12-17T09:27:54.33325-08:00"}
{"id":"story-aov","title":"Update pyproject.toml with pytest pythonpath config","description":"Add [tool.pytest.ini_options] section with pythonpath = ['.'] to ensure consistent import behavior across environments.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:32:15.351636-08:00","updated_at":"2025-12-18T08:22:46.695571-08:00","closed_at":"2025-12-18T08:22:46.695571-08:00","dependencies":[{"issue_id":"story-aov","depends_on_id":"story-wn3","type":"blocks","created_at":"2025-12-18T07:34:03.097905-08:00","created_by":"kavinstewart"},{"issue_id":"story-aov","depends_on_id":"story-ve1","type":"blocks","created_at":"2025-12-18T07:34:08.288313-08:00","created_by":"kavinstewart"}]}
{"id":"story-axjw","title":"Backend: Create /logs/ingest endpoint","description":"Create a simple POST /logs/ingest endpoint that receives frontend log entries and writes them to the normal backend logs with a [FRONTEND] marker. This allows Claude Code to access frontend logs by reading the backend's stdout/log files. Request body: { entries: [{ level, message, timestamp, context? }] }. No database storage needed - just print to stdout via Python logging.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T23:07:05.515356548Z","created_by":"kavin","updated_at":"2026-01-04T23:08:57.403097011Z","closed_at":"2026-01-04T23:08:57.403097011Z","close_reason":"Implemented POST /logs/ingest endpoint that writes frontend logs to backend stdout with [FRONTEND] marker"}
{"id":"story-b5u","title":"Create Expo SDK 53 frontend","description":"iPad-first children's story app with landscape orientation. Stack: Expo SDK 53, Expo Router v5, NativeWind v4, TanStack Query v5, Zustand, Reanimated v3 + Moti","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-18T08:50:06.413475-08:00","updated_at":"2025-12-18T09:15:34.821649-08:00","closed_at":"2025-12-18T09:15:34.821649-08:00","dependencies":[{"issue_id":"story-b5u","depends_on_id":"story-csf","type":"blocks","created_at":"2025-12-18T08:53:53.628719-08:00","created_by":"kavinstewart"},{"issue_id":"story-b5u","depends_on_id":"story-uch","type":"blocks","created_at":"2025-12-18T08:53:58.786607-08:00","created_by":"kavinstewart"},{"issue_id":"story-b5u","depends_on_id":"story-nwa","type":"blocks","created_at":"2025-12-18T08:54:03.952605-08:00","created_by":"kavinstewart"},{"issue_id":"story-b5u","depends_on_id":"story-ctg","type":"blocks","created_at":"2025-12-18T08:54:09.110666-08:00","created_by":"kavinstewart"},{"issue_id":"story-b5u","depends_on_id":"story-79x","type":"blocks","created_at":"2025-12-18T08:54:14.273737-08:00","created_by":"kavinstewart"}]}
{"id":"story-b69","title":"Initialize Expo SDK 53 project","description":"Run npx create-expo-app, configure app.json for iPad landscape (requireFullScreen: true, supportsTablet: true), set up TypeScript","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:50:24.922954-08:00","updated_at":"2025-12-18T09:05:29.170793-08:00","closed_at":"2025-12-18T09:05:29.170793-08:00"}
{"id":"story-b75","title":"Build VLM eval annotation UI","description":"Jinja2 templates for annotation interface: list view with filters, detail view showing image + refs side-by-side. Annotation form collects BINARY verdict (pass/fail) plus optional notes explaining why. Sub-scores shown for context but human only rates pass/fail.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T06:11:58.135504-08:00","updated_at":"2025-12-27T10:15:10.361905-08:00","dependencies":[{"issue_id":"story-b75","depends_on_id":"story-0fo","type":"blocks","created_at":"2025-12-27T06:12:13.038507-08:00","created_by":"kavinstewart"},{"issue_id":"story-b75","depends_on_id":"story-j0y6","type":"blocks","created_at":"2026-01-03T22:35:53.573026266Z","created_by":"daemon"}]}
{"id":"story-b7t","title":"Create VLMJudge GEPA metric and optimizer","description":"Create backend/metrics/vlm_judge_quality.py with metric that measures BINARY AGREEMENT between VLM overall_pass and human verdict. The sub-scores (character_match, scene_accuracy, etc.) exist only to help the VLM reach the correct binary decision - we don't optimize them directly. Feedback describes why VLM got the pass/fail wrong. Create backend/optimization/optimize_vlm_judge.py script to run GEPA on _build_evaluation_prompt().","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T06:14:17.206125-08:00","updated_at":"2025-12-27T10:14:58.553501-08:00","dependencies":[{"issue_id":"story-b7t","depends_on_id":"story-b75","type":"blocks","created_at":"2025-12-27T06:14:29.852777-08:00","created_by":"kavinstewart"}]}
{"id":"story-b80h","title":"Create settings UI for cache management","description":"Create a settings screen to display cache size and allow users to clear the cache.\n\n## Scope\n\n- Create `frontend/app/settings.tsx`\n- Display total cache size\n- \"Clear Cache\" button\n- Navigation link from library/home screen\n\n## Implementation\n\n```typescript\n// frontend/app/settings.tsx\nimport { useState, useEffect } from 'react';\nimport { View, Text, Pressable, Alert } from 'react-native';\nimport { useRouter } from 'expo-router';\nimport { StoryCacheManager } from '@/lib/story-cache';\nimport { fontFamily } from '@/lib/fonts';\n\nexport default function Settings() {\n  const router = useRouter();\n  const [cacheSize, setCacheSize] = useState(0);\n  const [storyCount, setStoryCount] = useState(0);\n  const [isClearing, setIsClearing] = useState(false);\n  \n  const loadCacheInfo = async () =\u003e {\n    const size = await StoryCacheManager.getCacheSize();\n    const ids = await StoryCacheManager.getCachedStoryIds();\n    setCacheSize(size);\n    setStoryCount(ids.length);\n  };\n  \n  useEffect(() =\u003e {\n    loadCacheInfo();\n  }, []);\n  \n  const formatSize = (bytes: number): string =\u003e {\n    if (bytes \u003c 1024) return `${bytes} B`;\n    if (bytes \u003c 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n  };\n  \n  const handleClearCache = () =\u003e {\n    Alert.alert(\n      'Clear Cache',\n      'This will remove all offline stories. You can re-download them by opening each story.',\n      [\n        { text: 'Cancel', style: 'cancel' },\n        {\n          text: 'Clear',\n          style: 'destructive',\n          onPress: async () =\u003e {\n            setIsClearing(true);\n            await StoryCacheManager.clearAllCache();\n            await loadCacheInfo();\n            setIsClearing(false);\n          },\n        },\n      ]\n    );\n  };\n  \n  return (\n    \u003cView style={{ flex: 1, backgroundColor: '#1a1a2e', padding: 20 }}\u003e\n      {/* Header */}\n      \u003cView style={{ flexDirection: 'row', alignItems: 'center', marginBottom: 32 }}\u003e\n        \u003cPressable onPress={() =\u003e router.back()}\u003e\n          \u003cText style={{ color: 'white', fontSize: 24 }}\u003e‚Üê\u003c/Text\u003e\n        \u003c/Pressable\u003e\n        \u003cText style={{\n          color: 'white',\n          fontSize: 24,\n          fontFamily: fontFamily.nunitoBold,\n          marginLeft: 16,\n        }}\u003e\n          Settings\n        \u003c/Text\u003e\n      \u003c/View\u003e\n      \n      {/* Cache section */}\n      \u003cView style={{\n        backgroundColor: 'rgba(255,255,255,0.1)',\n        borderRadius: 16,\n        padding: 20,\n      }}\u003e\n        \u003cText style={{\n          color: 'white',\n          fontSize: 18,\n          fontFamily: fontFamily.nunitoBold,\n          marginBottom: 16,\n        }}\u003e\n          Offline Storage\n        \u003c/Text\u003e\n        \n        \u003cView style={{ flexDirection: 'row', justifyContent: 'space-between', marginBottom: 8 }}\u003e\n          \u003cText style={{ color: 'rgba(255,255,255,0.7)', fontFamily: fontFamily.nunito }}\u003e\n            Cached stories\n          \u003c/Text\u003e\n          \u003cText style={{ color: 'white', fontFamily: fontFamily.nunitoBold }}\u003e\n            {storyCount}\n          \u003c/Text\u003e\n        \u003c/View\u003e\n        \n        \u003cView style={{ flexDirection: 'row', justifyContent: 'space-between', marginBottom: 20 }}\u003e\n          \u003cText style={{ color: 'rgba(255,255,255,0.7)', fontFamily: fontFamily.nunito }}\u003e\n            Storage used\n          \u003c/Text\u003e\n          \u003cText style={{ color: 'white', fontFamily: fontFamily.nunitoBold }}\u003e\n            {formatSize(cacheSize)}\n          \u003c/Text\u003e\n        \u003c/View\u003e\n        \n        \u003cPressable\n          onPress={handleClearCache}\n          disabled={isClearing || storyCount === 0}\n          style={{\n            backgroundColor: storyCount === 0 ? 'rgba(255,255,255,0.1)' : '#EF4444',\n            paddingVertical: 12,\n            borderRadius: 12,\n            alignItems: 'center',\n          }}\n        \u003e\n          \u003cText style={{\n            color: storyCount === 0 ? 'rgba(255,255,255,0.5)' : 'white',\n            fontFamily: fontFamily.nunitoBold,\n          }}\u003e\n            {isClearing ? 'Clearing...' : 'Clear Cache'}\n          \u003c/Text\u003e\n        \u003c/Pressable\u003e\n      \u003c/View\u003e\n    \u003c/View\u003e\n  );\n}\n```\n\nAdd navigation from home screen:\n\n```typescript\n// frontend/app/index.tsx - add settings button to header\n\u003cPressable onPress={() =\u003e router.push('/settings')}\u003e\n  \u003cText style={{ color: 'white', fontSize: 24 }}\u003e‚öôÔ∏è\u003c/Text\u003e\n\u003c/Pressable\u003e\n```\n\n## Test Strategy\n\n```typescript\n// E2E test\ntest('settings shows cache size and can clear', async ({ page }) =\u003e {\n  // Cache a story first\n  await page.goto('/read/test-story-id');\n  await page.waitForSelector('text=Saving for offline', { state: 'hidden', timeout: 60000 });\n  \n  // Go to settings\n  await page.goto('/settings');\n  \n  // Should show cached story count\n  await expect(page.getByText('1')).toBeVisible(); // 1 story cached\n  \n  // Should show size \u003e 0\n  await expect(page.getByText(/MB/)).toBeVisible();\n  \n  // Clear cache\n  await page.click('text=Clear Cache');\n  await page.click('text=Clear'); // Confirm dialog\n  \n  // Should show 0 stories\n  await expect(page.getByText('0')).toBeVisible();\n});\n```\n\n## Verification\n\n- E2E test passes\n- Manual: Cache some stories, check settings shows correct count/size, clear works\n\n## Files\n\n- `frontend/app/settings.tsx` (NEW)\n- `frontend/app/index.tsx` (MODIFY - add settings link)\n- `frontend/__tests__/e2e/settings.spec.ts` (NEW)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:36:33.844983698Z","created_by":"kavin","updated_at":"2026-01-04T22:27:57.573904762Z","closed_at":"2026-01-04T22:27:57.573904762Z","close_reason":"Created frontend/app/settings.tsx with cache size display, story count, and Clear Cache button with confirmation dialog. Added settings gear icon to home screen header. All tests pass.","dependencies":[{"issue_id":"story-b80h","depends_on_id":"story-hnta","type":"blocks","created_at":"2026-01-04T21:36:44.715264875Z","created_by":"daemon"},{"issue_id":"story-b80h","depends_on_id":"story-o28s","type":"blocks","created_at":"2026-01-04T21:36:44.7329468Z","created_by":"daemon"}],"comments":[{"id":16,"issue_id":"story-b80h","author":"kavin","text":"**Implementation notes:**\n\n1. **Settings button style:** Match the existing header design in `index.tsx`. Check what icons/buttons are already used and follow that pattern rather than assuming an emoji is appropriate.\n\n2. **Alert.alert compatibility:** `Alert.alert` works on iOS and Android but NOT on web. If web support is needed, implement a custom confirm modal. For v1, this can be noted as a known limitation‚Äîweb users would need a different confirmation UI.","created_at":"2026-01-04T21:40:19Z"}]}
{"id":"story-b8v","title":"Audit illustration_styles for dead code","description":"Review backend/core/modules/illustration_styles.py looking for redundant and/or dead code. Check for unused styles, deprecated definitions, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:40.44801-08:00","updated_at":"2025-12-26T15:39:12.79519-08:00","closed_at":"2025-12-26T15:39:12.79519-08:00"}
{"id":"story-bbl","title":"Rewrite character_sheet_generator for Nano Banana Pro","description":"Replace gpt-image-1 turnaround sheet generation with Nano Banana Pro portrait generation. Generate 1-2 simple reference portraits per character instead of 4-view turnarounds.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:12:58.341778-08:00","updated_at":"2025-12-16T11:19:55.421476-08:00","closed_at":"2025-12-16T11:19:55.421476-08:00","dependencies":[{"issue_id":"story-bbl","depends_on_id":"story-1f5","type":"blocks","created_at":"2025-12-16T11:13:32.524583-08:00","created_by":"kavinstewart"}]}
{"id":"story-bcb","title":"Audit API routes for dead code","description":"Review backend/api/routes/stories.py looking for redundant and/or dead code. Check for unused endpoints, deprecated route handlers, unreachable code paths, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:07.975074-08:00","updated_at":"2025-12-26T15:39:12.791511-08:00","closed_at":"2025-12-26T15:39:12.791511-08:00"}
{"id":"story-bds","title":"Remove empty placeholder directories","description":"Remove data/ and optimized/ directories (just contain .gitkeep files). These can be recreated when actually needed for GEPA optimization.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:42.99888-08:00","updated_at":"2025-12-17T09:27:54.335084-08:00","closed_at":"2025-12-17T09:27:54.335084-08:00"}
{"id":"story-bdzy","title":"Unit tests: spread regeneration repository methods","description":"Test the database repository methods for spread regeneration jobs.\n\n## Test File\n`backend/tests/unit/test_spread_regen_repository.py`\n\n## Test Cases\n\n### test_create_spread_regen_job\n- Creates job with correct fields (job_id, story_id, spread_number, status='pending')\n- Verifies job is retrievable after creation\n- Verifies created_at is set automatically\n\n### test_create_spread_regen_job_invalid_story\n- Attempting to create job for non-existent story raises error\n- Attempting to create job for non-existent spread raises error\n\n### test_update_spread_regen_status_to_running\n- Updates status from 'pending' to 'running'\n- Sets started_at timestamp\n- Preserves other fields\n\n### test_update_spread_regen_status_to_completed\n- Updates status to 'completed'\n- Sets completed_at timestamp\n- Clears any previous error_message\n\n### test_update_spread_regen_status_to_failed\n- Updates status to 'failed'\n- Sets error_message\n- Sets completed_at timestamp\n\n### test_get_spread_regen_job_not_found\n- Returns None for non-existent job_id\n\n### test_save_regenerated_spread_updates_timestamp\n- Updates illustration_path in story_spreads\n- Updates illustration_updated_at to current time\n- Verifies old path is replaced\n\n### test_save_regenerated_spread_invalid_spread\n- Raises error if spread doesn't exist\n\n## Setup/Fixtures\n- Use test database with sample story and spreads\n- Clean up jobs after each test","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:56:55.283759358Z","created_by":"kavin","updated_at":"2026-01-03T14:28:11.921781506Z","closed_at":"2026-01-03T14:28:11.921781506Z","close_reason":"Tests already implemented in tests/unit/test_spread_regen_repository.py (12 tests, all passing)","dependencies":[{"issue_id":"story-bdzy","depends_on_id":"story-ly0h","type":"blocks","created_at":"2026-01-01T17:58:18.75983074Z","created_by":"daemon"}]}
{"id":"story-bgxx","title":"Migrate from SQLAlchemy to raw asyncpg SQL","description":"Replace SQLAlchemy ORM with raw asyncpg queries. This simplifies the codebase, removes event loop conflicts, and gives more control over queries.\n\n## Files to Change\n- backend/api/database/db.py - Pool management\n- backend/api/database/repository.py - Story CRUD\n- backend/api/database/vlm_eval_repository.py - VLM eval CRUD\n- backend/api/database/models.py - Remove (extract schema.sql first)\n- tests/unit/conftest.py - Update mocks\n\n## Must Do\n1. Create pool in FastAPI lifespan handler (not module import) - fixes event loop conflicts\n2. Use $1, $2... parameterized queries everywhere - never f-strings\n3. Explicit 'async with conn.transaction()' for multi-statement ops (save_completed_story)\n4. Use executemany for batch inserts (spreads, character_refs)\n\n## Migration Strategy\n5. Keep repository interface unchanged - callers shouldn't know about switch\n6. Migrate one method at a time with tests - not big-bang\n7. Extract schema to schema.sql for docs and fresh deployments\n\n## Gotchas\n8. asyncpg.Record ‚Üí dict conversion in _model_to_response\n9. JSON columns stay TEXT - explicit json.dumps/loads at boundaries\n10. Cascade deletes already in PostgreSQL FKs (ON DELETE CASCADE)\n\n## Testing\n11. Update conftest.py - remove SQLAlchemy mocks, add asyncpg mocks\n12. Verify datetime timezone handling - asyncpg returns aware datetimes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:32:47.095834272Z","created_by":"kavin","updated_at":"2025-12-30T00:30:03.857315156Z","closed_at":"2025-12-30T00:30:03.857315156Z","close_reason":"Migration complete: replaced SQLAlchemy ORM with raw asyncpg queries. All 45 tests pass. Changes: schema.sql (PostgreSQL syntax), db.py (asyncpg pool), repository.py (raw SQL), vlm_eval_repository.py (raw SQL), dependencies.py (connection injection), conftest.py (asyncpg mocks), removed models.py, removed sqlalchemy from pyproject.toml","dependencies":[{"issue_id":"story-bgxx","depends_on_id":"story-la13","type":"blocks","created_at":"2025-12-29T23:56:47.611870509Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-taxl","type":"blocks","created_at":"2025-12-30T00:24:18.253559625Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-w025","type":"blocks","created_at":"2025-12-30T00:24:18.273812186Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-1aa6","type":"blocks","created_at":"2025-12-30T00:24:18.291404171Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-d6zj","type":"blocks","created_at":"2025-12-30T00:24:18.307374091Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-v0a4","type":"blocks","created_at":"2025-12-30T00:24:18.322986814Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-bnof","type":"blocks","created_at":"2025-12-30T00:24:18.339855684Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-v0et","type":"blocks","created_at":"2025-12-30T00:24:18.354121375Z","created_by":"daemon"},{"issue_id":"story-bgxx","depends_on_id":"story-d6op","type":"blocks","created_at":"2025-12-30T00:24:18.369535941Z","created_by":"daemon"}]}
{"id":"story-bi7r","title":"Switch edit-prompt from modal to fullScreenModal","description":"The current modal presentation has UX issues for this use case.\n\n## Problem\n- Modal fights with keyboard for space\n- Prompt editing is a deliberate operation, not a quick action\n- The regeneration loading state already covers full screen anyway\n\n## Solution\nChange presentation from 'modal' to 'fullScreenModal':\n- In _layout.tsx, update the edit-prompt screen options\n- Keep slide_from_bottom animation for continuity\n- Gives full viewport for editing while maintaining modal-like feel\n\n## Files\n- frontend/app/_layout.tsx","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T14:03:39.45869017Z","created_by":"kavin","updated_at":"2026-01-03T14:06:11.237525208Z","closed_at":"2026-01-03T14:06:11.237525208Z","close_reason":"Changed presentation from 'modal' to 'fullScreenModal' in _layout.tsx"}
{"id":"story-bm9o","title":"Add regenerateSpread to frontend API client","description":"Extend API client with spread regeneration method and cache-busting support.\n\n## Changes to api.ts\n\n### New Method\n```typescript\nregenerateSpread: async (\n  storyId: string,\n  spreadNumber: number,\n): Promise\u003c{ job_id: string; status: string }\u003e =\u003e {\n  return fetchApi(`/stories/${storyId}/spreads/${spreadNumber}/regenerate`, {\n    method: 'POST',\n  });\n},\n```\n\n### Update getSpreadImageUrl (Cache Busting)\n```typescript\ngetSpreadImageUrl: (\n  storyId: string, \n  spreadNumber: number,\n  updatedAt?: string  // NEW: timestamp for cache busting\n): string =\u003e {\n  const base = `${API_BASE_URL}/stories/${storyId}/spreads/${spreadNumber}/image`;\n  if (updatedAt) {\n    return `${base}?v=${new Date(updatedAt).getTime()}`;\n  }\n  return base;\n},\n```\n\n## Files\n- `frontend/lib/api.ts`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:42:49.560622824Z","created_by":"kavin","updated_at":"2026-01-03T16:19:54.755706518Z","closed_at":"2026-01-03T16:19:54.755706518Z","close_reason":"Already implemented - api.regenerateSpread() and cache-busting getSpreadImageUrl() exist in api.ts","dependencies":[{"issue_id":"story-bm9o","depends_on_id":"story-o13s","type":"blocks","created_at":"2026-01-01T17:43:58.375139455Z","created_by":"daemon"}]}
{"id":"story-bnof","title":"Update tests conftest.py","description":"Remove SQLAlchemy mocks, add asyncpg connection mocks. Update mock_session fixture.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.437214425Z","created_by":"kavin","updated_at":"2025-12-30T00:28:54.060398809Z","closed_at":"2025-12-30T00:28:54.060398809Z","close_reason":"Updated conftest.py with asyncpg connection mocks instead of SQLAlchemy session mocks","dependencies":[{"issue_id":"story-bnof","depends_on_id":"story-1aa6","type":"blocks","created_at":"2025-12-30T00:24:18.451823089Z","created_by":"daemon"},{"issue_id":"story-bnof","depends_on_id":"story-d6zj","type":"blocks","created_at":"2025-12-30T00:24:18.467664014Z","created_by":"daemon"}]}
{"id":"story-bsf","title":"Create API runner script","description":"Create scripts/run_api.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:24:10.820034-08:00","updated_at":"2025-12-17T11:30:56.624724-08:00","closed_at":"2025-12-17T11:30:56.624724-08:00","dependencies":[{"issue_id":"story-bsf","depends_on_id":"story-9s6","type":"blocks","created_at":"2025-12-17T11:24:49.294393-08:00","created_by":"kavinstewart"}]}
{"id":"story-bwr","title":"Update CharacterBibleSignature to work from story text","description":"Modify character bible generation to take the actual story text + extracted character list as input instead of outline descriptions. Visual details should be inferred from what characters DO in the story, not invented beforehand.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T19:44:10.442518-08:00","updated_at":"2025-12-20T02:03:21.17725-08:00","closed_at":"2025-12-20T02:03:21.17725-08:00","dependencies":[{"issue_id":"story-bwr","depends_on_id":"story-1qa","type":"blocks","created_at":"2025-12-19T19:44:49.051834-08:00","created_by":"kavinstewart"}]}
{"id":"story-c2h","title":"Audit frontend Library screen for dead code","description":"Review frontend/app/index.tsx (Story Library/Home) looking for redundant and/or dead code. Check for unused imports, deprecated patterns, and unused functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:59.39592-08:00","updated_at":"2025-12-26T15:39:12.796074-08:00","closed_at":"2025-12-26T15:39:12.796074-08:00"}
{"id":"story-c7a","title":"Audit types.py for dead code","description":"Review backend/core/types.py looking for redundant and/or dead code. Check for unused types, deprecated fields, and type definitions that are never used elsewhere in the codebase.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:29:46.803171-08:00","updated_at":"2025-12-26T15:39:12.795479-08:00","closed_at":"2025-12-26T15:39:12.795479-08:00"}
{"id":"story-cag","title":"Refactor story generation to spread-based approach","description":"Replace page-by-page generation with spread-based approach. 12 spreads, 200-400 words total, one illustration per spread. Generated all at once with Claude Opus 4.5.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-18T14:37:27.744874-08:00","updated_at":"2025-12-18T15:01:28.733391-08:00","closed_at":"2025-12-18T15:01:28.733391-08:00","dependencies":[{"issue_id":"story-cag","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:39:00.571473-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-lxd","type":"blocks","created_at":"2025-12-18T14:39:05.724504-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-fjf","type":"blocks","created_at":"2025-12-18T14:39:10.884908-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-9ii","type":"blocks","created_at":"2025-12-18T14:39:16.040894-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-hdt","type":"blocks","created_at":"2025-12-18T14:39:21.197492-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-617","type":"blocks","created_at":"2025-12-18T14:39:26.349341-08:00","created_by":"kavinstewart"},{"issue_id":"story-cag","depends_on_id":"story-isv","type":"blocks","created_at":"2025-12-18T14:39:31.499957-08:00","created_by":"kavinstewart"}]}
{"id":"story-cec","title":"Create story completion screen","description":"New screen at /completed/[id] shown after finishing a story.\n\n**Hero Section:**\n- Soft gradient background (matching library)\n- 'The End ‚ú®' header with fade+scale+pulse animation (32px Nunito Bold, amber #F97316)\n- Subtitle: 'You finished \"[Title]\"!' (18px Nunito SemiBold, dark gray)\n- Cover image of finished story (~200px wide, rounded corners, shadow)\n- 'Read Again' button (left of cover, cream bg, üìñ emoji) ‚Üí router.replace(/read/[id])\n- 'Library' button (right of cover, amber gradient, üè† emoji) ‚Üí router.replace(/)\n\n**Recommendations Section:**\n- Section header: 'More Adventures' (20px Nunito Bold, purple #7C3AED)\n- 4 story cards in horizontal row (same style as library cards)\n- Cards: cover image 70%, title on cream bg 30%, ~1:1.1 aspect ratio\n- Tap card ‚Üí router.replace(/read/[otherId])\n\n**Animation Cascade:**\n- 0ms: Screen transition (slide up or fade)\n- 0-650ms: 'The End ‚ú®' fade+scale+pulse\n- 200ms: Cover image fades in\n- 400ms: Buttons fade in\n- 600ms: 'More Adventures' header fades in\n- 800ms+: Recommendation cards stagger in (100ms between each)\n\n**Navigation:**\n- All exits use router.replace() to avoid stale back stack\n- Receives story ID from route params\n- Fetches completed story (for title/cover) + recommendations from API","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-24T15:29:06.919533-08:00","updated_at":"2025-12-24T15:53:01.120385-08:00","closed_at":"2025-12-24T15:53:01.120385-08:00","dependencies":[{"issue_id":"story-cec","depends_on_id":"story-ch2","type":"blocks","created_at":"2025-12-24T15:29:51.372645-08:00","created_by":"kavinstewart"},{"issue_id":"story-cec","depends_on_id":"story-53w","type":"blocks","created_at":"2025-12-24T15:29:56.516103-08:00","created_by":"kavinstewart"}]}
{"id":"story-ch2","title":"Add recommendations API endpoint","description":"New endpoint to serve story recommendations for the completion screen.\n\n**Endpoint:**\n```\nGET /stories/{story_id}/recommendations?limit=4\n```\n\n**Response:**\n```json\n{\n  \"recommendations\": [\n    {\n      \"id\": \"abc123\",\n      \"title\": \"The Brave Little Mouse\",\n      \"goal\": \"teach about courage\",\n      \"cover_url\": \"/stories/abc123/spreads/1/image\",\n      \"is_illustrated\": true\n    },\n    ...\n  ]\n}\n```\n\n**Logic (v1 - simple):**\n1. Fetch completed stories from database\n2. Exclude the current story_id\n3. Shuffle randomly\n4. Return first N (default 4)\n\n**Future enhancements (not for v1):**\n- Accept optional `user_id` param for personalization (user system doesn't exist yet)\n- Track read/completion history per user\n- Recommend based on similar themes/goals\n- Prioritize unread stories\n\n**Implementation notes:**\n- Add new route in `backend/api/routes/stories.py`\n- Add `StoryRecommendationResponse` model (lightweight: id, title, goal, cover_url, is_illustrated)\n- Repository method: `get_recommendations(exclude_id, limit)`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T15:29:40.558698-08:00","updated_at":"2025-12-24T15:53:01.119956-08:00","closed_at":"2025-12-24T15:53:01.119956-08:00"}
{"id":"story-csf","title":"Implement StoryLibrary screen","description":"Port story-library.jsx to app/index.tsx. Grid of StoryCards, filter tabs (All/New/Reading/Done), floating decorations, 'New Story' button","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:17.743361-08:00","updated_at":"2025-12-18T09:15:22.677945-08:00","closed_at":"2025-12-18T09:15:22.677945-08:00","dependencies":[{"issue_id":"story-csf","depends_on_id":"story-gpk","type":"blocks","created_at":"2025-12-18T08:53:05.87597-08:00","created_by":"kavinstewart"},{"issue_id":"story-csf","depends_on_id":"story-5bx","type":"blocks","created_at":"2025-12-18T08:53:11.034901-08:00","created_by":"kavinstewart"}]}
{"id":"story-ctg","title":"Implement StoryReader screen","description":"Port story-reader.jsx to app/read/[id].tsx. Side-by-side illustration+text layout, page navigation, progress dots, settings dropdown, swipe gestures","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:37.086577-08:00","updated_at":"2025-12-18T09:15:22.680123-08:00","closed_at":"2025-12-18T09:15:22.680123-08:00","dependencies":[{"issue_id":"story-ctg","depends_on_id":"story-gpk","type":"blocks","created_at":"2025-12-18T08:53:36.856042-08:00","created_by":"kavinstewart"},{"issue_id":"story-ctg","depends_on_id":"story-5bx","type":"blocks","created_at":"2025-12-18T08:53:42.018051-08:00","created_by":"kavinstewart"}]}
{"id":"story-cz1","title":"Integrate QA into PageIllustrator","description":"Add illustrate_page_with_qa method with retry loop","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:33.92679-08:00","updated_at":"2025-12-16T12:11:05.445037-08:00","closed_at":"2025-12-16T12:11:05.445037-08:00","dependencies":[{"issue_id":"story-cz1","depends_on_id":"story-69g","type":"blocks","created_at":"2025-12-16T11:49:12.337444-08:00","created_by":"kavinstewart"}]}
{"id":"story-d2r","title":"Update run_api.py uvicorn target path","description":"In cli/run_api.py, change uvicorn target from 'src.api.main:app' to 'backend.api.main:app'.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:20.229703-08:00","updated_at":"2025-12-18T08:21:44.204939-08:00","closed_at":"2025-12-18T08:21:44.204939-08:00","dependencies":[{"issue_id":"story-d2r","depends_on_id":"story-iaj","type":"blocks","created_at":"2025-12-18T07:33:18.21007-08:00","created_by":"kavinstewart"}]}
{"id":"story-d4z0","title":"Audit: Story Generation Pipeline (DSPy)","description":"**Code Path**: backend/core/programs/ and backend/core/modules/\n\n**Files to examine**:\n- backend/core/programs/story_generator.py\n- backend/core/modules/direct_story.py\n- backend/core/modules/quality_judge.py\n- backend/core/modules/character_extractor.py\n- backend/core/modules/bible_generator.py\n\n**Investigation goals**:\n1. Look for duplicated LLM calling patterns across modules\n2. Check for violations of SRP in StoryGenerator (orchestration vs logic)\n3. Identify overly complex control flow (quality loop, parallel execution)\n4. Look for duplicated parsing/formatting logic\n5. Check for DSPy anti-patterns or unnecessary module complexity\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"blocked","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:34.451995079Z","created_by":"kavin","updated_at":"2026-01-03T19:39:25.032906878Z","dependencies":[{"issue_id":"story-d4z0","depends_on_id":"story-qb9u","type":"blocks","created_at":"2026-01-03T19:39:06.311281659Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-mom5","type":"blocks","created_at":"2026-01-03T19:39:06.329320935Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-hy9l","type":"blocks","created_at":"2026-01-03T19:39:06.344362475Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-q1ux","type":"blocks","created_at":"2026-01-03T19:39:06.360552692Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-hj9c","type":"blocks","created_at":"2026-01-03T19:39:06.375472109Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-gahq","type":"blocks","created_at":"2026-01-03T19:39:06.390085126Z","created_by":"daemon"},{"issue_id":"story-d4z0","depends_on_id":"story-u23r","type":"blocks","created_at":"2026-01-03T19:39:06.404378032Z","created_by":"daemon"}],"comments":[{"id":5,"issue_id":"story-d4z0","author":"kavin","text":"## Audit Complete\n\nInvestigated the Story Generation Pipeline (DSPy) code path for KISS/SRP/duplication issues.\n\n### Files Examined:\n- `backend/core/programs/story_generator.py`\n- `backend/core/modules/direct_story_generator.py`\n- `backend/core/modules/quality_judge.py`\n- `backend/core/modules/character_extractor.py`\n- `backend/core/modules/bible_generator.py`\n- `backend/core/modules/spread_illustrator.py`\n- `backend/core/types.py`\n- `backend/core/signatures/*.py`\n\n### Issues Found (7 sub-beads created):\n\n**High Priority (clear violations)**:\n1. **story-qb9u**: Name matching logic duplicated between types.py and spread_illustrator.py\n2. **story-mom5**: Unused signature files from deprecated outline-first workflow\n3. **story-q1ux**: Inconsistent story text compilation (with/without spread numbers)\n\n**Medium Priority (dead code)**:\n4. **story-hy9l**: StoryOutline has dead fields from old workflow\n\n**Low Priority (monitor/consider)**:\n5. **story-hj9c**: Debug logging pattern scattered (may be fine as-is)\n6. **story-gahq**: Parallel execution boilerplate (borderline - patterns differ enough)\n7. **story-u23r**: Need to audit modules for unused code like signatures\n\n### Positive Observations:\n- Pipeline structure is clean and well-documented\n- DSPy module composition follows good patterns\n- Types are well-defined in centralized location\n- build_illustration_prompt() is properly marked as 'single source of truth'","created_at":"2026-01-03T19:39:24Z"}]}
{"id":"story-d6op","title":"Remove SQLAlchemy dependency","description":"Remove sqlalchemy from pyproject.toml dependencies","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.469725642Z","created_by":"kavin","updated_at":"2025-12-30T00:29:46.665860688Z","closed_at":"2025-12-30T00:29:46.665860688Z","close_reason":"Removed SQLAlchemy from pyproject.toml, regenerated poetry.lock","dependencies":[{"issue_id":"story-d6op","depends_on_id":"story-v0et","type":"blocks","created_at":"2025-12-30T00:24:18.503349048Z","created_by":"daemon"}]}
{"id":"story-d6zj","title":"Rewrite vlm_eval_repository.py with raw SQL","description":"Same as repository.py - convert to raw asyncpg queries","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.400583332Z","created_by":"kavin","updated_at":"2025-12-30T00:27:30.167161053Z","closed_at":"2025-12-30T00:27:30.167161053Z","close_reason":"Converted vlm_eval_repository.py to raw asyncpg SQL","dependencies":[{"issue_id":"story-d6zj","depends_on_id":"story-w025","type":"blocks","created_at":"2025-12-30T00:24:18.420740276Z","created_by":"daemon"}]}
{"id":"story-dm4v","title":"Audit: Frontend Data Layer","description":"**Code Path**: frontend/features/ and frontend/lib/\n\n**Files to examine**:\n- frontend/features/stories/hooks.ts\n- frontend/features/auth/store.ts\n- frontend/lib/api.ts\n- frontend/lib/auth-storage.ts\n\n**Investigation goals**:\n1. Look for duplicated API call patterns\n2. Check for duplicated polling/retry logic\n3. Identify non-KISS complexity in React Query hooks\n4. Look for duplicated token/auth handling\n5. Check for SRP violations (hooks doing too much)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:42.433094153Z","created_by":"kavin","updated_at":"2026-01-03T19:28:42.433094153Z"}
{"id":"story-e8q","title":"Create Zustand auth store","description":"Create frontend/features/auth/store.ts with token state, setToken, clearToken, hydrate actions using Zustand.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:15.210196279Z","created_by":"kavin","updated_at":"2025-12-29T01:35:27.471758287Z","closed_at":"2025-12-29T01:35:27.471758287Z","close_reason":"Created Zustand auth store in frontend/features/auth/store.ts","dependencies":[{"issue_id":"story-e8q","depends_on_id":"story-kz6","type":"blocks","created_at":"2025-12-29T01:30:34.291266623Z","created_by":"daemon"}]}
{"id":"story-eenf","title":"Extract story generation into standalone async function","description":"Move core generation logic from StoryService._generate_story into a standalone function that can be called by any task runner. This makes the code queue-agnostic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:26.252868901Z","created_by":"kavin","updated_at":"2025-12-29T22:25:54.552571345Z","closed_at":"2025-12-29T22:25:54.552571345Z","close_reason":"Created backend/api/services/story_generation.py with standalone generate_story() function","dependencies":[{"issue_id":"story-eenf","depends_on_id":"story-aeax","type":"blocks","created_at":"2025-12-29T22:23:46.522473374Z","created_by":"daemon"}]}
{"id":"story-enl","title":"Update Makefile paths for new structure","description":"Update Makefile: Line 57 'from src.config' ‚Üí 'from backend.config', Line 58 'from src.programs.story_generator' ‚Üí 'from backend.core.programs.story_generator', Line 75 'python -m src.optimization.optimize_page_writer' ‚Üí 'python -m backend.optimization.optimize_page_writer'. Also update scripts/ references to cli/.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:59.58823-08:00","updated_at":"2025-12-18T08:21:44.207104-08:00","closed_at":"2025-12-18T08:21:44.207104-08:00","dependencies":[{"issue_id":"story-enl","depends_on_id":"story-3y8","type":"blocks","created_at":"2025-12-18T07:33:51.377911-08:00","created_by":"kavinstewart"},{"issue_id":"story-enl","depends_on_id":"story-iaj","type":"blocks","created_at":"2025-12-18T07:33:56.534343-08:00","created_by":"kavinstewart"}]}
{"id":"story-entg","title":"Add polling for regeneration job completion","description":"Frontend doesn't wait for regeneration to complete before navigating back.\n\n## Problem\n- regenerateSpread mutation's onSuccess fires on HTTP 202 (job started)\n- Frontend navigates back immediately, before job completes\n- New image never loads because the old image is still there\n\n## Solution\nAfter starting regeneration, poll the story every 2s until:\n1. spread.illustration_updated_at changes from original value, OR\n2. 60s timeout (show error)\n\nImplementation:\n- Store original illustration_updated_at before mutation\n- On mutation success, start polling interval\n- Compare current vs original timestamp each poll\n- On change: clear interval, update cache, navigate back\n- On timeout: clear interval, show error state\n- Add haptic feedback on successful completion\n\n## Files\n- frontend/app/edit-prompt.tsx\n- frontend/features/stories/hooks.ts (may need adjustment)","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-03T14:03:40.43208694Z","created_by":"kavin","updated_at":"2026-01-03T14:06:11.253814157Z","closed_at":"2026-01-03T14:06:11.253814157Z","close_reason":"Added polling that watches illustration_updated_at for changes, with 90s timeout, error handling, and haptic feedback on completion/failure"}
{"id":"story-eub","title":"Complete signatures/__init__.py exports","description":"Add missing signature exports:\n- CharacterBibleSignature\n- IllustrationStyleSignature\n- PageCritiqueSignature\n- PageRevisionSignature\nThese are used by outline_generator.py and page_generator.py but not exported from the package.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:56.206241-08:00","updated_at":"2025-12-17T09:27:54.335721-08:00","closed_at":"2025-12-17T09:27:54.335721-08:00"}
{"id":"story-fctv","title":"Remove VLM eval repository and logging scaffolding","description":"Remove incomplete VLM evaluation logging infrastructure. The logging code in VLMJudge is broken (calls instance method as static) and disabled by default.\n\nFiles to modify:\n- backend/api/database/vlm_eval_repository.py - delete entirely\n- backend/core/modules/vlm_judge.py - remove _log_evaluation method and enable_logging parameter\n- backend/api/database/schema.sql - remove vlm_evaluations table (or keep for future, note in description)\n- backend/api/database/migrations/001_uuid_and_jsonb.sql - check if vlm_evaluations references need removal","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T00:12:54.67550388Z","created_by":"kavin","updated_at":"2026-01-04T00:17:03.502489972Z","closed_at":"2026-01-04T00:17:03.502489972Z","close_reason":"Removed vlm_eval_repository.py, cleaned up vlm_judge.py (removed logging), updated schema.sql, created drop migration"}
{"id":"story-ffw","title":"Set up project directory structure","description":"Create src/signatures, src/modules, src/programs, src/metrics, src/optimization, data/, optimized/, scripts/ directories with __init__.py files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:36:57.453455-08:00","updated_at":"2025-12-11T09:42:11.973357-08:00","closed_at":"2025-12-11T09:42:11.973357-08:00"}
{"id":"story-fjf","title":"Update OutlineGenerator for spread_breakdown","description":"Change page_breakdown field to spread_breakdown. 12 spreads with page-turn moments noted. Update StoryOutlineSignature docstring.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:38:12.643583-08:00","updated_at":"2025-12-18T14:48:08.386302-08:00","closed_at":"2025-12-18T14:48:08.386302-08:00","dependencies":[{"issue_id":"story-fjf","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:40:58.59602-08:00","created_by":"kavinstewart"}]}
{"id":"story-fo9","title":"Update story output with illustrations","description":"Modify story output to include both text and illustration for each page. Export as markdown with embedded images or structured format for layout tools.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T10:35:26.736675-08:00","updated_at":"2025-12-13T10:43:23.879588-08:00","closed_at":"2025-12-13T10:43:23.879588-08:00","dependencies":[{"issue_id":"story-fo9","depends_on_id":"story-ymv","type":"blocks","created_at":"2025-12-13T10:36:02.568743-08:00","created_by":"kavinstewart"}]}
{"id":"story-ftea","title":"Remove temporary image error logging","description":"Remove the onError logging added to Image components in StoryCard.tsx and read/[id].tsx. These were added for debugging image loading issues and should be removed once the issue is resolved.","status":"closed","priority":4,"issue_type":"chore","created_at":"2026-01-04T23:29:52.076861777Z","created_by":"kavin","updated_at":"2026-01-05T03:51:38.933893814Z","closed_at":"2026-01-05T03:51:38.933893814Z","close_reason":"Removed debug console.log/error from Image components"}
{"id":"story-fu1","title":"Move mocks/ to docs/prototypes/ using git mv","description":"Use git mv to move mocks/ directory to docs/prototypes/. Contains JSX UI prototype files: story-library.jsx, new-story.jsx, story-reader.jsx.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:53.004109-08:00","updated_at":"2025-12-18T07:47:27.329283-08:00","closed_at":"2025-12-18T07:47:27.329283-08:00"}
{"id":"story-fubj","title":"Remove dead code from cache layer","description":"Remove 4 unused functions and 1 unused parameter:\n- invalidateStory (just calls evictStory)\n- clearIndex (never called)  \n- getDirectorySize (never called)\n- _expectedSpreadCount parameter in verifyStoryFiles\n\nFiles: cache-storage.ts, cache-files.ts, story-cache.ts\n\nThis is pure deletion with no logic changes. Makes the codebase smaller and easier to reason about for subsequent fixes.","status":"closed","priority":1,"issue_type":"chore","estimated_minutes":5,"created_at":"2026-01-05T04:19:43.487715259Z","created_by":"kavin","updated_at":"2026-01-05T04:27:33.632451834Z","closed_at":"2026-01-05T04:27:33.632451834Z","close_reason":"Removed clearIndex, getDirectorySize, and unused _expectedSpreadCount parameter. Tests updated and passing."}
{"id":"story-fvwb","title":"Consolidate illustration prompt builders","description":"Remove code duplication between repository._build_composed_prompt() and spread_illustrator._build_scene_prompt(). Create shared build_illustration_prompt() function in backend/core/types.py that takes primitive strings, then update both callers to use it.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T15:11:27.026964394Z","created_by":"kavin","updated_at":"2026-01-03T15:14:22.572727482Z","closed_at":"2026-01-03T15:14:22.572727482Z","close_reason":"Consolidated illustration prompt builders: created shared build_illustration_prompt() in backend/core/types.py, updated spread_illustrator.py and repository.py to use it, added unit tests in test_types.py. All 98 unit tests pass."}
{"id":"story-g7ym","title":"Bug: VLMJudge receives invalid enable_logging kwarg","description":"image_qa.py:91 passes enable_logging to VLMJudge but VLMJudge.__init__ (vlm_judge.py:51) doesn't accept it. Will raise TypeError at runtime when QA is used.\n\nFix: Either remove the enable_logging param from ImageQA's VLMJudge instantiation, or add the param to VLMJudge.__init__ if logging support is still desired.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-04T00:34:16.456703634Z","created_by":"kavin","updated_at":"2026-01-04T00:46:53.176961236Z","closed_at":"2026-01-04T00:46:53.176961236Z","close_reason":"Fixed: removed stale enable_logging kwarg from ImageQA.vlm_judge property. Also disabled use_image_qa by default in favor of manual regeneration approach."}
{"id":"story-g8k","title":"Improve error display in frontend","description":"Show actual error message from API instead of generic 'Failed'. Keep form state so users can easily retry. Display error message + 'Try Again' button that preserves their input.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:08:40.955365-08:00","updated_at":"2025-12-19T15:29:29.741765-08:00","closed_at":"2025-12-19T15:29:29.741765-08:00","dependencies":[{"issue_id":"story-g8k","depends_on_id":"story-1j3","type":"blocks","created_at":"2025-12-19T15:09:02.521104-08:00","created_by":"kavinstewart"}]}
{"id":"story-g8m0","title":"Update FastAPI routes for async handlers","description":"Convert all FastAPI route handlers to async and update dependency injection for async sessions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:36.378676456Z","created_by":"kavin","updated_at":"2025-12-29T15:07:02.703203889Z","closed_at":"2025-12-29T15:07:02.703203889Z","close_reason":"Updated admin routes to use VLMEvalRepo dependency; story routes unchanged","dependencies":[{"issue_id":"story-g8m0","depends_on_id":"story-o1ql","type":"blocks","created_at":"2025-12-29T14:44:31.516415833Z","created_by":"daemon"},{"issue_id":"story-g8m0","depends_on_id":"story-ahc8","type":"blocks","created_at":"2025-12-29T14:44:31.529852602Z","created_by":"daemon"}]}
{"id":"story-gahq","title":"Consider: Extract parallel execution helper","description":"**Issue**: ThreadPoolExecutor boilerplate is duplicated with similar patterns.\n\n**Locations**:\n1. `story_generator.py` lines 145-176: Parallel style selection + quality judging\n2. `spread_illustrator.py` lines 219-267: Parallel spread illustration  \n3. `spread_illustrator.py` lines 493-605: Parallel spread illustration with QA\n\n**Common pattern**:\n```python\nwith concurrent.futures.ThreadPoolExecutor(max_workers=N) as executor:\n    futures = {executor.submit(func, item): item for item in items}\n    for future in concurrent.futures.as_completed(futures):\n        result = future.result()\n        # update progress\n        # handle errors\n```\n\n**Consideration**:\nWhile similar, each has different:\n- Worker counts (2 vs 6)\n- Progress tracking logic\n- Error handling\n- Result processing\n\n**Assessment**: \nThis is a borderline case. The duplication is structural but the specifics differ.\nA generic helper might be over-abstraction.\n\n**Recommendation**: \n- Leave as-is for now (KISS)\n- Only extract if a 4th parallel pattern emerges\n- Mark as 'technical debt - monitor'\n\n**Complexity**: Medium - but may not be worth it","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:38:55.128143025Z","created_by":"kavin","updated_at":"2026-01-03T21:03:43.842911605Z","closed_at":"2026-01-03T21:03:43.842911605Z","close_reason":"Won't fix - Parallel execution patterns differ enough (worker counts, progress tracking, error handling) that a generic helper would be over-abstraction. KISS applies."}
{"id":"story-gfpa","title":"Audit: Frontend Screens","description":"**Code Path**: frontend/app/\n\n**Files to examine**:\n- frontend/app/index.tsx\n- frontend/app/new.tsx\n- frontend/app/read/[id].tsx\n- frontend/app/creating/[id].tsx\n- frontend/app/login.tsx\n- frontend/app/_layout.tsx\n\n**Investigation goals**:\n1. Look for duplicated UI patterns across screens\n2. Check for duplicated navigation/routing logic\n3. Identify non-KISS complexity in screen components\n4. Look for duplicated state management\n5. Check for SRP violations (screens doing too much vs using components)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:43.688105882Z","created_by":"kavin","updated_at":"2026-01-03T19:28:43.688105882Z"}
{"id":"story-ggb","title":"Create DSPy signatures","description":"Define StoryOutlineSignature, PageWriterSignature, and StoryJudgeSignature in src/signatures/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:03.992924-08:00","updated_at":"2025-12-11T09:43:45.865396-08:00","closed_at":"2025-12-11T09:43:45.865396-08:00","dependencies":[{"issue_id":"story-ggb","depends_on_id":"story-ffw","type":"blocks","created_at":"2025-12-11T09:38:33.581987-08:00","created_by":"kavinstewart"}]}
{"id":"story-gjiu","title":"Integration test: end-to-end story generation via ARQ","description":"Test full flow: API request -\u003e ARQ enqueue -\u003e worker picks up -\u003e story saved to DB. Requires running Redis.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:23:32.669480501Z","created_by":"kavin","updated_at":"2025-12-29T23:49:14.348083571Z","closed_at":"2025-12-29T23:49:14.348083571Z","close_reason":"Added 5 integration tests for ARQ: Redis connection, job enqueue, worker processing, StoryService integration, and end-to-end flow. All tests pass.","dependencies":[{"issue_id":"story-gjiu","depends_on_id":"story-5oav","type":"blocks","created_at":"2025-12-29T22:23:46.584179151Z","created_by":"daemon"},{"issue_id":"story-gjiu","depends_on_id":"story-2b1a","type":"blocks","created_at":"2025-12-29T22:23:46.597833151Z","created_by":"daemon"}]}
{"id":"story-gpk","title":"Create shared UI components","description":"Build components/ui/: Button, Card, ProgressBar, FloatingElement. Build components/story/: StoryCard, ThemePill. All with NativeWind + Moti animations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:11.305123-08:00","updated_at":"2025-12-18T09:11:15.545534-08:00","closed_at":"2025-12-18T09:11:15.545534-08:00","dependencies":[{"issue_id":"story-gpk","depends_on_id":"story-8ry","type":"blocks","created_at":"2025-12-18T08:52:36.026398-08:00","created_by":"kavinstewart"},{"issue_id":"story-gpk","depends_on_id":"story-xrl","type":"blocks","created_at":"2025-12-18T08:52:41.19442-08:00","created_by":"kavinstewart"},{"issue_id":"story-gpk","depends_on_id":"story-80e","type":"blocks","created_at":"2025-12-18T08:52:46.359435-08:00","created_by":"kavinstewart"}]}
{"id":"story-gso5","title":"Implement file system operations layer","description":"Create file system wrapper for downloading, saving, and managing story files on disk.\n\n## Scope\n\n- Create `frontend/lib/cache-files.ts`\n- Implement file operations using expo-file-system\n- Handle URL transformation (API URLs ‚Üí file:// URLs)\n\n## Implementation\n\n```typescript\n// frontend/lib/cache-files.ts\nimport * as FileSystem from 'expo-file-system';\nimport { Story } from './api';\n\nconst CACHE_DIR = `${FileSystem.documentDirectory}stories/`;\n\nexport const cacheFiles = {\n  getStoryDir: (storyId: string): string =\u003e `${CACHE_DIR}${storyId}/`,\n  \n  getSpreadPath: (storyId: string, spreadNumber: number): string =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    return `${dir}spread_${spreadNumber.toString().padStart(2, '0')}.png`;\n  },\n  \n  ensureDirectoryExists: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    await FileSystem.makeDirectoryAsync(dir, { intermediates: true });\n  },\n  \n  downloadSpreadImage: async (\n    storyId: string,\n    spreadNumber: number,\n    sourceUrl: string\n  ): Promise\u003c{ success: boolean; size: number }\u003e =\u003e {\n    const destPath = cacheFiles.getSpreadPath(storyId, spreadNumber);\n    try {\n      const result = await FileSystem.downloadAsync(sourceUrl, destPath);\n      if (result.status !== 200) {\n        return { success: false, size: 0 };\n      }\n      const info = await FileSystem.getInfoAsync(destPath);\n      return { success: true, size: info.exists ? info.size : 0 };\n    } catch (error) {\n      console.error(`Failed to download spread ${spreadNumber}:`, error);\n      return { success: false, size: 0 };\n    }\n  },\n  \n  saveStoryMetadata: async (storyId: string, story: Story): Promise\u003cvoid\u003e =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    const transformed = cacheFiles.transformStoryUrls(storyId, story);\n    await FileSystem.writeAsStringAsync(\n      `${dir}metadata.json`,\n      JSON.stringify(transformed)\n    );\n  },\n  \n  loadStoryMetadata: async (storyId: string): Promise\u003cStory | null\u003e =\u003e {\n    const path = `${cacheFiles.getStoryDir(storyId)}metadata.json`;\n    try {\n      const content = await FileSystem.readAsStringAsync(path);\n      return JSON.parse(content);\n    } catch {\n      return null;\n    }\n  },\n  \n  transformStoryUrls: (storyId: string, story: Story): Story =\u003e {\n    return {\n      ...story,\n      spreads: story.spreads?.map(spread =\u003e ({\n        ...spread,\n        illustration_url: cacheFiles.getSpreadPath(storyId, spread.spread_number),\n      })),\n    };\n  },\n  \n  deleteStoryDirectory: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    await FileSystem.deleteAsync(dir, { idempotent: true });\n  },\n  \n  verifyStoryFiles: async (storyId: string, expectedSpreadCount: number): Promise\u003cboolean\u003e =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    const dirInfo = await FileSystem.getInfoAsync(dir);\n    if (!dirInfo.exists) return false;\n    \n    // Check metadata.json exists\n    const metaInfo = await FileSystem.getInfoAsync(`${dir}metadata.json`);\n    if (!metaInfo.exists) return false;\n    \n    // Check all spread images exist\n    for (let i = 1; i \u003c= expectedSpreadCount; i++) {\n      const spreadPath = cacheFiles.getSpreadPath(storyId, i);\n      const spreadInfo = await FileSystem.getInfoAsync(spreadPath);\n      if (!spreadInfo.exists) return false;\n    }\n    \n    return true;\n  },\n  \n  getDirectorySize: async (storyId: string): Promise\u003cnumber\u003e =\u003e {\n    const dir = cacheFiles.getStoryDir(storyId);\n    const dirInfo = await FileSystem.getInfoAsync(dir);\n    if (!dirInfo.exists) return 0;\n    \n    // Sum up all file sizes\n    const files = await FileSystem.readDirectoryAsync(dir);\n    let total = 0;\n    for (const file of files) {\n      const info = await FileSystem.getInfoAsync(`${dir}${file}`);\n      if (info.exists \u0026\u0026 !info.isDirectory) {\n        total += info.size || 0;\n      }\n    }\n    return total;\n  },\n};\n```\n\n## Test Strategy\n\nIntegration tests (require expo-file-system, run on device/simulator):\n\n```typescript\n// frontend/__tests__/lib/cache-files.test.ts\ndescribe('cache-files', () =\u003e {\n  const testStoryId = 'test-story-123';\n  \n  afterEach(async () =\u003e {\n    await cacheFiles.deleteStoryDirectory(testStoryId);\n  });\n  \n  it('creates story directory and saves metadata', async () =\u003e {\n    await cacheFiles.ensureDirectoryExists(testStoryId);\n    await cacheFiles.saveStoryMetadata(testStoryId, mockStory);\n    const loaded = await cacheFiles.loadStoryMetadata(testStoryId);\n    expect(loaded?.id).toBe(testStoryId);\n  });\n  \n  it('transforms illustration_url to file:// paths', async () =\u003e {\n    const transformed = cacheFiles.transformStoryUrls(testStoryId, mockStory);\n    expect(transformed.spreads?.[0].illustration_url).toMatch(/^file:\\/\\//);\n  });\n  \n  it('deleteStoryDirectory removes all files', async () =\u003e {\n    await cacheFiles.ensureDirectoryExists(testStoryId);\n    await cacheFiles.saveStoryMetadata(testStoryId, mockStory);\n    await cacheFiles.deleteStoryDirectory(testStoryId);\n    const loaded = await cacheFiles.loadStoryMetadata(testStoryId);\n    expect(loaded).toBeNull();\n  });\n  \n  it('verifyStoryFiles returns false if images missing', async () =\u003e {\n    await cacheFiles.ensureDirectoryExists(testStoryId);\n    await cacheFiles.saveStoryMetadata(testStoryId, mockStory);\n    // No images downloaded\n    const valid = await cacheFiles.verifyStoryFiles(testStoryId, 12);\n    expect(valid).toBe(false);\n  });\n});\n```\n\n## Verification\n\n- Integration tests pass on iOS simulator\n- Manual: Check files appear in app sandbox using Xcode device explorer\n\n## Files\n\n- `frontend/lib/cache-files.ts` (NEW)\n- `frontend/__tests__/lib/cache-files.test.ts` (NEW)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:33:23.889522033Z","created_by":"kavin","updated_at":"2026-01-04T21:52:41.082045927Z","closed_at":"2026-01-04T21:52:41.082045927Z","close_reason":"Created frontend/lib/cache-files.ts with expo-file-system wrapper for story file operations. Includes download, metadata save/load, URL transformation, verification, and size calculation. TypeScript passes.","dependencies":[{"issue_id":"story-gso5","depends_on_id":"story-slt4","type":"blocks","created_at":"2026-01-04T21:34:04.585325391Z","created_by":"daemon"}],"comments":[{"id":11,"issue_id":"story-gso5","author":"kavin","text":"**Implementation notes:**\n\n1. Use existing import path conventions (check `tsconfig.json` for aliases like `@/lib/...`)\n\n2. Add minimum file size validation to `downloadSpreadImage()`:\n```typescript\nif (info.size \u003c 1000) { // Less than 1KB is likely an error response, not a real image\n  await FileSystem.deleteAsync(destPath, { idempotent: true });\n  return { success: false, size: 0 };\n}\n```","created_at":"2026-01-04T21:39:51Z"}]}
{"id":"story-guk2","title":"Frontend: Create remote logger utility","description":"Create a logger utility that intercepts console.log/warn/error and batches entries to POST to /logs/ingest. Features: 1) Wraps console methods to capture all logs, 2) Batches entries (e.g., every 5 seconds or 20 entries), 3) Queues logs if offline, 4) Includes device/session context. Initialize in _layout.tsx on app startup.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T23:07:25.160738532Z","created_by":"kavin","updated_at":"2026-01-04T23:11:33.967413617Z","closed_at":"2026-01-04T23:11:33.967413617Z","close_reason":"Created remote-logger.ts that intercepts console methods, batches entries, and POSTs to /logs/ingest with auth. Initialized in _layout.tsx after authentication.","dependencies":[{"issue_id":"story-guk2","depends_on_id":"story-axjw","type":"blocks","created_at":"2026-01-04T23:07:25.166084376Z","created_by":"daemon"}]}
{"id":"story-gzxw","title":"Cleanup: Remove duplicate import sys in spread_illustrator","description":"spread_illustrator.py has 'import sys' at both line 16 (module level) and line 109 (inside illustrate_spread). The inner import is redundant.\n\nFix: Remove the import at line 109.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T00:34:17.814385495Z","created_by":"kavin","updated_at":"2026-01-04T00:54:40.517850458Z","closed_at":"2026-01-04T00:54:40.517850458Z","close_reason":"Removed 4 redundant 'import sys' statements from methods (lines 109, 151, 373, 451) - module-level import at line 16 is sufficient"}
{"id":"story-hdt","title":"Update SpreadIllustrator for 12 images","description":"Rename PageIllustrator to SpreadIllustrator. Generate 12 images (one per spread) instead of 32. Each image represents a double-page spread.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:38:24.078983-08:00","updated_at":"2025-12-18T14:55:30.669861-08:00","closed_at":"2025-12-18T14:55:30.669861-08:00","dependencies":[{"issue_id":"story-hdt","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:41:03.754932-08:00","created_by":"kavinstewart"},{"issue_id":"story-hdt","depends_on_id":"story-9ii","type":"blocks","created_at":"2025-12-18T14:42:37.519048-08:00","created_by":"kavinstewart"}]}
{"id":"story-hepy","title":"Add integration tests for race conditions and atomicity","description":"Add tests to verify the fixes:\n\n1. Race condition test: Run concurrent setStoryEntry calls for different stories, assert no lost updates\n\n2. Crash scenario tests: Mock filesystem/AsyncStorage to throw at critical points, verify cleanup happens correctly\n\n3. Hook test: Test useStoryCache hook state transitions match expected flow\n\nThese tests document expected behavior and prevent regressions.","status":"open","priority":3,"issue_type":"task","estimated_minutes":20,"created_at":"2026-01-05T04:21:26.704218623Z","created_by":"kavin","updated_at":"2026-01-05T04:21:26.704218623Z","dependencies":[{"issue_id":"story-hepy","depends_on_id":"story-kt54","type":"blocks","created_at":"2026-01-05T04:21:26.712857982Z","created_by":"daemon"}]}
{"id":"story-hj9c","title":"Consider: Centralize debug logging pattern","description":"**Issue**: Scattered debug print statements throughout all modules.\n\n**Pattern observed**:\n```python\nimport sys\nif debug:\n    print(f\"DEBUG ...\", file=sys.stderr)\n```\n\n**Locations** (partial list):\n- direct_story_generator.py: lines 91, 177, 188-191, 195\n- character_extractor.py: lines 81, 84, 94-96\n- bible_generator.py: lines 106, 113-114, 127-129\n- spread_illustrator.py: lines 174, 183-188, 253, 257, etc.\n- story_generator.py: lines 104, 181, 266, 279-281, etc.\n\n**Consideration**:\nThis is somewhat a Python idiom, but it creates:\n1. Boilerplate in every method\n2. Inconsistent message formats ('DEBUG', no prefix, etc.)\n3. Easy to forget the file=sys.stderr\n\n**Possible improvements**:\n- Option A: Create a simple debug logger utility\n- Option B: Use Python logging module with DEBUG level\n- Option C: Leave as-is (KISS - it works)\n\n**Recommendation**: Option C unless the team wants structured logging. This is minor.\n\n**Complexity**: Low if doing it, but may be over-engineering","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:38:53.713960362Z","created_by":"kavin","updated_at":"2026-01-03T21:03:42.805775893Z","closed_at":"2026-01-03T21:03:42.805775893Z","close_reason":"Won't fix - Debug print pattern is idiomatic Python and works fine. Centralizing would add unnecessary abstraction. KISS applies."}
{"id":"story-hnta","title":"Implement LRU eviction and size management","description":"Add cache size management and LRU eviction to StoryCacheManager.\n\n## Scope\n\n- Add to `frontend/lib/story-cache.ts`:\n  - `ensureCacheSpace(neededBytes)`\n  - `getCacheSize()`\n  - `getCachedStoryIds()`\n- Implement LRU eviction based on `lastRead` timestamp\n- Default budget: 500MB\n\n## Implementation\n\n```typescript\n// Add to frontend/lib/story-cache.ts\n\nconst MAX_CACHE_SIZE = 500 * 1024 * 1024; // 500MB\n\nexport const StoryCacheManager = {\n  // ... existing methods ...\n  \n  getCacheSize: async (): Promise\u003cnumber\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    return Object.values(index).reduce((sum, entry) =\u003e sum + entry.sizeBytes, 0);\n  },\n  \n  getCachedStoryIds: async (): Promise\u003cstring[]\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    return Object.keys(index);\n  },\n  \n  ensureCacheSpace: async (neededBytes: number): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    const currentSize = Object.values(index).reduce((sum, e) =\u003e sum + e.sizeBytes, 0);\n    \n    if (currentSize + neededBytes \u003c= MAX_CACHE_SIZE) {\n      return; // Enough space\n    }\n    \n    // Sort by lastRead ascending (oldest first)\n    const sorted = Object.entries(index)\n      .sort(([, a], [, b]) =\u003e a.lastRead - b.lastRead);\n    \n    let freedSpace = 0;\n    const needed = (currentSize + neededBytes) - MAX_CACHE_SIZE;\n    \n    for (const [storyId, entry] of sorted) {\n      if (freedSpace \u003e= needed) break;\n      \n      await StoryCacheManager.evictStory(storyId);\n      freedSpace += entry.sizeBytes;\n      console.log(`Evicted story ${storyId} to free ${entry.sizeBytes} bytes`);\n    }\n  },\n  \n  clearAllCache: async (): Promise\u003cvoid\u003e =\u003e {\n    const storyIds = await StoryCacheManager.getCachedStoryIds();\n    for (const storyId of storyIds) {\n      await StoryCacheManager.evictStory(storyId);\n    }\n  },\n};\n\n// Update cacheStory to call ensureCacheSpace before downloading\ncacheStory: async (story: Story): Promise\u003cboolean\u003e =\u003e {\n  // Estimate size (12 spreads * ~700KB average)\n  const estimatedSize = (story.spreads?.length || 12) * 700 * 1024;\n  await StoryCacheManager.ensureCacheSpace(estimatedSize);\n  \n  // ... rest of existing implementation\n};\n```\n\n## Test Strategy\n\n```typescript\ndescribe('LRU eviction', () =\u003e {\n  it('getCacheSize returns sum of all cached stories', async () =\u003e {\n    await StoryCacheManager.cacheStory(storyA);\n    await StoryCacheManager.cacheStory(storyB);\n    const size = await StoryCacheManager.getCacheSize();\n    expect(size).toBeGreaterThan(0);\n  });\n  \n  it('evicts oldest-read story when over budget', async () =\u003e {\n    // Cache 3 stories with known read times\n    await StoryCacheManager.cacheStory(storyA);\n    await sleep(10);\n    await StoryCacheManager.cacheStory(storyB);\n    await sleep(10);\n    await StoryCacheManager.cacheStory(storyC);\n    \n    // Mock a very low budget to force eviction\n    // (or cache many stories until over 500MB)\n    \n    // Verify oldest (A) evicted first\n    expect(await StoryCacheManager.isStoryCached(storyA.id)).toBe(false);\n    expect(await StoryCacheManager.isStoryCached(storyC.id)).toBe(true);\n  });\n  \n  it('clearAllCache removes everything', async () =\u003e {\n    await StoryCacheManager.cacheStory(storyA);\n    await StoryCacheManager.cacheStory(storyB);\n    await StoryCacheManager.clearAllCache();\n    expect(await StoryCacheManager.getCacheSize()).toBe(0);\n  });\n});\n```\n\n## Verification\n\n- Unit tests pass with mocked sizes\n- Manual: Fill cache to ~500MB, add another story, verify oldest evicted\n\n## Files\n\n- `frontend/lib/story-cache.ts` (MODIFY)\n- `frontend/__tests__/lib/story-cache.test.ts` (MODIFY)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:34:36.232711309Z","created_by":"kavin","updated_at":"2026-01-04T22:04:42.872242484Z","closed_at":"2026-01-04T22:04:42.872242484Z","close_reason":"Added LRU eviction and size management to StoryCacheManager: getCacheSize, getCachedStoryIds, ensureCacheSpace (with LRU eviction), clearAllCache. cacheStory now calls ensureCacheSpace before downloading. Added 10 new tests, all 65 tests pass.","dependencies":[{"issue_id":"story-hnta","depends_on_id":"story-olko","type":"blocks","created_at":"2026-01-04T21:35:07.06862791Z","created_by":"daemon"}]}
{"id":"story-hrya","title":"Audit: Illustration Generation","description":"**Code Path**: backend/core/modules/ (illustration-related)\n\n**Files to examine**:\n- backend/core/modules/spread_illustrator.py\n- backend/core/modules/character_sheet_generator.py\n- backend/core/modules/image_qa.py (if exists)\n- backend/config/image.py\n\n**Investigation goals**:\n1. Look for duplicated prompt building logic\n2. Check for duplicated image generation/extraction code\n3. Identify non-KISS complexity in QA retry loops\n4. Look for character reference handling duplication\n5. Check for SRP violations (generation vs QA vs prompt building)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:35.321203459Z","created_by":"kavin","updated_at":"2026-01-04T00:34:29.119442604Z","closed_at":"2026-01-04T00:34:29.119442604Z","close_reason":"Audit complete. Found 2 issues:\n\n1. [P1 bug] story-g7ym: VLMJudge receives invalid enable_logging kwarg - will cause TypeError at runtime\n2. [P3 cleanup] story-gzxw: Duplicate 'import sys' in spread_illustrator\n\nOverall assessment: Illustration generation code is well-structured. Key patterns are centralized in types.py (name matching, prompt building) and config/image.py (client/model/config). Clear SRP separation between SpreadIllustrator, CharacterSheetGenerator, ImageQA, and VLMJudge. QA retry loop is appropriately simple. The only significant issue is the P1 bug with the mismatched constructor signature."}
{"id":"story-ht4","title":"Audit SpreadIllustrator for dead code","description":"Review backend/core/modules/spread_illustrator.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:26.96626-08:00","updated_at":"2025-12-26T15:39:12.790245-08:00","closed_at":"2025-12-26T15:39:12.790245-08:00"}
{"id":"story-hy9l","title":"Fix: StoryOutline dead fields","description":"**Issue**: StoryOutline dataclass has fields explicitly marked as unused.\n\n**Location**: `backend/core/types.py` lines 216-228\n\n**Dead fields**:\n- `characters: str` - comment says 'Not used in story-first workflow' (line 186 in story_generator.py)\n- `plot_summary: str` - same\n- `spread_breakdown: str` - same, plus `get_spreads()` method is dead code\n\n**Note**: `setting: str` IS still used for illustration prompts.\n\n**Proposed fix**:\nOption A (Conservative): Add deprecation comments, leave for backwards compatibility\nOption B (Clean): Remove dead fields, update all usages\n\n**Investigation needed**:\n1. Check if outline is serialized to DB (may need migration)\n2. Check if any tests depend on these fields\n3. Check CLI output formatting\n\n**Complexity**: Medium - need to trace all usages","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:38:46.125123632Z","created_by":"kavin","updated_at":"2026-01-03T21:40:18.722163064Z","closed_at":"2026-01-03T21:40:18.722163064Z","close_reason":"Refactored StoryOutline to StoryMetadata - removed dead fields, updated 14 files, all 98 tests pass. Committed as 95ffbba."}
{"id":"story-i18e","title":"Integrate caching in story reader with progress indicator","description":"Integrate StoryCacheManager into the story reader to trigger background caching and show progress indicator.\n\n## Scope\n\n- Modify `frontend/app/read/[id].tsx`:\n  - Trigger `cacheStory()` when story loads\n  - Show \"Saving for offline...\" indicator during caching\n  - Track caching state\n\n## Implementation\n\n```typescript\n// frontend/app/read/[id].tsx\n\nimport { StoryCacheManager } from '@/lib/story-cache';\n\nexport default function StoryReader() {\n  const { id } = useLocalSearchParams\u003c{ id: string }\u003e();\n  const { data: story, isLoading, error } = useStory(id);\n  const [isCaching, setIsCaching] = useState(false);\n  const [isCached, setIsCached] = useState(false);\n  \n  // Check if already cached on mount\n  useEffect(() =\u003e {\n    if (id) {\n      StoryCacheManager.isStoryCached(id).then(setIsCached);\n    }\n  }, [id]);\n  \n  // Trigger background caching when story loads\n  useEffect(() =\u003e {\n    if (story?.is_illustrated \u0026\u0026 story.status === 'completed' \u0026\u0026 !isCached) {\n      setIsCaching(true);\n      StoryCacheManager.cacheStory(story)\n        .then(success =\u003e {\n          setIsCached(success);\n          setIsCaching(false);\n        })\n        .catch(() =\u003e {\n          setIsCaching(false);\n        });\n    }\n  }, [story?.id, story?.is_illustrated, story?.status, isCached]);\n  \n  // ... existing render logic ...\n  \n  return (\n    \u003cView style={{ flex: 1 }}\u003e\n      {/* Existing story content */}\n      \n      {/* Caching indicator - subtle, bottom of screen */}\n      {isCaching \u0026\u0026 (\n        \u003cView style={{\n          position: 'absolute',\n          bottom: 20,\n          left: 0,\n          right: 0,\n          alignItems: 'center',\n        }}\u003e\n          \u003cView style={{\n            backgroundColor: 'rgba(0,0,0,0.7)',\n            paddingHorizontal: 16,\n            paddingVertical: 8,\n            borderRadius: 20,\n            flexDirection: 'row',\n            alignItems: 'center',\n          }}\u003e\n            \u003cActivityIndicator size=\"small\" color=\"white\" /\u003e\n            \u003cText style={{\n              color: 'white',\n              marginLeft: 8,\n              fontSize: 14,\n              fontFamily: fontFamily.nunito,\n            }}\u003e\n              Saving for offline...\n            \u003c/Text\u003e\n          \u003c/View\u003e\n        \u003c/View\u003e\n      )}\n    \u003c/View\u003e\n  );\n}\n```\n\n## Test Strategy\n\n```typescript\n// E2E test (Playwright)\n// frontend/__tests__/e2e/story-caching.spec.ts\n\ntest('story reader shows caching indicator and caches story', async ({ page }) =\u003e {\n  // Navigate to a story\n  await page.goto('/read/test-story-id');\n  \n  // Should show caching indicator\n  await expect(page.getByText('Saving for offline')).toBeVisible();\n  \n  // Wait for caching to complete (may take up to 30s for 12 images)\n  await expect(page.getByText('Saving for offline')).not.toBeVisible({ timeout: 60000 });\n});\n\ntest('cached story does not show caching indicator', async ({ page }) =\u003e {\n  // First visit - cache the story\n  await page.goto('/read/test-story-id');\n  await expect(page.getByText('Saving for offline')).not.toBeVisible({ timeout: 60000 });\n  \n  // Navigate away and back\n  await page.goto('/');\n  await page.goto('/read/test-story-id');\n  \n  // Should not show indicator (already cached)\n  await expect(page.getByText('Saving for offline')).not.toBeVisible();\n});\n```\n\n## Verification\n\n- E2E tests pass\n- Manual: Open story, see indicator, verify it disappears when done\n- Manual: Close app, enable airplane mode, reopen, story loads from cache\n\n## Files\n\n- `frontend/app/read/[id].tsx` (MODIFY)\n- `frontend/__tests__/e2e/story-caching.spec.ts` (NEW)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:35:34.967523514Z","created_by":"kavin","updated_at":"2026-01-04T22:24:36.884996385Z","closed_at":"2026-01-04T22:24:36.884996385Z","close_reason":"Integrated StoryCacheManager into story reader (app/read/[id].tsx). Added isCaching/isCached state, checks cache on mount, triggers background caching for illustrated stories, shows 'Saving for offline...' indicator. All tests pass.","dependencies":[{"issue_id":"story-i18e","depends_on_id":"story-olko","type":"blocks","created_at":"2026-01-04T21:35:55.644579595Z","created_by":"daemon"}],"comments":[{"id":14,"issue_id":"story-i18e","author":"kavin","text":"**Implementation note:** Prevent race condition on rapid re-entry. Add `!isCaching` to the condition:\n\n```typescript\nuseEffect(() =\u003e {\n  if (story?.is_illustrated \u0026\u0026 story.status === 'completed' \u0026\u0026 !isCached \u0026\u0026 !isCaching) {\n    setIsCaching(true);\n    // ... rest of caching logic\n  }\n}, [story?.id, story?.is_illustrated, story?.status, isCached, isCaching]);\n```\n\nWithout this, if a user exits and re-enters a story before caching completes, a second download would start.","created_at":"2026-01-04T21:40:16Z"}]}
{"id":"story-i1l","title":"Create story generator program","description":"Compose modules into StoryGenerator program with quality loop in src/programs/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:17.083057-08:00","updated_at":"2025-12-11T09:46:51.513857-08:00","closed_at":"2025-12-11T09:46:51.513857-08:00","dependencies":[{"issue_id":"story-i1l","depends_on_id":"story-1o4","type":"blocks","created_at":"2025-12-11T09:39:12.318016-08:00","created_by":"kavinstewart"},{"issue_id":"story-i1l","depends_on_id":"story-s7t","type":"blocks","created_at":"2025-12-11T09:39:17.468885-08:00","created_by":"kavinstewart"}]}
{"id":"story-i4zq","title":"Use native UUID type for stories.id","description":"Currently using VARCHAR(36) which is inefficient and has no validation. PostgreSQL's native UUID type is 16 bytes vs 36 bytes for string, validates format on insert, and is more efficient for indexing.\n\nSteps:\n1. Create migration to ALTER COLUMN stories.id TYPE UUID USING id::uuid\n2. Update all foreign keys (story_spreads.story_id, character_references.story_id, vlm_evaluations.story_id) to UUID type\n3. Update repository.py if any explicit type casts are needed\n4. Run migration against dev database\n5. Run full test suite (pytest tests/)\n6. Manually test: create story, view story, check images load","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T21:39:24.419971114Z","created_by":"kavin","updated_at":"2025-12-30T21:55:31.338277862Z","closed_at":"2025-12-30T21:55:31.338277862Z","close_reason":"Migration 001 implemented and all tests pass. UUID type now used for stories.id and all foreign keys."}
{"id":"story-iaj","title":"Move scripts/ to cli/ using git mv","description":"Use git mv to rename scripts/ directory to cli/. Contains generate_story.py, debug_page.py, run_api.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:13.68377-08:00","updated_at":"2025-12-18T08:20:01.896751-08:00","closed_at":"2025-12-18T08:20:01.896751-08:00","dependencies":[{"issue_id":"story-iaj","depends_on_id":"story-3y8","type":"blocks","created_at":"2025-12-18T07:33:11.764185-08:00","created_by":"kavinstewart"}]}
{"id":"story-isv","title":"Update frontend for spread-based stories","description":"Update lib/api.ts types (StoryPage ‚Üí StorySpread). Update reader screen to display spreads. Update page navigation for 12 spreads.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:38:49.396459-08:00","updated_at":"2025-12-18T15:00:56.205855-08:00","closed_at":"2025-12-18T15:00:56.205855-08:00","dependencies":[{"issue_id":"story-isv","depends_on_id":"story-617","type":"blocks","created_at":"2025-12-18T14:42:53.007192-08:00","created_by":"kavinstewart"}]}
{"id":"story-j0y6","title":"Decide VLM evaluation criteria and feedback capture approach","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:35:14.327624465Z","created_by":"kavin","updated_at":"2026-01-03T22:35:14.327624465Z"}
{"id":"story-j2fn","title":"E2E tests fail: blank page renders","description":"## Problem\nAll 7 Playwright E2E tests fail because the frontend renders a completely blank/white page instead of the app UI.\n\n## Evidence\n- Screenshot from failed test shows empty white page (no content at all)\n- Tests timeout waiting for elements like \"New Story\" button, \"My Story Library\" header\n- All 7 tests in `frontend/e2e/` fail with same symptom\n\n## Test Output\n```\nRunning 7 tests using 1 worker\n‚úò 1 [chromium] ‚Ä∫ e2e/story-creation.spec.ts:29:7 ‚Ä∫ Story Creation ‚Ä∫ should create a story...\n‚úò 2-7 [chromium] ‚Ä∫ e2e/story-library.spec.ts - all tests fail\n\nError: locator.click: Test timeout exceeded\n- waiting for getByText('+ New Story')\n```\n\n## Environment Verified\n- API health check passes: `curl localhost:8000/health` returns `{\"status\":\"healthy\"}`\n- Dev server responds: `curl localhost:3000` returns 200\n- APP_PIN is configured in `.env`\n- Login function in tests correctly reads APP_PIN and attempts authentication\n\n## Likely Causes\n1. JavaScript error during React Native/Expo web initialization\n2. API URL misconfiguration in frontend (can't reach backend)\n3. Expo web build issue\n4. Missing environment variable the app needs at runtime\n\n## Key Files\n- `frontend/e2e/story-library.spec.ts` - Test file with login helper\n- `frontend/e2e/story-creation.spec.ts` - Another failing test\n- `frontend/app/` - Expo Router screens\n- `frontend/playwright.config.ts` - Playwright config (uses port 3000)\n\n## Reproduction\n```bash\ncd frontend\nnpx playwright test --headed  # Watch the blank page\n```\n\n## Screenshots\nTest failure screenshots saved to: `frontend/test-results/*/test-failed-1.png`","status":"closed","priority":0,"issue_type":"bug","created_at":"2026-01-03T21:47:02.807995828Z","created_by":"kavin","updated_at":"2026-01-03T22:04:29.530819861Z","closed_at":"2026-01-03T22:04:29.530819861Z","close_reason":"Fixed: Missing react-refresh dependency caused Metro bundler to fail, resulting in blank page. All 7 E2E tests now pass.","dependencies":[{"issue_id":"story-j2fn","depends_on_id":"story-96n9","type":"blocks","created_at":"2026-01-03T21:47:20.261470408Z","created_by":"daemon"}]}
{"id":"story-j6sd","title":"Audit: Background Worker (ARQ)","description":"**Code Path**: backend/worker.py and related\n\n**Files to examine**:\n- backend/worker.py\n- backend/api/arq_pool.py\n- backend/api/services/story_generation.py (worker integration)\n- backend/api/services/spread_regeneration.py (worker integration)\n\n**Investigation goals**:\n1. Look for duplicated task/job management patterns\n2. Check for duplicated pool initialization logic\n3. Identify non-KISS complexity in task wrappers\n4. Look for duplicated cleanup/lifecycle logic\n5. Check for SRP violations in worker configuration\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:38.730205311Z","created_by":"kavin","updated_at":"2026-01-03T19:28:38.730205311Z"}
{"id":"story-j79","title":"Add QA dependencies (t2v-metrics, torch)","description":"Add t2v-metrics for VQAScore and torch for model inference","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:48:07.941828-08:00","updated_at":"2025-12-16T12:05:00.588758-08:00","closed_at":"2025-12-16T12:05:00.588758-08:00"}
{"id":"story-jht","title":"Audit CharacterExtractor for dead code","description":"Review backend/core/modules/character_extractor.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:26:55.665124-08:00","updated_at":"2025-12-26T15:39:12.788377-08:00","closed_at":"2025-12-26T15:39:12.788377-08:00"}
{"id":"story-jpug","title":"Migrate image storage to Cloudflare R2","description":"Migrate image storage and serving from current implementation to Cloudflare R2. This includes:\n- Configuring R2 client with credentials\n- Updating image upload logic to store in R2\n- Updating image serving/URLs to use R2\n- Migration path for existing images (if any)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T00:24:12.768346375Z","created_by":"kavin","updated_at":"2026-01-04T00:24:12.768346375Z","dependencies":[{"issue_id":"story-jpug","depends_on_id":"story-ton3","type":"blocks","created_at":"2026-01-04T00:24:42.740637706Z","created_by":"daemon"}]}
{"id":"story-jqk","title":"Create login screen","description":"Create frontend/app/login.tsx with PIN input, submit button. Call /auth/login, store token, navigate to home on success.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:17.058604385Z","created_by":"kavin","updated_at":"2025-12-29T01:37:13.958404048Z","closed_at":"2025-12-29T01:37:13.958404048Z","close_reason":"Created login.tsx with PIN entry screen","dependencies":[{"issue_id":"story-jqk","depends_on_id":"story-e8q","type":"blocks","created_at":"2025-12-29T01:30:34.318159318Z","created_by":"daemon"},{"issue_id":"story-jqk","depends_on_id":"story-up5","type":"blocks","created_at":"2025-12-29T01:30:34.331409524Z","created_by":"daemon"}]}
{"id":"story-kbb","title":"Create reusable animation components","description":"Build FloatingElement, BobbingCharacter, MagicParticles, Firefly components using react-native-reanimated. These will be composed in both screens.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T11:17:32.350694-08:00","updated_at":"2025-12-19T11:23:09.801515-08:00","closed_at":"2025-12-19T11:23:09.801515-08:00","dependencies":[{"issue_id":"story-kbb","depends_on_id":"story-qvx","type":"blocks","created_at":"2025-12-19T11:17:55.5737-08:00","created_by":"kavinstewart"}]}
{"id":"story-kg22","title":"Add edit button to read screen top bar","description":"Add pencil button to the top bar that opens the edit overlay.\n\n## Location\nIn `read/[id].tsx`, add after the progress indicator (around line 256):\n\n```typescript\n{!showEndScreen \u0026\u0026 (\n  \u003cPressable\n    onPress={() =\u003e setEditingSpreadNumber(currentSpread)}\n    style={{\n      backgroundColor: '#FAF7F2',\n      paddingVertical: 16,\n      paddingHorizontal: 22,\n      borderRadius: 22,\n      borderWidth: 2,\n      borderColor: '#EDE8E0',\n      // ... shadow styles matching home button\n    }}\n  \u003e\n    \u003cText style={{ fontSize: 32 }}\u003e‚úèÔ∏è\u003c/Text\u003e\n  \u003c/Pressable\u003e\n)}\n```\n\n## State Addition\n```typescript\nconst [editingSpreadNumber, setEditingSpreadNumber] = useState\u003cnumber | null\u003e(null);\n```\n\n## Files\n- `frontend/app/read/[id].tsx`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:43:12.290470677Z","created_by":"kavin","updated_at":"2026-01-03T16:20:01.234383104Z","closed_at":"2026-01-03T16:20:01.234383104Z","close_reason":"Already implemented - edit button exists in read/[id].tsx:260-270, navigates to /edit-prompt","dependencies":[{"issue_id":"story-kg22","depends_on_id":"story-uzi9","type":"blocks","created_at":"2026-01-01T17:43:58.405637816Z","created_by":"daemon"}]}
{"id":"story-knsv","title":"Merge isCached and cachedStory into single atomic state","description":"In read/[id].tsx lines 26-28:\n- isCached and cachedStory are set separately\n- Creates window where isCached=true but cachedStory=null\n- getImageUrl() uses isCached to decide file:// vs server URL\n- If cachedStory is null during this window, story comes from networkStory with server URLs ‚Üí mismatch\n\nFix: Use single state object updated atomically:\nconst [cacheState, setCacheState] = useState({\n  isCached: false,\n  story: null,\n  checkComplete: false\n});","status":"closed","priority":1,"issue_type":"bug","estimated_minutes":15,"created_at":"2026-01-05T04:20:38.327439605Z","created_by":"kavin","updated_at":"2026-01-05T04:44:31.507829367Z","closed_at":"2026-01-05T04:44:31.507829367Z","close_reason":"Merged isCached, cacheCheckComplete, and cachedStory into single atomic CacheState object to prevent inconsistent reads","dependencies":[{"issue_id":"story-knsv","depends_on_id":"story-2xzc","type":"blocks","created_at":"2026-01-05T04:20:38.336484734Z","created_by":"daemon"}]}
{"id":"story-kt54","title":"Remove debug console.log statements","description":"27+ console.log statements scattered throughout:\n- cache-storage.ts\n- cache-files.ts  \n- story-cache.ts\n- read/[id].tsx (including render logging on every cycle)\n\nThese are debug remnants that pollute test output and logs.\n\nRemove after other fixes are complete - the logs are useful during the fixing process.","status":"open","priority":3,"issue_type":"chore","estimated_minutes":10,"created_at":"2026-01-05T04:21:15.319344983Z","created_by":"kavin","updated_at":"2026-01-05T04:21:15.319344983Z","dependencies":[{"issue_id":"story-kt54","depends_on_id":"story-o2bw","type":"blocks","created_at":"2026-01-05T04:21:15.325369681Z","created_by":"daemon"}]}
{"id":"story-kys","title":"Create CLI entry point","description":"Build scripts/generate_story.py with argument parsing for goal input and story output","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:30.244262-08:00","updated_at":"2025-12-11T13:56:43.962501-08:00","closed_at":"2025-12-11T13:56:43.962501-08:00","dependencies":[{"issue_id":"story-kys","depends_on_id":"story-ffw","type":"blocks","created_at":"2025-12-11T09:38:54.17516-08:00","created_by":"kavinstewart"},{"issue_id":"story-kys","depends_on_id":"story-i1l","type":"blocks","created_at":"2025-12-11T09:39:23.938922-08:00","created_by":"kavinstewart"}]}
{"id":"story-kz6","title":"Create auth storage utilities","description":"Create frontend/lib/auth-storage.ts with setToken(), getToken(), clearToken() functions using AsyncStorage.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:14.397451368Z","created_by":"kavin","updated_at":"2025-12-29T01:33:55.366655663Z","closed_at":"2025-12-29T01:33:55.366655663Z","close_reason":"Created frontend/lib/auth-storage.ts with token persistence","dependencies":[{"issue_id":"story-kz6","depends_on_id":"story-r68","type":"blocks","created_at":"2025-12-29T01:30:34.277491335Z","created_by":"daemon"}]}
{"id":"story-la13","title":"Remove SQLite remnants","description":"Clean up leftover SQLite references after PostgreSQL migration.\n\n## Files to Change\n1. pyproject.toml - Remove aiosqlite dependency\n2. backend/api/config.py - Remove SQLITE_DB_PATH constant (lines 24-25)\n3. tests/unit/conftest.py - Remove SQLITE_DB_PATH monkeypatch (line 59)\n4. README.md - Update references to mention PostgreSQL instead of SQLite (lines 147, 170)\n5. cli/run_vlm_qa.py - Convert to PostgreSQL or deprecate/remove\n6. .gitignore - Add *.db pattern to prevent SQLite file commits\n\n## Post-Cleanup\n7. Run 'poetry lock --no-update' to regenerate lock file cleanly\n8. Run 'poetry show --tree' to verify no orphaned transitive deps\n9. Back up and remove data/stories.db (confirm migration complete first)\n\n## Archive Decision\n- cli/migrate_to_postgres.py - Add deprecation header OR move to scripts/archive/\n\n## Notes\n- .beads/ references are just issue history, leave alone\n- .beads/beads.db is the bead tool's own database, not ours\n- No aiosqlite imports found in codebase (verified)\n- No .env.example file to update\n\n## Expert Review\n- Simon Willison: Handle orphaned db file, gitignore pattern, archive migration script\n- Armin Ronacher: Regenerate poetry.lock, check transitive deps\n- Sebasti√°n Ram√≠rez: Verified no SQLite URL parsing in config.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T23:56:42.459749853Z","created_by":"kavin","updated_at":"2025-12-30T00:16:33.831173855Z","closed_at":"2025-12-30T00:16:33.831173855Z","close_reason":"SQLite cleanup complete: removed aiosqlite dep, SQLITE_DB_PATH config, updated docs, deprecated CLI scripts, added *.db to gitignore, deleted old database file"}
{"id":"story-lbg","title":"Hardcode generation defaults in story service","description":"Update StoryService to hardcode the removed API parameters internally:\n- generation_type: 'illustrated'\n- target_age_range: '4-7'  \n- quality_threshold: 7\n- max_attempts: 3\n\nThese become implementation details, not API concerns. The StoryGenerator and CLI can still accept these parameters for testing/development.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:04:22.998951-08:00","updated_at":"2025-12-26T16:10:12.094343-08:00","closed_at":"2025-12-26T16:10:12.094343-08:00","dependencies":[{"issue_id":"story-lbg","depends_on_id":"story-6f5","type":"blocks","created_at":"2025-12-26T16:04:43.306971-08:00","created_by":"kavinstewart"}]}
{"id":"story-lxd","title":"Create FullStorySignature for single-call generation","description":"New DSPy signature that generates all 12 spreads in one LLM call. Include page-turn guidance. Output format: Spread 1: [text] through Spread 12: [text]. 300-400 words total.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:37:50.882852-08:00","updated_at":"2025-12-18T14:48:03.223359-08:00","closed_at":"2025-12-18T14:48:03.223359-08:00","dependencies":[{"issue_id":"story-lxd","depends_on_id":"story-rho","type":"blocks","created_at":"2025-12-18T14:40:48.280267-08:00","created_by":"kavinstewart"}]}
{"id":"story-ly0h","title":"Create spread_regen_jobs table and repository methods","description":"Add database table to track spread regeneration jobs.\n\n## Schema\n```sql\nCREATE TABLE IF NOT EXISTS spread_regen_jobs (\n    id VARCHAR(8) PRIMARY KEY,\n    story_id UUID NOT NULL REFERENCES stories(id) ON DELETE CASCADE,\n    spread_number INTEGER NOT NULL,\n    status VARCHAR(20) NOT NULL DEFAULT 'pending',\n    progress_json JSONB,\n    error_message TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    started_at TIMESTAMPTZ,\n    completed_at TIMESTAMPTZ,\n    FOREIGN KEY (story_id, spread_number) REFERENCES story_spreads(story_id, spread_number)\n);\n```\n\n## Repository Methods\n- `create_spread_regen_job()`\n- `update_spread_regen_status()`\n- `get_spread_regen_job()`\n- `save_regenerated_spread()`\n\n## Files\n- `backend/api/database/schema.sql`\n- `backend/api/database/repository.py`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:42:24.386278408Z","created_by":"kavin","updated_at":"2026-01-03T16:19:51.653725354Z","closed_at":"2026-01-03T16:19:51.653725354Z","close_reason":"Already implemented - spread_regen_jobs table and all repository methods exist"}
{"id":"story-lyk","title":"Audit frontend Creating screen for dead code","description":"Review frontend/app/creating/[id].tsx looking for redundant and/or dead code. Check for unused imports, deprecated patterns, and unused functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:11.897765-08:00","updated_at":"2025-12-26T15:39:12.796644-08:00","closed_at":"2025-12-26T15:39:12.796644-08:00"}
{"id":"story-m3r","title":"Create single-shot story generator signature","description":"Create a new signature that generates a complete story (title, setting, 12 spreads with text) in one LLM call. Input: goal + reference examples. Output: title, setting, spreads. No separate outline phase - let the model figure out characters/plot organically.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T19:43:57.146019-08:00","updated_at":"2025-12-19T20:07:25.252428-08:00","closed_at":"2025-12-19T20:07:25.252428-08:00","dependencies":[{"issue_id":"story-m3r","depends_on_id":"story-tyw","type":"blocks","created_at":"2025-12-19T19:44:38.741136-08:00","created_by":"kavinstewart"}]}
{"id":"story-mec","title":"Add auth routing to _layout.tsx","description":"Modify frontend/app/_layout.tsx to hydrate auth on startup, redirect to login if no token, show main app if authenticated.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:18.927854647Z","created_by":"kavin","updated_at":"2025-12-29T01:37:48.717117997Z","closed_at":"2025-12-29T01:37:48.717117997Z","close_reason":"Added AuthGate component with hydration and routing logic","dependencies":[{"issue_id":"story-mec","depends_on_id":"story-jqk","type":"blocks","created_at":"2025-12-29T01:30:34.344389995Z","created_by":"daemon"},{"issue_id":"story-mec","depends_on_id":"story-6v8","type":"blocks","created_at":"2025-12-29T01:30:34.359411031Z","created_by":"daemon"}]}
{"id":"story-mgx","title":"Create Pydantic models","description":"Create src/api/models/ with requests.py and responses.py","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T11:23:51.161487-08:00","updated_at":"2025-12-17T11:26:58.107461-08:00","closed_at":"2025-12-17T11:26:58.107461-08:00","dependencies":[{"issue_id":"story-mgx","depends_on_id":"story-9r7","type":"blocks","created_at":"2025-12-17T11:24:28.65635-08:00","created_by":"kavinstewart"}]}
{"id":"story-mom5","title":"Fix: Remove unused outline-first signatures","description":"**Issue**: Dead code from deprecated outline-first workflow.\n\n**Files to remove or deprecate**:\n- `backend/core/signatures/story_outline.py` - StoryOutlineSignature unused\n- `backend/core/signatures/full_story.py` - FullStorySignature, FullStoryWithPromptsSignature unused\n\n**Evidence**: \n- CLAUDE.md documents 'story-first workflow' as current approach\n- story_generator.py uses DirectStorySignature, not these\n- No imports of these signatures found in active code\n\n**Proposed fix**:\n1. Verify no active code imports these signatures (grep codebase)\n2. If truly unused, delete the files entirely\n3. Update `__init__.py` if needed\n\n**Risk**: Low - but verify with grep first\n\n**Complexity**: Low","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:38:45.127258719Z","created_by":"kavin","updated_at":"2026-01-03T20:55:19.428524994Z","closed_at":"2026-01-03T20:55:19.428524994Z","close_reason":"Removed deprecated outline-first workflow code.\n\nDeleted files:\n- backend/core/modules/outline_generator.py\n- backend/core/modules/spread_generator.py\n- backend/core/signatures/story_outline.py\n- backend/core/signatures/full_story.py\n\nUpdated:\n- backend/core/modules/__init__.py - removed legacy exports\n- backend/core/signatures/__init__.py - removed legacy exports\n- backend/core/modules/spread_illustrator.py - fixed stale OutlineGenerator reference\n\nTotal: 4 files deleted, ~200 lines of dead code removed.\nAll 98 unit tests pass."}
{"id":"story-n04x","title":"Implement cache index storage layer","description":"Create AsyncStorage wrapper for the story cache index. This is the persistence layer for tracking which stories are cached.\n\n## Scope\n\n- Create `frontend/lib/cache-storage.ts`\n- Implement CRUD operations for cache index\n- Follow pattern from `frontend/lib/auth-storage.ts`\n\n## Implementation\n\n```typescript\n// frontend/lib/cache-storage.ts\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\nconst CACHE_INDEX_KEY = 'story_cache_index';\n\nexport interface CacheEntry {\n  cachedAt: number;\n  lastRead: number;\n  sizeBytes: number;\n  spreadCount: number;\n  title: string;\n}\n\nexport type CacheIndex = Record\u003cstring, CacheEntry\u003e;\n\nexport const cacheStorage = {\n  getIndex: async (): Promise\u003cCacheIndex\u003e =\u003e {\n    const raw = await AsyncStorage.getItem(CACHE_INDEX_KEY);\n    return raw ? JSON.parse(raw) : {};\n  },\n  \n  setStoryEntry: async (storyId: string, entry: CacheEntry): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    index[storyId] = entry;\n    await AsyncStorage.setItem(CACHE_INDEX_KEY, JSON.stringify(index));\n  },\n  \n  updateLastRead: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    if (index[storyId]) {\n      index[storyId].lastRead = Date.now();\n      await AsyncStorage.setItem(CACHE_INDEX_KEY, JSON.stringify(index));\n    }\n  },\n  \n  removeStoryEntry: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    delete index[storyId];\n    await AsyncStorage.setItem(CACHE_INDEX_KEY, JSON.stringify(index));\n  },\n  \n  clearIndex: async (): Promise\u003cvoid\u003e =\u003e {\n    await AsyncStorage.removeItem(CACHE_INDEX_KEY);\n  },\n};\n```\n\n## Test Strategy\n\n```typescript\n// frontend/__tests__/lib/cache-storage.test.ts\nimport { cacheStorage } from '@/lib/cache-storage';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\njest.mock('@react-native-async-storage/async-storage');\n\ndescribe('cache-storage', () =\u003e {\n  beforeEach(() =\u003e {\n    jest.clearAllMocks();\n  });\n\n  it('returns empty object when no index exists', async () =\u003e {\n    (AsyncStorage.getItem as jest.Mock).mockResolvedValue(null);\n    const index = await cacheStorage.getIndex();\n    expect(index).toEqual({});\n  });\n  \n  it('persists story entry and retrieves it', async () =\u003e {\n    let stored: string | null = null;\n    (AsyncStorage.getItem as jest.Mock).mockImplementation(() =\u003e Promise.resolve(stored));\n    (AsyncStorage.setItem as jest.Mock).mockImplementation((_, v) =\u003e { stored = v; return Promise.resolve(); });\n    \n    await cacheStorage.setStoryEntry('abc-123', {\n      cachedAt: 1000,\n      lastRead: 1000,\n      sizeBytes: 5000000,\n      spreadCount: 12,\n      title: 'Test Story'\n    });\n    \n    const index = await cacheStorage.getIndex();\n    expect(index['abc-123']).toBeDefined();\n    expect(index['abc-123'].title).toBe('Test Story');\n  });\n  \n  it('removes story entry', async () =\u003e {\n    // ... test implementation\n  });\n  \n  it('clearIndex removes all entries', async () =\u003e {\n    // ... test implementation\n  });\n});\n```\n\n## Verification\n\n- Unit tests pass: `cd frontend \u0026\u0026 npm test cache-storage`\n- No integration yet‚Äîpure storage primitive\n\n## Files\n\n- `frontend/lib/cache-storage.ts` (NEW)\n- `frontend/__tests__/lib/cache-storage.test.ts` (NEW)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:32:46.282733791Z","created_by":"kavin","updated_at":"2026-01-04T21:52:39.804472103Z","closed_at":"2026-01-04T21:52:39.804472103Z","close_reason":"Created frontend/lib/cache-storage.ts with AsyncStorage wrapper for cache index. Added 18 unit tests in __tests__/lib/cache-storage.test.ts. All tests pass.","dependencies":[{"issue_id":"story-n04x","depends_on_id":"story-slt4","type":"blocks","created_at":"2026-01-04T21:33:23.745812517Z","created_by":"daemon"}],"comments":[{"id":10,"issue_id":"story-n04x","author":"kavin","text":"**Implementation note:** Use the existing import path conventions in the codebase (likely `@/lib/...` aliases). Check `tsconfig.json` or existing imports in `lib/auth-storage.ts` for the correct pattern.","created_at":"2026-01-04T21:39:50Z"}]}
{"id":"story-n8l8","title":"Fix memory leak in async IIFE","description":"In story-cache.ts cacheStory(), the async IIFE (lines 51-121) can throw before the finally block runs, leaving the promise in cachingInProgress map forever. Subsequent cache attempts for that story will hang indefinitely.\n\nFix: Ensure finally block ALWAYS executes by wrapping entire IIFE body in try/catch, or restructure to use explicit promise handling.","status":"closed","priority":1,"issue_type":"bug","estimated_minutes":10,"created_at":"2026-01-05T04:20:01.377809932Z","created_by":"kavin","updated_at":"2026-01-05T04:36:23.02463144Z","closed_at":"2026-01-05T04:36:23.02463144Z","close_reason":"Refactored to self-contained async IIFE that always resolves. Removed deferred promise pattern.","dependencies":[{"issue_id":"story-n8l8","depends_on_id":"story-tbus","type":"blocks","created_at":"2026-01-05T04:20:01.385677401Z","created_by":"daemon"}]}
{"id":"story-nav","title":"Audit database layer for dead code","description":"Review backend/api/database/db.py looking for redundant and/or dead code. Check for unused schema, deprecated columns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:39.475613-08:00","updated_at":"2025-12-26T15:39:12.793102-08:00","closed_at":"2025-12-26T15:39:12.793102-08:00"}
{"id":"story-ndrj","title":"Fix offline cache: derive file:// URLs at render time","description":"Stop storing file:// URLs in cached metadata. Use isCached flag + getSpreadPath() to compute URLs at render time. Removes race condition where stale file:// URLs are used before files exist.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-05T00:49:49.996903079Z","created_by":"kavin","updated_at":"2026-01-05T00:53:33.987992247Z","closed_at":"2026-01-05T00:53:33.987992247Z","close_reason":"Fixed: file:// URLs now computed at render time via getImageUrl() helper using isCached flag + getSpreadPath(). Removed hydrateQueryClient and transformStoryUrls - React Query only contains server URLs now."}
{"id":"story-ng3","title":"Create async database connection module","description":"Replace sqlite connection.py with async SQLAlchemy engine using asyncpg for PostgreSQL","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:04.533684517Z","created_by":"kavin","updated_at":"2025-12-29T14:57:36.435719574Z","closed_at":"2025-12-29T14:57:36.435719574Z","close_reason":"Created async SQLAlchemy engine with asyncpg","dependencies":[{"issue_id":"story-ng3","depends_on_id":"story-5vv","type":"blocks","created_at":"2025-12-29T14:44:09.985392617Z","created_by":"daemon"}]}
{"id":"story-nln2","title":"Audit: Frontend Components","description":"**Code Path**: frontend/components/\n\n**Files to examine**:\n- frontend/components/StoryCard.tsx\n- frontend/components/StageIcon.tsx\n- frontend/components/BobbingCharacter.tsx\n- frontend/components/CompletePop.tsx\n- frontend/components/MagicParticles.tsx\n- frontend/components/FloatingElement.tsx\n- All other component files\n\n**Investigation goals**:\n1. Look for duplicated animation/styling patterns\n2. Check for duplicated component structure\n3. Identify non-KISS complexity in individual components\n4. Look for components that could be consolidated or simplified\n5. Check for SRP violations (components doing too much)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:45.072044236Z","created_by":"kavin","updated_at":"2026-01-03T19:28:45.072044236Z"}
{"id":"story-nq6d","title":"Remove VLM eval admin routes scaffolding","description":"Remove incomplete/non-functional admin routes (backend/api/routes/admin.py). The VLM eval annotation feature was scaffolded but never wired up properly. Remove until we make decisions in story-j0y6.\n\nFiles to remove/modify:\n- backend/api/routes/admin.py - delete entirely\n- backend/api/routes/__init__.py - remove admin router registration if present\n- backend/api/dependencies.py - remove VLMEvalRepo if unused elsewhere","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T00:12:53.742360305Z","created_by":"kavin","updated_at":"2026-01-04T00:17:02.505510001Z","closed_at":"2026-01-04T00:17:02.505510001Z","close_reason":"Removed admin.py, updated main.py and routes/__init__.py"}
{"id":"story-nwa","title":"Implement StoryCreation screen","description":"Port story-creation.jsx to app/creating/[id].tsx. Animated wizard emoji, stage progression, progress bar, poll job status via TanStack Query","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:30.605268-08:00","updated_at":"2025-12-18T09:15:22.679779-08:00","closed_at":"2025-12-18T09:15:22.679779-08:00","dependencies":[{"issue_id":"story-nwa","depends_on_id":"story-gpk","type":"blocks","created_at":"2025-12-18T08:53:26.520922-08:00","created_by":"kavinstewart"},{"issue_id":"story-nwa","depends_on_id":"story-5bx","type":"blocks","created_at":"2025-12-18T08:53:31.674669-08:00","created_by":"kavinstewart"}]}
{"id":"story-nxhx","title":"Implement ARQ task queue for story generation","description":"Replace ThreadPoolExecutor with ARQ (Redis-based async task queue) to fix event loop conflicts in background story generation. This is the parent epic for the ARQ migration.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-29T22:23:10.018130242Z","created_by":"kavin","updated_at":"2025-12-29T23:49:15.796342246Z","closed_at":"2025-12-29T23:49:15.796342246Z","close_reason":"ARQ task queue fully implemented: worker module, systemd service, StoryService integration, 12 unit tests, 5 integration tests. All passing.","dependencies":[{"issue_id":"story-nxhx","depends_on_id":"story-aeax","type":"blocks","created_at":"2025-12-29T22:23:44.749654093Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-eenf","type":"blocks","created_at":"2025-12-29T22:23:44.769647685Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-6l27","type":"blocks","created_at":"2025-12-29T22:23:44.78547413Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-5oav","type":"blocks","created_at":"2025-12-29T22:23:44.799911848Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-2b1a","type":"blocks","created_at":"2025-12-29T22:23:44.814190046Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-gjiu","type":"blocks","created_at":"2025-12-29T22:23:44.829053915Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-4hf7","type":"blocks","created_at":"2025-12-29T22:33:02.378175698Z","created_by":"daemon"},{"issue_id":"story-nxhx","depends_on_id":"story-v00z","type":"blocks","created_at":"2025-12-29T22:33:02.395843502Z","created_by":"daemon"}]}
{"id":"story-nzep","title":"Remove useRef guard, fix effect dependencies","description":"In read/[id].tsx line 29, cacheTriggeredRef is used to prevent double-trigger from React StrictMode/re-renders.\n\nThis is an anti-pattern that masks incorrectly modeled effect dependencies.\n\nFix: Use proper dependency array with early returns:\nuseEffect(() =\u003e {\n  if (\\!cacheCheckComplete || \\!networkStory || isCached) return;\n  if (networkStory.status \\!== 'completed') return;\n  // No ref needed - dependencies are honest\n  ...\n}, [networkStory, isCached, cacheCheckComplete]);","status":"closed","priority":2,"issue_type":"chore","estimated_minutes":10,"created_at":"2026-01-05T04:20:48.333181544Z","created_by":"kavin","updated_at":"2026-01-05T04:47:28.841352024Z","closed_at":"2026-01-05T04:47:28.841352024Z","close_reason":"Removed cacheTriggeredRef anti-pattern - deduplication handled by StoryCacheManager.cacheStory","dependencies":[{"issue_id":"story-nzep","depends_on_id":"story-knsv","type":"blocks","created_at":"2026-01-05T04:20:48.339701016Z","created_by":"daemon"}]}
{"id":"story-o13s","title":"Implement spread regeneration API endpoint and service","description":"Add POST endpoint to trigger spread illustration regeneration.\n\n## Endpoint\n```\nPOST /stories/{story_id}/spreads/{spread_number}/regenerate\nRequest: { }  (uses existing prompt)\nResponse: { job_id, status: 'pending' }\n```\n\n## Service Logic (spread_regeneration.py)\n1. Validate story exists and has the spread\n2. Create job record in database\n3. Enqueue ARQ task for background processing\n4. Return job_id immediately (202 Accepted)\n\n## ARQ Task\n1. Fetch story + spread + character references\n2. Call `SpreadIllustrator.illustrate_spread()`\n3. Save new image to filesystem (atomic write)\n4. Update `illustration_updated_at` timestamp\n5. Mark job as completed\n\n## Files\n- `backend/api/routes/stories.py` - Add endpoint\n- `backend/api/models/requests.py` - Add request model\n- `backend/api/models/responses.py` - Add response models\n- `backend/api/services/spread_regeneration.py` - New service\n- `backend/api/services/story_service.py` - Add job creation method\n\n## Technical Note: Atomic File Operations\nWrite to temp file, then rename to prevent broken images on failure:\n```python\nwith tempfile.NamedTemporaryFile(delete=False) as tmp:\n    tmp.write(image_bytes)\nshutil.move(tmp.name, target_path)\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:42:37.272174555Z","created_by":"kavin","updated_at":"2026-01-03T16:19:53.243066662Z","closed_at":"2026-01-03T16:19:53.243066662Z","close_reason":"Already implemented - POST /spreads/{n}/regenerate endpoint and service exist in stories.py","dependencies":[{"issue_id":"story-o13s","depends_on_id":"story-ujkc","type":"blocks","created_at":"2026-01-01T17:43:58.343113012Z","created_by":"daemon"},{"issue_id":"story-o13s","depends_on_id":"story-ly0h","type":"blocks","created_at":"2026-01-01T17:43:58.359767394Z","created_by":"daemon"}]}
{"id":"story-o1ql","title":"Update FastAPI dependencies for async DB","description":"Modify get_db and other dependencies to yield async sessions properly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:38.652426462Z","created_by":"kavin","updated_at":"2025-12-29T15:05:13.049370264Z","closed_at":"2025-12-29T15:05:13.049370264Z","close_reason":"Updated dependencies with session injection and VLMEvalRepo","dependencies":[{"issue_id":"story-o1ql","depends_on_id":"story-ng3","type":"blocks","created_at":"2025-12-29T14:44:22.442297469Z","created_by":"daemon"}]}
{"id":"story-o28s","title":"Implement hydration and cache integrity check","description":"Add React Query hydration from cache and cache integrity verification on app startup.\n\n## Scope\n\n- Add to `frontend/lib/story-cache.ts`:\n  - `hydrateQueryClient()` - populate React Query from cache\n  - `verifyCacheIntegrity()` - remove orphaned index entries\n\n## Implementation\n\n```typescript\n// Add to frontend/lib/story-cache.ts\nimport { queryClient } from './query-client';\nimport { storyKeys } from '@/features/stories/hooks';\n\nexport const StoryCacheManager = {\n  // ... existing methods ...\n  \n  verifyCacheIntegrity: async (): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    const orphanedIds: string[] = [];\n    \n    for (const [storyId, entry] of Object.entries(index)) {\n      const valid = await cacheFiles.verifyStoryFiles(storyId, entry.spreadCount);\n      if (!valid) {\n        orphanedIds.push(storyId);\n      }\n    }\n    \n    // Remove orphaned entries\n    for (const storyId of orphanedIds) {\n      console.log(`Removing orphaned cache entry: ${storyId}`);\n      await cacheFiles.deleteStoryDirectory(storyId);\n      await cacheStorage.removeStoryEntry(storyId);\n    }\n    \n    if (orphanedIds.length \u003e 0) {\n      console.log(`Cache integrity check: removed ${orphanedIds.length} orphaned entries`);\n    }\n  },\n  \n  hydrateQueryClient: async (): Promise\u003cvoid\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    const storyIds = Object.keys(index);\n    \n    if (storyIds.length === 0) return;\n    \n    console.log(`Hydrating ${storyIds.length} cached stories`);\n    \n    // Hydrate individual story details lazily - just mark them as available\n    // Full story data loaded on-demand via loadCachedStory\n    for (const storyId of storyIds) {\n      const story = await cacheFiles.loadStoryMetadata(storyId);\n      if (story) {\n        queryClient.setQueryData(storyKeys.detail(storyId), story);\n      }\n    }\n  },\n};\n```\n\n## Integration Point\n\nUpdate `frontend/app/_layout.tsx`:\n\n```typescript\nimport { StoryCacheManager } from '@/lib/story-cache';\n\nfunction AuthGate({ children }: { children: React.ReactNode }) {\n  const { isAuthenticated, isHydrated, hydrate } = useAuthStore();\n  const [cacheReady, setCacheReady] = useState(false);\n\n  useEffect(() =\u003e {\n    hydrate();\n    \n    // Initialize cache after auth hydration\n    (async () =\u003e {\n      await StoryCacheManager.verifyCacheIntegrity();\n      await StoryCacheManager.hydrateQueryClient();\n      setCacheReady(true);\n    })();\n  }, [hydrate]);\n\n  if (!isHydrated || !cacheReady) {\n    return \u003cActivityIndicator /\u003e;\n  }\n\n  return \u003c\u003e{children}\u003c/\u003e;\n}\n```\n\n## Test Strategy\n\n```typescript\ndescribe('hydration', () =\u003e {\n  it('hydrateQueryClient populates story queries', async () =\u003e {\n    await StoryCacheManager.cacheStory(testStory);\n    queryClient.clear();\n    \n    await StoryCacheManager.hydrateQueryClient();\n    \n    const cached = queryClient.getQueryData(storyKeys.detail(testStory.id));\n    expect(cached).toBeDefined();\n    expect(cached.id).toBe(testStory.id);\n  });\n  \n  it('verifyCacheIntegrity removes orphaned entries', async () =\u003e {\n    // Manually add index entry without files\n    await cacheStorage.setStoryEntry('orphan-id', {\n      cachedAt: Date.now(),\n      lastRead: Date.now(),\n      sizeBytes: 1000,\n      spreadCount: 12,\n      title: 'Orphan',\n    });\n    \n    await StoryCacheManager.verifyCacheIntegrity();\n    \n    const index = await cacheStorage.getIndex();\n    expect(index['orphan-id']).toBeUndefined();\n  });\n});\n```\n\n## Verification\n\n- Unit/integration tests pass\n- Manual: Add orphaned entry to AsyncStorage, restart app, verify it's cleaned up\n- Manual: Cache story, kill app, reopen, verify story available immediately\n\n## Files\n\n- `frontend/lib/story-cache.ts` (MODIFY)\n- `frontend/app/_layout.tsx` (MODIFY)\n- `frontend/__tests__/lib/story-cache.test.ts` (MODIFY)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:35:08.033393223Z","created_by":"kavin","updated_at":"2026-01-04T22:24:37.958140599Z","closed_at":"2026-01-04T22:24:37.958140599Z","close_reason":"Added verifyCacheIntegrity() and hydrateQueryClient() to StoryCacheManager. Updated AuthGate in _layout.tsx to run cache init on mount and wait for both auth and cache ready. Added 8 new tests, all 73 tests pass.","dependencies":[{"issue_id":"story-o28s","depends_on_id":"story-olko","type":"blocks","created_at":"2026-01-04T21:35:33.892155958Z","created_by":"daemon"}],"comments":[{"id":13,"issue_id":"story-o28s","author":"kavin","text":"**Implementation note:** The AuthGate now has two loading conditions that must BOTH be true before rendering children:\n\n```typescript\nif (!isHydrated || !cacheReady) {\n  return \u003cActivityIndicator /\u003e;\n}\n```\n\nMake sure both gates are checked‚Äîauth hydration AND cache hydration must complete before the app renders.","created_at":"2026-01-04T21:40:15Z"}]}
{"id":"story-o2bw","title":"Fix cachedStoryMap refresh after cache clear","description":"In index.tsx lines 25-38:\n- cachedStoryMap is built once on mount via useEffect\n- Never refreshed when returning from settings after cache clear\n- User clears cache, returns to library, sees stale overlay\n\nFix: Either:\n1. Rebuild map when cachedStories changes (add dependency)\n2. Remove the Map entirely - just use cachedStories.find() inline (simpler, no premature optimization)","status":"closed","priority":2,"issue_type":"bug","estimated_minutes":5,"created_at":"2026-01-05T04:21:07.049395767Z","created_by":"kavin","updated_at":"2026-01-05T04:51:54.745690472Z","closed_at":"2026-01-05T04:51:54.745690472Z","close_reason":"Removed cachedStoryMap - use inline find() to prevent stale data","dependencies":[{"issue_id":"story-o2bw","depends_on_id":"story-oszk","type":"blocks","created_at":"2026-01-05T04:21:07.056779829Z","created_by":"daemon"}]}
{"id":"story-ol89","title":"Spread Illustration Editing Feature","description":"Add ability to edit/regenerate individual spread illustrations from the read screen.\n\n## Overview\nUsers can tap an edit button on any spread to:\n1. Regenerate with the same prompt (get a different result)\n2. Edit the prompt and regenerate (change what's shown)\n\n## Key Technical Considerations\n- **Image caching**: Add `key={imageUrl}` to `\u003cImage\u003e` to force remount when URL changes\n- **Race conditions**: Cancel queries in `onMutate` before optimistic update\n- **Error recovery**: Keep old image until new one successfully written (atomic file ops)\n- **Polling efficiency**: Stop polling when no active regeneration jobs\n- **Cache busting**: Use `?v={timestamp}` query param on image URLs after regeneration\n\n## References\n- Read screen: `frontend/app/read/[id].tsx`\n- Story hooks: `frontend/features/stories/hooks.ts`\n- Spread illustrator: `backend/core/modules/spread_illustrator.py`\n- Story routes: `backend/api/routes/stories.py`","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-01T17:42:02.330088167Z","created_by":"kavin","updated_at":"2026-01-03T16:20:17.637838281Z","closed_at":"2026-01-03T16:20:17.637838281Z","close_reason":"Feature complete - spread illustration editing works via edit-prompt.tsx fullscreen modal. Remaining test beads (v5lb, whu9) are separate concerns.","dependencies":[{"issue_id":"story-ol89","depends_on_id":"story-ujkc","type":"blocks","created_at":"2026-01-01T17:43:48.1689031Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-ly0h","type":"blocks","created_at":"2026-01-01T17:43:48.186386111Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-o13s","type":"blocks","created_at":"2026-01-01T17:43:48.203585605Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-bm9o","type":"blocks","created_at":"2026-01-01T17:43:48.218864516Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-uzi9","type":"blocks","created_at":"2026-01-01T17:43:48.233119434Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-kg22","type":"blocks","created_at":"2026-01-01T17:43:48.248755994Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-qypv","type":"blocks","created_at":"2026-01-01T17:43:48.263328341Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-uhev","type":"blocks","created_at":"2026-01-01T17:43:48.277319974Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-bdzy","type":"blocks","created_at":"2026-01-01T17:58:18.867583158Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-upy3","type":"blocks","created_at":"2026-01-01T17:58:18.882506243Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-3vc9","type":"blocks","created_at":"2026-01-01T17:58:18.897048446Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-whu9","type":"blocks","created_at":"2026-01-01T17:58:18.912188328Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-4dm8","type":"blocks","created_at":"2026-01-01T17:58:18.926636579Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-v5lb","type":"blocks","created_at":"2026-01-01T17:58:18.941695589Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-q8o7","type":"blocks","created_at":"2026-01-03T14:03:54.752664703Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-bi7r","type":"blocks","created_at":"2026-01-03T14:03:54.770584385Z","created_by":"daemon"},{"issue_id":"story-ol89","depends_on_id":"story-entg","type":"blocks","created_at":"2026-01-03T14:03:54.786317419Z","created_by":"daemon"}]}
{"id":"story-olko","title":"Implement StoryCacheManager core","description":"Implement the core StoryCacheManager that orchestrates cache-storage and cache-files to provide atomic story caching.\n\n## Scope\n\n- Create `frontend/lib/story-cache.ts`\n- Implement core operations: `cacheStory()`, `isStoryCached()`, `loadCachedStory()`, `evictStory()`, `invalidateStory()`\n- Handle download concurrency (4 parallel max)\n- Ensure atomic caching (all-or-nothing)\n\n## Implementation\n\n```typescript\n// frontend/lib/story-cache.ts\nimport { Story } from './api';\nimport { cacheStorage, CacheEntry } from './cache-storage';\nimport { cacheFiles } from './cache-files';\nimport api from './api';\n\nconst DOWNLOAD_CONCURRENCY = 4;\n\nexport const StoryCacheManager = {\n  cacheStory: async (story: Story): Promise\u003cboolean\u003e =\u003e {\n    if (!story.is_illustrated || !story.spreads?.length) {\n      return false;\n    }\n    \n    const storyId = story.id;\n    \n    try {\n      // Create directory\n      await cacheFiles.ensureDirectoryExists(storyId);\n      \n      // Download all images with concurrency limit\n      const spreads = [...story.spreads];\n      let totalSize = 0;\n      \n      for (let i = 0; i \u003c spreads.length; i += DOWNLOAD_CONCURRENCY) {\n        const batch = spreads.slice(i, i + DOWNLOAD_CONCURRENCY);\n        const results = await Promise.all(\n          batch.map(spread =\u003e {\n            const url = api.getSpreadImageUrl(storyId, spread.spread_number, spread.illustration_updated_at);\n            return cacheFiles.downloadSpreadImage(storyId, spread.spread_number, url);\n          })\n        );\n        \n        if (results.some(r =\u003e !r.success)) {\n          throw new Error('Some downloads failed');\n        }\n        \n        totalSize += results.reduce((sum, r) =\u003e sum + r.size, 0);\n      }\n      \n      // Save metadata with transformed URLs\n      await cacheFiles.saveStoryMetadata(storyId, story);\n      \n      // Get metadata size\n      const metadataSize = JSON.stringify(story).length;\n      totalSize += metadataSize;\n      \n      // Update index\n      const entry: CacheEntry = {\n        cachedAt: Date.now(),\n        lastRead: Date.now(),\n        sizeBytes: totalSize,\n        spreadCount: story.spreads.length,\n        title: story.title || 'Untitled',\n      };\n      await cacheStorage.setStoryEntry(storyId, entry);\n      \n      return true;\n      \n    } catch (error) {\n      console.error(`Failed to cache story ${storyId}:`, error);\n      // Cleanup partial download\n      await cacheFiles.deleteStoryDirectory(storyId);\n      return false;\n    }\n  },\n  \n  isStoryCached: async (storyId: string): Promise\u003cboolean\u003e =\u003e {\n    const index = await cacheStorage.getIndex();\n    const entry = index[storyId];\n    if (!entry) return false;\n    \n    // Verify files actually exist\n    return cacheFiles.verifyStoryFiles(storyId, entry.spreadCount);\n  },\n  \n  loadCachedStory: async (storyId: string): Promise\u003cStory | null\u003e =\u003e {\n    const story = await cacheFiles.loadStoryMetadata(storyId);\n    if (story) {\n      // Update lastRead timestamp\n      await cacheStorage.updateLastRead(storyId);\n    }\n    return story;\n  },\n  \n  evictStory: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    await cacheFiles.deleteStoryDirectory(storyId);\n    await cacheStorage.removeStoryEntry(storyId);\n  },\n  \n  invalidateStory: async (storyId: string): Promise\u003cvoid\u003e =\u003e {\n    // Same as evict - forces re-download on next read\n    await StoryCacheManager.evictStory(storyId);\n  },\n};\n```\n\n## Test Strategy\n\n```typescript\n// frontend/__tests__/lib/story-cache.test.ts\ndescribe('StoryCacheManager', () =\u003e {\n  const testStory = createMockStory({ id: 'test-123', spreadCount: 12 });\n  \n  afterEach(async () =\u003e {\n    await StoryCacheManager.evictStory(testStory.id);\n  });\n  \n  it('cacheStory downloads all images and updates index', async () =\u003e {\n    // Requires mock server or real API\n    const result = await StoryCacheManager.cacheStory(testStory);\n    expect(result).toBe(true);\n    expect(await StoryCacheManager.isStoryCached(testStory.id)).toBe(true);\n  });\n  \n  it('cacheStory cleans up on partial failure', async () =\u003e {\n    const badStory = { ...testStory, id: 'bad-story' };\n    // Mock one image URL to fail\n    const result = await StoryCacheManager.cacheStory(badStory);\n    expect(result).toBe(false);\n    expect(await StoryCacheManager.isStoryCached(badStory.id)).toBe(false);\n  });\n  \n  it('loadCachedStory returns story with file:// URLs', async () =\u003e {\n    await StoryCacheManager.cacheStory(testStory);\n    const cached = await StoryCacheManager.loadCachedStory(testStory.id);\n    expect(cached?.spreads?.[0].illustration_url).toMatch(/^file:\\/\\//);\n  });\n  \n  it('evictStory removes files and index entry', async () =\u003e {\n    await StoryCacheManager.cacheStory(testStory);\n    await StoryCacheManager.evictStory(testStory.id);\n    expect(await StoryCacheManager.isStoryCached(testStory.id)).toBe(false);\n  });\n  \n  it('loadCachedStory updates lastRead timestamp', async () =\u003e {\n    await StoryCacheManager.cacheStory(testStory);\n    const before = (await cacheStorage.getIndex())[testStory.id].lastRead;\n    await new Promise(r =\u003e setTimeout(r, 10));\n    await StoryCacheManager.loadCachedStory(testStory.id);\n    const after = (await cacheStorage.getIndex())[testStory.id].lastRead;\n    expect(after).toBeGreaterThan(before);\n  });\n});\n```\n\n## Verification\n\n- Integration tests pass on iOS simulator\n- Manual test: Cache a story, force-quit app, reopen, verify story loads from cache offline\n\n## Files\n\n- `frontend/lib/story-cache.ts` (NEW)\n- `frontend/__tests__/lib/story-cache.test.ts` (NEW)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:34:05.945475669Z","created_by":"kavin","updated_at":"2026-01-04T21:55:17.337925373Z","closed_at":"2026-01-04T21:55:17.337925373Z","close_reason":"Created frontend/lib/story-cache.ts with StoryCacheManager. Implements cacheStory (with 4-concurrent downloads, atomic cleanup on failure), isStoryCached, loadCachedStory, evictStory, invalidateStory. TypeScript passes, existing tests pass.","dependencies":[{"issue_id":"story-olko","depends_on_id":"story-n04x","type":"blocks","created_at":"2026-01-04T21:34:35.039895389Z","created_by":"daemon"},{"issue_id":"story-olko","depends_on_id":"story-gso5","type":"blocks","created_at":"2026-01-04T21:34:35.059356214Z","created_by":"daemon"}],"comments":[{"id":12,"issue_id":"story-olko","author":"kavin","text":"**Implementation note:** Add a comment explaining URL transformation rationale:\n\n```typescript\n// Cached stories have their illustration_url fields transformed from API URLs\n// (e.g., '/stories/abc/spreads/1/image') to local file:// URLs\n// (e.g., 'file:///path/to/stories/abc/spread_01.png').\n// This allows the Image component to render from local disk without any\n// changes to the rendering code‚Äîit just sees a different URL scheme.\n```","created_at":"2026-01-04T21:39:52Z"}]}
{"id":"story-oszk","title":"Extract cache logic into custom hook","description":"read/[id].tsx is 661 lines with 6 state vars and 3 coupled useEffects for cache logic.\n\nExtract into hooks/use-story-cache.ts:\n\nfunction useStoryCache(storyId: string, networkStory: Story | undefined) {\n  // All cache state and effects here\n  return { cachedStory, isCached, isCaching };\n}\n\nThis encapsulates:\n- Cache check on mount\n- Loading cached story  \n- Triggering background cache\n- State consistency management\n\nMakes read/[id].tsx purely presentational and trivially testable.","status":"closed","priority":2,"issue_type":"chore","estimated_minutes":30,"created_at":"2026-01-05T04:20:59.094560578Z","created_by":"kavin","updated_at":"2026-01-05T04:50:08.158418845Z","closed_at":"2026-01-05T04:50:08.158418845Z","close_reason":"Extracted cache logic into lib/use-story-cache.ts hook","dependencies":[{"issue_id":"story-oszk","depends_on_id":"story-nzep","type":"blocks","created_at":"2026-01-05T04:20:59.101759431Z","created_by":"daemon"}]}
{"id":"story-pd8","title":"Migrate StoryRepository to async","description":"Convert all StoryRepository methods to async/await using async SQLAlchemy sessions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:10.810399351Z","created_by":"kavin","updated_at":"2025-12-29T15:00:38.822255102Z","closed_at":"2025-12-29T15:00:38.822255102Z","close_reason":"Migrated StoryRepository to SQLAlchemy ORM with AsyncSession","dependencies":[{"issue_id":"story-pd8","depends_on_id":"story-ng3","type":"blocks","created_at":"2025-12-29T14:44:12.528729154Z","created_by":"daemon"},{"issue_id":"story-pd8","depends_on_id":"story-a47","type":"blocks","created_at":"2025-12-29T14:44:12.542480387Z","created_by":"daemon"}]}
{"id":"story-peb8","title":"Audit: Testing Infrastructure","description":"**Code Path**: tests/\n\n**Files to examine**:\n- tests/unit/conftest.py\n- tests/unit/test_*.py (all test files)\n- tests/integration/test_*.py\n- frontend/__tests__/\n- frontend/e2e/\n\n**Investigation goals**:\n1. Look for duplicated test setup/teardown patterns\n2. Check for duplicated mock configurations\n3. Identify non-KISS complexity in test fixtures\n4. Look for duplicated assertion patterns\n5. Check for test files that violate SRP (testing too many things)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:47.843183446Z","created_by":"kavin","updated_at":"2026-01-03T19:28:47.843183446Z"}
{"id":"story-pn2","title":"Fix ProgressTracker to use sync SQLite writes","description":"Progress updates are scheduled via asyncio.run_coroutine_threadsafe() but never execute because the event loop is blocked by sync DSPy work. Change ProgressTracker to write directly to SQLite synchronously - we're already in a background thread so blocking is fine.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-25T10:27:54.267812-08:00","updated_at":"2025-12-25T10:35:17.447411-08:00","closed_at":"2025-12-25T10:35:17.447411-08:00"}
{"id":"story-ptkt","title":"Progress updates not displaying during story creation","description":"## Problem\nProgress updates on the create story screen remain blank until the story is eventually created. The frontend polls every 2 seconds but never sees intermediate progress.\n\n## Root Cause\nIn `backend/api/services/story_generation.py`, the `progress_callback` used `asyncio.create_task()` to schedule progress updates. However, `generator.generate_illustrated()` is a **synchronous** function that blocks the event loop for the entire duration of story generation (several minutes).\n\nWhile the sync function blocks, scheduled tasks cannot execute - they're queued but the event loop never gets a chance to run them. All progress updates only fire after the sync function returns, by which point the story is complete.\n\n## Solution\n1. Capture the event loop reference with `asyncio.get_running_loop()` before entering sync code\n2. Use `asyncio.run_coroutine_threadsafe()` instead of `create_task()` - the correct primitive for scheduling coroutines from another thread\n3. Wrap the blocking `generate_illustrated()` call with `asyncio.to_thread()` to run it in a thread pool, freeing the event loop to process scheduled progress updates\n\n## Files Changed\n- `backend/api/services/story_generation.py` - Fixed async/sync boundary handling\n\n## Validation\nSolution reviewed against Python asyncio best practices:\n- `to_thread()` correctly moves blocking work off the event loop\n- `run_coroutine_threadsafe()` is the proper primitive for cross-thread coroutine scheduling\n- Thread-safety preserved (DSPy already handles thread-local context, asyncpg runs on main loop)","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-01T04:33:58.460656479Z","created_by":"kavin","updated_at":"2026-01-01T04:34:03.921810008Z","closed_at":"2026-01-01T04:34:03.921810008Z","close_reason":"Fixed by wrapping generate_illustrated() in asyncio.to_thread() and using run_coroutine_threadsafe() for progress callbacks. Progress updates now execute in real-time while story generation runs in thread pool."}
{"id":"story-q1ux","title":"Fix: Inconsistent story text compilation","description":"**Issue**: Story text is compiled differently in two places.\n\n**Locations**:\n1. `backend/core/programs/story_generator.py` lines 125-127:\n   ```python\n   story_text = \"\\n\\n\".join(\n       f\"Spread {s.spread_number}: {s.text}\" for s in spreads\n   )\n   ```\n\n2. `backend/core/types.py` GeneratedStory.full_text property (line 391-392):\n   ```python\n   return \"\\n\\n\".join(spread.text for spread in self.spreads)\n   ```\n\n**Problem**: \n- Format 1 includes 'Spread N:' prefix\n- Format 2 is just the text\n- Different methods used for different purposes (character extraction vs output)\n\n**Proposed fix**:\n1. Decide on canonical format\n2. Add method to GeneratedStory or StorySpread for consistent compilation\n3. Update story_generator.py to use the canonical method\n\n**Complexity**: Low","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-03T19:38:47.043349011Z","created_by":"kavin","updated_at":"2026-01-03T22:25:08.466818395Z","closed_at":"2026-01-03T22:25:08.466818395Z","close_reason":"Fixed with Kent Beck's approach: deleted dead full_text property, extracted _format_spreads_for_llm() helper in story_generator.py. All 98 unit tests pass.","comments":[{"id":6,"issue_id":"story-q1ux","author":"kavin","text":"Investigation findings:\n\n1. **full_text property is dead code** - Added in commit 66033f5 (Dec 17) when GeneratedStory was centralized into types.py. Never used anywhere in the codebase since creation.\n\n2. **The two formats serve different purposes**:\n   - Prefixed format ('Spread N: text') in story_generator.py is intentional - gives LLMs structural context for character extraction, bible generation, and quality judging\n   - Clean format (full_text) was intended for display/output but never wired up\n\n3. **Current usage of prefixed format** (story_generator.py):\n   - Line 132: character extraction\n   - Line 139: bible generation  \n   - Line 147: story summary\n   - Line 166: quality judging\n\n4. **Recommended fix**:\n   - Add `formatted_for_llm()` method to GeneratedStory that produces 'Spread N: text' format\n   - Update story_generator.py to use this method instead of inline formatting\n   - Either remove dead `full_text` property or keep it for future display use\n   - Single source of truth for both formats","created_at":"2026-01-03T22:17:52Z"}]}
{"id":"story-q28g","title":"Change JSON columns from TEXT to JSONB","description":"outline_json, judgment_json, and progress_json are stored as TEXT. Should be JSONB for: validation, querying, indexing, and storage efficiency.\n\nSteps:\n1. Create migration to ALTER COLUMN type to JSONB for:\n   - outline_json TEXT -\u003e JSONB\n   - judgment_json TEXT -\u003e JSONB  \n   - progress_json TEXT -\u003e JSONB\n2. Note: existing data will be validated on conversion - if any malformed JSON exists, migration will fail (good - we want to know)\n3. Update repository.py - json.dumps() calls may need adjustment if passing to JSONB columns\n4. Run migration against dev database\n5. Run full test suite\n6. Verify story creation still works end-to-end","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T21:39:29.029534381Z","created_by":"kavin","updated_at":"2025-12-30T21:55:33.203565843Z","closed_at":"2025-12-30T21:55:33.203565843Z","close_reason":"Migration 001 implemented and all tests pass. JSONB type now used for outline_json, judgment_json, progress_json columns."}
{"id":"story-q8o7","title":"Fix keyboard overlap in edit-prompt modal","description":"The keyboard overlaps the bottom of the TextArea when editing prompts.\n\n## Problem\n- Modal uses ScrollView but no keyboard-aware handling\n- When keyboard appears, it covers the bottom of the TextInput\n- Users can't see what they're typing for longer prompts\n\n## Solution\nReplace ScrollView with KeyboardAwareScrollView from react-native-keyboard-aware-scroll-view:\n- Install the package\n- Replace ScrollView with KeyboardAwareScrollView\n- Add extraScrollHeight={100} for padding above keyboard\n- Enable on Android with enableOnAndroid={true}\n\n## Files\n- frontend/app/edit-prompt.tsx\n- frontend/package.json","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-03T14:03:37.953529831Z","created_by":"kavin","updated_at":"2026-01-03T14:06:11.217446725Z","closed_at":"2026-01-03T14:06:11.217446725Z","close_reason":"Replaced ScrollView with KeyboardAwareScrollView, added extraScrollHeight={100} and enableOnAndroid={true}"}
{"id":"story-qb28","title":"Decide: Keep or remove automatic image QA functionality","description":"The image QA system (VLMJudge + ImageQA) automatically evaluates generated images and regenerates failures. Now that manual spread regeneration exists, this may be unnecessary complexity/cost.\n\nOptions:\n1. **Keep QA** - Re-enable use_image_qa=True, useful for batch generation quality\n2. **Remove QA** - Delete ImageQA, VLMJudge, and related code entirely\n3. **Make configurable** - Add API/config option to enable QA per-request\n\nCurrently disabled in story_generation.py and regenerate_story.py.\n\nFiles involved:\n- backend/core/modules/image_qa.py\n- backend/core/modules/vlm_judge.py\n- backend/core/modules/spread_illustrator.py (illustrate_*_with_qa methods)\n- backend/core/programs/story_generator.py (use_image_qa param)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T00:46:54.045883083Z","created_by":"kavin","updated_at":"2026-01-04T00:46:54.045883083Z"}
{"id":"story-qb9u","title":"Fix: Duplicated name matching in spread_illustrator","description":"**Issue**: Character name matching logic is duplicated between two files.\n\n**Locations**:\n- `backend/core/types.py` lines 18-57: `_normalize_name()`, `_strip_leading_article()`, `_names_match()`\n- `backend/core/modules/spread_illustrator.py` lines 58-121: `_normalize()`, `_strip_leading_article()`, `_name_matches_in_text()`, `_build_character_lookup()`\n\n**Problem**: Same logic copy-pasted with slightly different function names. DRY violation.\n\n**Proposed fix**:\n1. Keep the canonical implementation in `types.py` (it's already the 'single source of truth' for types)\n2. Add any additional functions needed (like `_build_character_lookup`) to types.py\n3. Update `spread_illustrator.py` to import from types.py\n4. Remove duplicated code from spread_illustrator.py\n\n**Complexity**: Low - straightforward refactor","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-03T19:38:44.404782832Z","created_by":"kavin","updated_at":"2026-01-03T19:43:08.341683525Z","closed_at":"2026-01-03T19:43:08.341683525Z","close_reason":"Fixed duplicated name matching logic.\n\nChanges:\n1. Added `build_character_lookup()` and `name_matches_in_text()` to `backend/core/types.py` as canonical implementations\n2. Updated `backend/core/modules/spread_illustrator.py` to import from types.py\n3. Removed 65 lines of duplicated code from SpreadIllustrator class\n\nThe functions are now centralized in types.py (the 'single source of truth' for domain types), and spread_illustrator.py imports them.\n\nAll 98 unit tests pass."}
{"id":"story-qba","title":"Create new directory structure with __init__.py files","description":"Create backend/, backend/core/, cli/, tests/unit/, tests/integration/, docs/prototypes/ directories. Add __init__.py files to backend/, backend/core/, tests/unit/, tests/integration/. This must be done BEFORE moving any files.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:30:33.225975-08:00","updated_at":"2025-12-18T07:47:27.326804-08:00","closed_at":"2025-12-18T07:47:27.326804-08:00"}
{"id":"story-qfgw","title":"Audit: API Routes \u0026 Service Layer","description":"**Code Path**: backend/api/routes/ and backend/api/services/\n\n**Files to examine**:\n- backend/api/routes/stories.py\n- backend/api/routes/admin.py\n- backend/api/services/story_service.py\n- backend/api/services/story_generation.py\n- backend/api/services/spread_regeneration.py\n- backend/api/services/progress_tracker.py\n- backend/api/dependencies.py\n\n**Investigation goals**:\n1. Look for duplicated request/response handling patterns\n2. Check for violations of SRP (services doing too much)\n3. Identify non-KISS complexity (over-abstraction, unnecessary indirection)\n4. Look for hardcoded values that should be configurable\n5. Check for duplicated error handling or status management\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:33.19408278Z","created_by":"kavin","updated_at":"2026-01-03T22:40:15.989177662Z","closed_at":"2026-01-03T22:40:15.989177662Z","close_reason":"Audit complete. Created 5 sub-beads for identified issues:\n- story-2wc3: DSN conversion duplication (4 locations)\n- story-wonw: Hardcoded generation defaults\n- story-a6w4: Hardcoded fallback illustration style\n- story-xv8s: Dead code (unused JobManager)\n- story-2bfy: Duplicated background task lifecycle pattern\n- story-s2oi: Admin routes missing authentication\n\nOverall assessment: Code is generally clean with good separation. Main issues are DRY violations and one piece of dead code. No critical SRP violations - services are appropriately scoped."}
{"id":"story-qix","title":"Audit frontend components for dead code","description":"Review frontend/components/ directory looking for redundant and/or dead code. Check for unused components, deprecated patterns, and unused props.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:47.605935-08:00","updated_at":"2025-12-26T15:39:12.79783-08:00","closed_at":"2025-12-26T15:39:12.79783-08:00"}
{"id":"story-qng","title":"Audit StoryRepository for dead code","description":"Review backend/api/database/repository.py looking for redundant and/or dead code. Check for unused methods, deprecated queries, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:33.192937-08:00","updated_at":"2025-12-26T15:39:12.792807-08:00","closed_at":"2025-12-26T15:39:12.792807-08:00"}
{"id":"story-qtg","title":"Add get_current_user dependency","description":"Add get_current_user() to backend/api/dependencies.py. Extract token from Authorization header, verify with JWT utils, raise 401 if invalid.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:11.441321344Z","created_by":"kavin","updated_at":"2025-12-29T01:35:27.457048387Z","closed_at":"2025-12-29T01:35:27.457048387Z","close_reason":"Added get_current_user dependency and CurrentUser type alias","dependencies":[{"issue_id":"story-qtg","depends_on_id":"story-9b3","type":"blocks","created_at":"2025-12-29T01:30:31.941428573Z","created_by":"daemon"}]}
{"id":"story-qvx","title":"Add custom fonts (Nunito + Baloo 2)","description":"Install expo-font, load Nunito and Baloo 2 fonts, create font family constants for use across the app","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T11:17:26.104374-08:00","updated_at":"2025-12-19T11:19:30.853335-08:00","closed_at":"2025-12-19T11:19:30.853335-08:00"}
{"id":"story-qypv","title":"Create SpreadEditOverlay component","description":"Create the edit overlay component that appears when user taps the edit button.\n\n## Component Props\n```typescript\ninterface SpreadEditOverlayProps {\n  isVisible: boolean;\n  spreadNumber: number;\n  currentPrompt?: string;\n  isRegenerating: boolean;\n  onRegenerate: () =\u003e void;\n  onDismiss: () =\u003e void;\n}\n```\n\n## Layout\n- Slide-up overlay covering ~60% of screen\n- Dimmed illustration visible above\n- Header: 'Edit Illustration' + close button\n- TextInput with current prompt (read-only for now, editable in future)\n- Two buttons: 'Regenerate' (primary) and 'Cancel'\n- Loading state with spinner when regenerating\n\n## Animation\nUse react-native-reanimated (already installed):\n- `withSpring()` for slide-up\n- `PanGestureHandler` for swipe-to-dismiss\n- Pattern from `CompletePop.tsx`\n\n## States\n1. Default: Show prompt + buttons\n2. Regenerating: Show spinner + 'Regenerating...' text\n3. Error: Show error message + 'Try Again' button\n\n## Patterns to Reuse\n- Form input: `/app/new.tsx` lines 142-178\n- Button styling: `/app/read/[id].tsx` lines 322-349\n- Loading: `ActivityIndicator` with amber color\n\n## Files\n- `frontend/components/SpreadEditOverlay.tsx` (new)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:43:26.05576771Z","created_by":"kavin","updated_at":"2026-01-03T16:20:06.970076031Z","closed_at":"2026-01-03T16:20:06.970076031Z","close_reason":"Obsolete - overlay approach replaced with fullscreen edit-prompt.tsx modal (see story-bi7r)","dependencies":[{"issue_id":"story-qypv","depends_on_id":"story-uzi9","type":"blocks","created_at":"2026-01-01T17:43:58.419880015Z","created_by":"daemon"}]}
{"id":"story-r4p","title":"Update all Python imports from src.* to backend.*","description":"Update imports in: tests/conftest.py (6 imports), tests/test_api_stories.py (2), tests/test_page_illustrator.py (2), tests/test_image_extraction.py (1), llm_evals/test_image_generation.py (4), scripts/generate_story.py (2), scripts/debug_page.py (3), src/optimization/optimize_page_writer.py (4). Change src.api.* ‚Üí backend.api.*, src.modules.* ‚Üí backend.core.modules.*, src.programs.* ‚Üí backend.core.programs.*, src.signatures.* ‚Üí backend.core.signatures.*, src.types ‚Üí backend.core.types, src.config ‚Üí backend.config.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:07.129892-08:00","updated_at":"2025-12-18T08:20:01.895189-08:00","closed_at":"2025-12-18T08:20:01.895189-08:00","dependencies":[{"issue_id":"story-r4p","depends_on_id":"story-3y8","type":"blocks","created_at":"2025-12-18T07:33:05.320039-08:00","created_by":"kavinstewart"}]}
{"id":"story-r68","title":"Add AsyncStorage dependency","description":"Add @react-native-async-storage/async-storage to frontend for token persistence.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:13.402027166Z","created_by":"kavin","updated_at":"2025-12-29T01:32:52.462827363Z","closed_at":"2025-12-29T01:32:52.462827363Z","close_reason":"Added @react-native-async-storage/async-storage 2.2.0"}
{"id":"story-rho","title":"Update types: StoryPage ‚Üí StorySpread","description":"Rename StoryPage to StorySpread in backend/core/types.py. Change page_number to spread_number. Update word count expectations (25-40 per spread). Update GeneratedStory to reference spreads.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:37:39.161228-08:00","updated_at":"2025-12-18T14:46:10.432388-08:00","closed_at":"2025-12-18T14:46:10.432388-08:00"}
{"id":"story-rtv","title":"Create character reference sheet generator","description":"New module that generates 4-view turnaround sheets (front, side, back, 3/4) for each character using gpt-image-1. Store images with outline.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T10:35:07.147141-08:00","updated_at":"2025-12-13T10:39:12.940839-08:00","closed_at":"2025-12-13T10:39:12.940839-08:00","dependencies":[{"issue_id":"story-rtv","depends_on_id":"story-3i2","type":"blocks","created_at":"2025-12-13T10:35:41.946458-08:00","created_by":"kavinstewart"}]}
{"id":"story-s1y","title":"Rename SRC_DIR to BACKEND_DIR in api/config.py","description":"In backend/api/config.py, rename the misleading variable SRC_DIR to BACKEND_DIR for clarity. The path calculation still works, just the name is wrong.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:32:21.896346-08:00","updated_at":"2025-12-18T08:20:01.897156-08:00","closed_at":"2025-12-18T08:20:01.897156-08:00","dependencies":[{"issue_id":"story-s1y","depends_on_id":"story-3y8","type":"blocks","created_at":"2025-12-18T07:33:44.781139-08:00","created_by":"kavinstewart"}]}
{"id":"story-s2oi","title":"Security: Admin routes lack authentication","description":"**Problem**: Routes in `backend/api/routes/admin.py` don't use the `CurrentUser` dependency, making them accessible without authentication.\n\n**Affected endpoints**:\n- GET /admin/vlm-evals\n- GET /admin/vlm-evals/stats\n- GET /admin/vlm-evals/export\n- GET /admin/vlm-evals/{eval_id}\n- POST /admin/vlm-evals/{eval_id}/annotate\n\n**Evaluate**: Is this intentional (internal-only network) or a security gap? If intentional, add a code comment. If not, add `CurrentUser` or an admin-specific auth check.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:40:06.729844915Z","created_by":"kavin","updated_at":"2026-01-04T00:13:01.495051164Z","closed_at":"2026-01-04T00:13:01.495051164Z","close_reason":"N/A - removing the admin routes entirely (story-nq6d) since VLM eval scaffolding is non-functional"}
{"id":"story-s7t","title":"Create GEPA-compatible metrics","description":"Build feedback-rich metrics for outline quality, page quality, and overall story quality in src/metrics/","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T09:37:23.641861-08:00","updated_at":"2025-12-11T09:45:03.184083-08:00","closed_at":"2025-12-11T09:45:03.184083-08:00","dependencies":[{"issue_id":"story-s7t","depends_on_id":"story-ffw","type":"blocks","created_at":"2025-12-11T09:38:43.885272-08:00","created_by":"kavinstewart"}]}
{"id":"story-s7y5","title":"Add mutex to cache-storage read-modify-write operations","description":"Race condition in cache-storage.ts: setStoryEntry, updateLastRead, and removeStoryEntry all do read-modify-write without locking.\n\nIf two operations run concurrently on different stories:\n1. Call A reads index {}\n2. Call B reads index {}  \n3. Call A writes {storyA: {...}}\n4. Call B writes {storyB: {...}} - storyA is LOST\n\nFix: Add async-mutex or promise-based lock around all index mutations.","status":"closed","priority":0,"issue_type":"bug","estimated_minutes":20,"created_at":"2026-01-05T04:20:10.298844079Z","created_by":"kavin","updated_at":"2026-01-05T04:38:22.947107876Z","closed_at":"2026-01-05T04:38:22.947107876Z","close_reason":"Implemented promise-based mutex to serialize read-modify-write operations. Added concurrent operation tests.","dependencies":[{"issue_id":"story-s7y5","depends_on_id":"story-n8l8","type":"blocks","created_at":"2026-01-05T04:20:10.306149083Z","created_by":"daemon"}]}
{"id":"story-slt4","title":"Extract QueryClient to shared module","description":"Extract QueryClient singleton to a shared module so it can be imported by StoryCacheManager and other modules.\n\n## Scope\n\n- Create `frontend/lib/query-client.ts`\n- Export singleton QueryClient instance\n- Update `frontend/app/_layout.tsx` to import instead of creating inline\n\n## Implementation\n\n```typescript\n// frontend/lib/query-client.ts\nimport { QueryClient } from '@tanstack/react-query';\n\nexport const queryClient = new QueryClient();\n```\n\n```typescript\n// frontend/app/_layout.tsx\nimport { queryClient } from '@/lib/query-client';\n// Remove: const queryClient = new QueryClient();\n```\n\n## Test Strategy\n\n- **Unit test**: Verify same instance returned on multiple imports\n- **Regression**: Existing Playwright E2E tests still pass\n\n## Verification\n\nRun `cd frontend \u0026\u0026 npx playwright test` - no regressions.\n\n## Files\n\n- `frontend/lib/query-client.ts` (NEW)\n- `frontend/app/_layout.tsx` (MODIFY)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:32:26.581269298Z","created_by":"kavin","updated_at":"2026-01-04T21:45:03.869936682Z","closed_at":"2026-01-04T21:45:03.869936682Z","close_reason":"Extracted QueryClient singleton to frontend/lib/query-client.ts, updated _layout.tsx to import from shared module. TypeScript checks pass, unit tests pass (23/23)."}
{"id":"story-snv","title":"Audit reference_stories module for dead code","description":"Review the reference_stories module looking for redundant and/or dead code. Check for unused reference stories, deprecated formats, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:31:06.61729-08:00","updated_at":"2025-12-26T15:39:12.798712-08:00","closed_at":"2025-12-26T15:39:12.798712-08:00"}
{"id":"story-swgk","title":"Fix concurrent cacheStory race condition","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-05T01:00:48.976617736Z","created_by":"kavin","updated_at":"2026-01-05T01:02:45.164172681Z","closed_at":"2026-01-05T01:02:45.164172681Z","close_reason":"Fixed: Added request deduplication to cacheStory using Map\u003cstoryId, Promise\u003e. Concurrent calls for the same story now share the same download operation, preventing race condition where atomic cleanup kills directory while other attempts are still downloading."}
{"id":"story-taxl","title":"Update schema.sql for PostgreSQL","description":"Convert SQLite syntax to PostgreSQL: SERIAL instead of AUTOINCREMENT, TIMESTAMPTZ, BOOLEAN, NOW() function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.34798889Z","created_by":"kavin","updated_at":"2025-12-30T00:24:57.321377178Z","closed_at":"2025-12-30T00:24:57.321377178Z","close_reason":"Converted schema.sql from SQLite to PostgreSQL syntax: SERIAL, BOOLEAN, TIMESTAMPTZ, NOW()"}
{"id":"story-tbus","title":"Consolidate URL strategy to compute-at-render only","description":"Currently two competing URL transformation strategies exist:\n1. loadStoryMetadata() transforms URLs on load (cache-files.ts:86-94)\n2. getImageUrl() computes URLs at render time (read/[id].tsx:36-44)\n\nFix: Remove the transform in loadStoryMetadata(). Keep URLs as server URLs everywhere. Only compute file:// at render time based on isCached flag.\n\nThis creates a single source of truth and makes the cache layer 'pure storage' without surprise side effects.","status":"closed","priority":1,"issue_type":"chore","estimated_minutes":10,"created_at":"2026-01-05T04:19:53.089249468Z","created_by":"kavin","updated_at":"2026-01-05T04:32:32.060384781Z","closed_at":"2026-01-05T04:32:32.060384781Z","close_reason":"Removed URL transformation from loadStoryMetadata. Added isCached flag to Story type. StoryCard now computes file:// paths at render time. Tests updated.","dependencies":[{"issue_id":"story-tbus","depends_on_id":"story-fubj","type":"blocks","created_at":"2026-01-05T04:19:53.095257962Z","created_by":"daemon"}]}
{"id":"story-ti3n","title":"Invalidate cache after illustration regeneration","description":"Invalidate the story cache after successful illustration regeneration to ensure new images are downloaded.\n\n## Scope\n\n- Modify `frontend/app/edit-prompt.tsx`:\n  - Call `invalidateStory()` after successful regeneration\n  - Story will be re-cached on next read\n\n## Implementation\n\n```typescript\n// frontend/app/edit-prompt.tsx\n\nimport { StoryCacheManager } from '@/lib/story-cache';\n\n// In the regeneration success handler (after polling detects completion):\n\nconst handleRegenerationComplete = async () =\u003e {\n  // Invalidate cache so new image is downloaded on next read\n  await StoryCacheManager.invalidateStory(storyId);\n  \n  // Navigate back to reader\n  router.back();\n};\n\n// Find the existing success detection logic and add invalidation:\nuseEffect(() =\u003e {\n  if (regenerationComplete) {\n    StoryCacheManager.invalidateStory(storyId)\n      .then(() =\u003e {\n        router.back();\n      });\n  }\n}, [regenerationComplete, storyId]);\n```\n\n## Test Strategy\n\n```typescript\n// E2E test\ntest('regenerating illustration invalidates cache', async ({ page }) =\u003e {\n  // Pre-cache a story\n  await page.goto('/read/test-story-id');\n  await page.waitForSelector('text=Saving for offline', { state: 'hidden', timeout: 60000 });\n  \n  // Go to edit prompt\n  await page.click('[data-testid=\"edit-illustration\"]');\n  \n  // Change prompt and regenerate\n  await page.fill('[data-testid=\"prompt-input\"]', 'A new illustration prompt');\n  await page.click('text=Regenerate');\n  \n  // Wait for regeneration to complete (this can take a while)\n  await page.waitForURL(/\\/read\\//, { timeout: 120000 });\n  \n  // Should show caching indicator again (cache was invalidated)\n  await expect(page.getByText('Saving for offline')).toBeVisible();\n});\n```\n\n## Verification\n\n- E2E test passes\n- Manual: Cache story, regenerate an illustration, verify new image appears and story is re-cached\n\n## Files\n\n- `frontend/app/edit-prompt.tsx` (MODIFY)\n- `frontend/__tests__/e2e/story-caching.spec.ts` (MODIFY - add test)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T21:35:56.830066125Z","created_by":"kavin","updated_at":"2026-01-04T22:27:56.232674307Z","closed_at":"2026-01-04T22:27:56.232674307Z","close_reason":"Added StoryCacheManager.invalidateStory() call in edit-prompt.tsx after successful regeneration polling, before navigating back to reader. All tests pass.","dependencies":[{"issue_id":"story-ti3n","depends_on_id":"story-i18e","type":"blocks","created_at":"2026-01-04T21:36:32.688345903Z","created_by":"daemon"}],"comments":[{"id":15,"issue_id":"story-ti3n","author":"kavin","text":"**Implementation note:** Find the point in `edit-prompt.tsx` where regeneration is detected as complete (polling detects `illustration_updated_at` change) and the app navigates back to the reader. Insert the `invalidateStory()` call just before the navigation:\n\n```typescript\n// After detecting regeneration complete:\nawait StoryCacheManager.invalidateStory(storyId);\nrouter.back();\n```\n\nThe exact location depends on the current polling/success detection logic‚Äîlook for where `router.back()` or similar navigation is called after successful regeneration.","created_at":"2026-01-04T21:40:18Z"}]}
{"id":"story-tnj","title":"Add pyjwt dependency","description":"Add PyJWT package to backend for token generation/validation: poetry add pyjwt","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:08.443937277Z","created_by":"kavin","updated_at":"2025-12-29T01:32:52.448081426Z","closed_at":"2025-12-29T01:32:52.448081426Z","close_reason":"Added pyjwt 2.10.1 via poetry"}
{"id":"story-ton3","title":"Set up Cloudflare R2 account","description":"User task: Create and configure a Cloudflare R2 account with appropriate bucket and API credentials.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-04T00:24:04.652911489Z","created_by":"kavin","updated_at":"2026-01-04T00:24:04.652911489Z"}
{"id":"story-tyw","title":"Simplify story generation: story-first workflow","description":"Refactor the pipeline from outline‚Üíbibles‚Üístory to story‚Üíextract characters‚Üíbibles. Current workflow invents characters before the story exists, causing hallucinated characters (like Pip the cat). New workflow: generate complete story in one shot, then extract characters from what was written, then generate visual bibles only for characters that actually appear.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-19T19:43:35.002471-08:00","updated_at":"2025-12-20T09:50:13.565369-08:00","closed_at":"2025-12-20T09:50:13.565369-08:00"}
{"id":"story-u0x","title":"Remove unused asdict import from story_service","description":"Dead import in backend/api/services/story_service.py line 9:\n- from dataclasses import asdict\n\nThis import is never used in the file.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T13:25:34.329411-08:00","updated_at":"2025-12-26T13:31:30.631185-08:00","closed_at":"2025-12-26T13:31:30.631185-08:00"}
{"id":"story-u1dh","title":"Remove surrogate key from story_spreads","description":"story_spreads has SERIAL id column that's never used. The natural key (story_id, spread_number) is already UNIQUE.\n\nSteps:\n1. Create migration to:\n   - DROP the id column\n   - DROP the UNIQUE constraint on (story_id, spread_number)\n   - ADD PRIMARY KEY (story_id, spread_number)\n2. Update repository.py if any code references the id column\n3. Run migration against dev database\n4. Run full test suite\n5. Verify spread queries still work (list spreads, get spread image)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T21:39:25.285113681Z","created_by":"kavin","updated_at":"2025-12-30T21:58:56.628602496Z","closed_at":"2025-12-30T21:58:56.628602496Z","close_reason":"Migration 002 implemented. story_spreads now uses (story_id, spread_number) as composite PK. All 54 tests pass.","dependencies":[{"issue_id":"story-u1dh","depends_on_id":"story-i4zq","type":"blocks","created_at":"2025-12-30T21:39:41.368487215Z","created_by":"daemon"}]}
{"id":"story-u23r","title":"Audit: Check for unused modules in core/","description":"**Issue**: Need to verify all modules in backend/core/modules/ are actually used.\n\n**Observed**: Signature files were found unused. Same may apply to modules.\n\n**Files to audit**:\n- Check if any modules in `backend/core/modules/` are orphaned\n- Check `__init__.py` exports vs actual usage\n- Look for any 'outline-first' workflow remnants in modules\n\n**Action**:\n1. Run grep for all module imports\n2. Identify any unused modules\n3. Create removal beads if found\n\n**Complexity**: Low - just grep analysis","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:38:56.075683355Z","created_by":"kavin","updated_at":"2026-01-03T21:03:41.327992606Z","closed_at":"2026-01-03T21:03:41.327992606Z","close_reason":"All modules verified as in-use:\n- image_qa.py ‚Üí used by spread_illustrator.py\n- illustration_styles.py ‚Üí used by story_generator.py\n- character_sheet_generator.py ‚Üí used by story_generator.py\n- All other modules exported via __init__.py and used\n\nNo unused modules found after removing outline_generator.py and spread_generator.py."}
{"id":"story-ub4","title":"Audit frontend New Story screen for dead code","description":"Review frontend/app/new.tsx looking for redundant and/or dead code. Check for unused imports, deprecated patterns, and unused functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:30:05.643723-08:00","updated_at":"2025-12-26T15:39:12.79636-08:00","closed_at":"2025-12-26T15:39:12.79636-08:00"}
{"id":"story-uc4","title":"Clean stale __pycache__ files","description":"Remove stale bytecode files, particularly src/__pycache__/config.cpython-311.pyc from the old config.py. Run: find . -type d -name __pycache__ -exec rm -rf {} +","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:36.335506-08:00","updated_at":"2025-12-17T09:27:54.33602-08:00","closed_at":"2025-12-17T09:27:54.33602-08:00","dependencies":[{"issue_id":"story-uc4","depends_on_id":"story-akf","type":"blocks","created_at":"2025-12-17T09:18:23.010837-08:00","created_by":"kavinstewart"}]}
{"id":"story-uch","title":"Implement NewStory screen","description":"Port new-story.jsx to app/new.tsx. Text/voice input toggle, theme picker pills, inspiration prompt, 'Create My Story' button","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:51:24.19798-08:00","updated_at":"2025-12-18T09:15:22.679399-08:00","closed_at":"2025-12-18T09:15:22.679399-08:00","dependencies":[{"issue_id":"story-uch","depends_on_id":"story-gpk","type":"blocks","created_at":"2025-12-18T08:53:16.19699-08:00","created_by":"kavinstewart"},{"issue_id":"story-uch","depends_on_id":"story-5bx","type":"blocks","created_at":"2025-12-18T08:53:21.360503-08:00","created_by":"kavinstewart"}]}
{"id":"story-ug8n","title":"Remove story judge (QualityJudge) - not providing value","description":"## Context\nAnalysis of 22 completed stories shows the story judge rubber-stamps everything:\n- 95.5% rated EXCELLENT (21/22)\n- 0% REJECTED\n- No score ever below 7 in any category\n- Zero critical failures detected\n\nThe elaborate criteria in StoryJudgeSignature (Chekhov's Gun rules, automatic failures, etc.) are not translating into discriminative scoring.\n\n## Decision\nRemove the story judge entirely rather than try to fix/calibrate it.\n\n## Files to DELETE\n- `backend/core/signatures/story_judge.py`\n- `backend/core/modules/quality_judge.py`\n\n## Files to MODIFY\n\n### Core generation\n- `backend/core/programs/story_generator.py`: Remove QualityJudge import, quality_threshold, max_attempts, quality loop, retry logic. Generate once and return.\n- `backend/core/types.py`: Remove QualityJudgment dataclass\n\n### API layer\n- `backend/api/services/story_generation.py`: Remove quality_threshold, max_attempts params, judgment serialization\n- `backend/api/services/story_service.py`: Remove quality params from task call\n- `backend/api/config.py`: Remove DEFAULT_QUALITY_THRESHOLD, DEFAULT_MAX_ATTEMPTS\n- `backend/worker.py`: Remove quality_threshold, max_attempts params\n- `backend/api/models/responses.py`: Remove QualityJudgmentResponse\n\n### Exports\n- `backend/core/signatures/__init__.py`: Remove StoryJudgeSignature\n- `backend/core/modules/__init__.py`: Remove QualityJudge\n\n### Frontend\n- `frontend/lib/api.ts`: Remove QualityJudgment interface\n\n## Can leave as-is\n- `backend/api/database/repository.py`: judgment_json already nullable\n- `backend/api/database/schema.sql`: Column remains for historical data\n- `backend/metrics/story_quality.py`: GEPA metric, unrelated to QualityJudge\n\n## Testing\nNo existing tests for QualityJudge. Run full test suite after removal:\n```bash\npoetry run pytest tests/unit/ -v\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T14:37:40.22351189Z","created_by":"kavin","updated_at":"2026-01-04T14:46:37.88156443Z","closed_at":"2026-01-04T14:46:37.88156443Z","close_reason":"Story judge removed. Deleted 2 files (story_judge.py, quality_judge.py), updated 14 files to remove quality_threshold/max_attempts/judgment references. All 105 unit tests pass."}
{"id":"story-ugv","title":"Replace inspiration tip with tappable prompt pills","description":"Replace the static inspiration tip box with 3-4 tappable pills that populate the prompt field. Pills show 2-3 word descriptions. On tap, populate the goal field with the full prompt. Randomize which pills appear from a pool of 25+ prompts on mount.\n\nPROMPT POOL (25+ prompts covering history, science, religion, philosophy):\n\nHISTORICAL EVENTS:\n1. 'Napoleon's Return' ‚Üí 'Napoleon escapes from Elba and marches back to Paris'\n2. 'French Revolution' ‚Üí 'The people of France rise up against their king'\n3. 'Fall of Constantinople' ‚Üí 'The last day of the great Byzantine city'\n4. 'Boston Tea Party' ‚Üí 'Colonists dump tea into the harbor to protest unfair taxes'\n5. 'Moon Landing' ‚Üí 'Astronauts take humanity's first steps on the moon'\n6. 'Berlin Wall Falls' ‚Üí 'The night the wall came down and families reunited'\n7. 'Silk Road Journey' ‚Üí 'A merchant travels the ancient trade route between East and West'\n\nHUMAN BODY \u0026 DISEASES:\n8. 'How Arteries Clog' ‚Üí 'A journey through blood vessels learning about atherosclerosis'\n9. 'Parkinson's Disease' ‚Üí 'Understanding why grandpa's hands shake'\n10. 'How Livers Work' ‚Üí 'The body's amazing cleaning factory'\n11. 'Fighting Cancer' ‚Üí 'How the body's defenders battle rogue cells'\n12. 'Diabetes Explained' ‚Üí 'Why some bodies need help with sugar'\n13. 'How Vaccines Work' ‚Üí 'Training tiny soldiers to protect the body'\n14. 'The Beating Heart' ‚Üí 'A day in the life of the body's hardest-working muscle'\n\nRELIGIOUS \u0026 PHILOSOPHICAL:\n15. 'Arjuna's Dilemma' ‚Üí 'The warrior who didn't want to fight (from the Bhagavad Gita)'\n16. 'Buddha Under Tree' ‚Üí 'A prince who gave up everything to find peace'\n17. 'David vs Goliath' ‚Üí 'A shepherd boy faces a giant warrior'\n18. 'Noah's Great Boat' ‚Üí 'Building an ark to save all the animals'\n19. 'The Good Samaritan' ‚Üí 'A stranger helps someone everyone else ignored'\n20. 'Muhammad's Journey' ‚Üí 'The night journey to the heavens'\n\nSCIENCE \u0026 NATURE:\n21. 'How Stars Die' ‚Üí 'The spectacular end of a star's life'\n22. 'Dinosaur Extinction' ‚Üí 'The day the asteroid changed everything'\n23. 'How Bees Dance' ‚Üí 'The secret language of the hive'\n24. 'Volcano Erupts' ‚Üí 'What happens deep inside an erupting mountain'\n25. 'Ice Age Begins' ‚Üí 'When the world froze over'\n\nPHILOSOPHY \u0026 IDEAS:\n26. 'Socrates Questions' ‚Üí 'The man who asked too many questions'\n27. 'Plato's Cave' ‚Üí 'Prisoners who only saw shadows'\n28. 'Golden Rule' ‚Üí 'The idea that connects all cultures'\n\nFrontend-only feature - no backend changes needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:04:10.251214-08:00","updated_at":"2025-12-26T16:09:48.55513-08:00","closed_at":"2025-12-26T16:09:48.55513-08:00"}
{"id":"story-uhev","title":"Wire up image refresh after regeneration","description":"Ensure new image displays after regeneration completes.\n\n## Changes to read/[id].tsx\n\n### Update Image URL Generation\n```typescript\nconst imageUrl = story.is_illustrated \u0026\u0026 displaySpread\n  ? api.getSpreadImageUrl(\n      story.id,\n      displaySpread.spread_number,\n      displaySpread.illustration_updated_at  // Cache buster\n    )\n  : null;\n```\n\n### Force Image Remount\n```typescript\n\u003cImage\n  key={imageUrl}  // Forces remount when URL changes\n  source={{ uri: imageUrl }}\n  // ... rest of props\n/\u003e\n```\n\n## Technical Note: Why key={imageUrl}\nReact Native's Image component caches aggressively. Even with a new URL, it may show cached image. Adding `key` forces complete remount, guaranteeing fresh fetch.\n\n## Note\nThis bead handles the read screen image refresh. The actual polling to detect when regeneration completes is handled by story-entg.\n\n## Files\n- `frontend/app/read/[id].tsx`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:43:39.087730071Z","created_by":"kavin","updated_at":"2026-01-03T16:20:08.881912705Z","closed_at":"2026-01-03T16:20:08.881912705Z","close_reason":"Already implemented - cache busting via illustration_updated_at and key={imageUrl} in read/[id].tsx","dependencies":[{"issue_id":"story-uhev","depends_on_id":"story-qypv","type":"blocks","created_at":"2026-01-01T17:43:58.434878763Z","created_by":"daemon"},{"issue_id":"story-uhev","depends_on_id":"story-bm9o","type":"blocks","created_at":"2026-01-01T17:43:58.449075814Z","created_by":"daemon"}]}
{"id":"story-ujkc","title":"Add illustration_updated_at to story_spreads schema","description":"Add timestamp column to track when spread illustrations were last regenerated.\n\n## Changes\n- Add `illustration_updated_at TIMESTAMPTZ` column to `story_spreads` table in `schema.sql`\n- Update `StorySpreadResponse` in `responses.py` to include the field\n- Update repository to set timestamp on save/update\n\n## Files\n- `backend/api/database/schema.sql`\n- `backend/api/models/responses.py`\n- `backend/api/database/repository.py`\n\n## Why\nThis timestamp is critical for cache-busting - frontend uses it to generate unique image URLs after regeneration.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:42:14.316173386Z","created_by":"kavin","updated_at":"2026-01-03T16:19:50.742230035Z","closed_at":"2026-01-03T16:19:50.742230035Z","close_reason":"Already implemented - illustration_updated_at column exists in schema.sql:36"}
{"id":"story-unp","title":"Remove pointless __init__.py files","description":"Remove near-empty __init__.py files that serve no purpose:\n- scripts/__init__.py (just a comment, scripts/ not imported as package)\n- src/optimization/__init__.py (just a comment, run as module not imported)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:49.522549-08:00","updated_at":"2025-12-17T09:27:54.335411-08:00","closed_at":"2025-12-17T09:27:54.335411-08:00"}
{"id":"story-up5","title":"Create /auth/login endpoint","description":"Create backend/api/auth/routes.py with POST /auth/login. Accept PIN, validate against hashed PIN in env or db, return JWT token.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T01:30:10.563345839Z","created_by":"kavin","updated_at":"2025-12-29T01:35:27.441462158Z","closed_at":"2025-12-29T01:35:27.441462158Z","close_reason":"Created /auth/login endpoint in backend/api/auth/routes.py","dependencies":[{"issue_id":"story-up5","depends_on_id":"story-9b3","type":"blocks","created_at":"2025-12-29T01:30:31.928226399Z","created_by":"daemon"}]}
{"id":"story-upy3","title":"Unit tests: spread regeneration API endpoint","description":"Test the POST /stories/{id}/spreads/{num}/regenerate endpoint.\n\n## Test File\n`backend/tests/unit/test_spread_regen_endpoint.py`\n\n## Test Cases\n\n### test_regenerate_spread_returns_202_accepted\n- POST to valid story/spread returns 202\n- Response contains job_id and status='pending'\n- Job is created in database\n\n### test_regenerate_spread_invalid_story_returns_404\n- POST to non-existent story_id returns 404\n- Error message indicates story not found\n\n### test_regenerate_spread_invalid_spread_returns_404\n- POST to non-existent spread_number returns 404\n- Error message indicates spread not found\n\n### test_regenerate_spread_non_illustrated_story_returns_400\n- POST to story with is_illustrated=false returns 400\n- Error message indicates story has no illustrations\n\n### test_regenerate_spread_enqueues_arq_job\n- Mock ARQ pool\n- Verify enqueue_job called with correct params:\n  - job name: 'regenerate_spread_task'\n  - story_id, spread_number passed correctly\n\n### test_regenerate_spread_already_regenerating_returns_409\n- Create a job with status='running' for same spread\n- POST returns 409 Conflict\n- Error message indicates regeneration in progress\n\n### test_get_regenerate_status_returns_job_info\n- Create a job, then GET its status\n- Returns correct status, timestamps, progress\n\n### test_get_regenerate_status_wrong_story_returns_403\n- Create job for story A\n- GET status with story B returns 403\n\n## Mocking\n- Mock ARQ pool to avoid actual job enqueue\n- Use test database for story/spread data","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:57:09.296851632Z","created_by":"kavin","updated_at":"2026-01-03T14:28:11.937226596Z","closed_at":"2026-01-03T14:28:11.937226596Z","close_reason":"Tests already implemented in tests/unit/test_spread_regen_endpoint.py (6 tests, 1 minor fix needed)","dependencies":[{"issue_id":"story-upy3","depends_on_id":"story-o13s","type":"blocks","created_at":"2026-01-01T17:58:18.778116633Z","created_by":"daemon"}]}
{"id":"story-uzi9","title":"Create useRegenerateSpread hook with optimistic updates","description":"Add React Query mutation hook for spread regeneration.\n\n## Hook Implementation\n```typescript\nexport function useRegenerateSpread() {\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: ({ storyId, spreadNumber }) =\u003e \n      api.regenerateSpread(storyId, spreadNumber),\n    \n    onMutate: async ({ storyId, spreadNumber }) =\u003e {\n      // Cancel ongoing queries (prevent race conditions)\n      await queryClient.cancelQueries({\n        queryKey: storyKeys.detail(storyId),\n      });\n\n      // Optimistic update: mark spread as regenerating\n      queryClient.setQueryData(storyKeys.detail(storyId), (old) =\u003e ({\n        ...old,\n        spreads: old.spreads?.map(s =\u003e \n          s.spread_number === spreadNumber \n            ? { ...s, _regenerating: true }\n            : s\n        ),\n      }));\n    },\n    \n    onSuccess: (_, { storyId }) =\u003e {\n      // Invalidate to get fresh data with new timestamp\n      queryClient.invalidateQueries({ \n        queryKey: storyKeys.detail(storyId) \n      });\n    },\n    \n    onError: (_, { storyId }) =\u003e {\n      // Refetch to restore correct state\n      queryClient.invalidateQueries({ \n        queryKey: storyKeys.detail(storyId) \n      });\n    },\n  });\n}\n```\n\n## Technical Note: Race Condition Prevention\nAlways call `cancelQueries` before `setQueryData` in `onMutate` to prevent stale data from overwriting optimistic update.\n\n## Files\n- `frontend/features/stories/hooks.ts`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:43:01.639760683Z","created_by":"kavin","updated_at":"2026-01-03T16:19:55.625974769Z","closed_at":"2026-01-03T16:19:55.625974769Z","close_reason":"Already implemented - useRegenerateSpread hook exists in hooks.ts","dependencies":[{"issue_id":"story-uzi9","depends_on_id":"story-bm9o","type":"blocks","created_at":"2026-01-01T17:43:58.389977621Z","created_by":"daemon"}]}
{"id":"story-v00z","title":"Add ARQ worker systemd service for boot startup","description":"Create user systemd service for ARQ worker (cli/run_worker.py) to start on boot and restart on failure.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T22:32:49.345294555Z","created_by":"kavin","updated_at":"2025-12-29T22:36:39.450897181Z","closed_at":"2025-12-29T22:36:39.450897181Z","close_reason":"Created stories-worker.service for ARQ worker. Enabled for boot startup. Fixed queue name issue. Verified end-to-end story generation works via ARQ.","dependencies":[{"issue_id":"story-v00z","depends_on_id":"story-4hf7","type":"blocks","created_at":"2025-12-29T22:33:02.412142217Z","created_by":"daemon"}]}
{"id":"story-v0a4","title":"Update dependencies.py for asyncpg","description":"Update get_session to yield asyncpg connection from pool instead of SQLAlchemy session","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.418547606Z","created_by":"kavin","updated_at":"2025-12-30T00:27:55.282638281Z","closed_at":"2025-12-30T00:27:55.282638281Z","close_reason":"Updated dependencies.py to use asyncpg connection from pool","dependencies":[{"issue_id":"story-v0a4","depends_on_id":"story-w025","type":"blocks","created_at":"2025-12-30T00:24:18.436920602Z","created_by":"daemon"}]}
{"id":"story-v0et","title":"Remove models.py and update __init__.py","description":"Delete SQLAlchemy models file, update __init__.py exports","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.453528811Z","created_by":"kavin","updated_at":"2025-12-30T00:29:12.249678386Z","closed_at":"2025-12-30T00:29:12.249678386Z","close_reason":"Removed models.py and updated __init__.py to export asyncpg-based components","dependencies":[{"issue_id":"story-v0et","depends_on_id":"story-bnof","type":"blocks","created_at":"2025-12-30T00:24:18.487158647Z","created_by":"daemon"}]}
{"id":"story-v4fm","title":"Update tests for async database","description":"Update test fixtures and database tests to use async PostgreSQL or test database","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:46.104364322Z","created_by":"kavin","updated_at":"2025-12-29T15:19:20.401896154Z","closed_at":"2025-12-29T15:19:20.401896154Z","close_reason":"Updated test fixtures for async PostgreSQL - all 14 API tests pass","dependencies":[{"issue_id":"story-v4fm","depends_on_id":"story-g8m0","type":"blocks","created_at":"2025-12-29T14:44:36.220271844Z","created_by":"daemon"}]}
{"id":"story-v4i7","title":"Create database migration script","description":"Create script to migrate existing SQLite data to PostgreSQL (one-time migration)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:43.20596927Z","created_by":"kavin","updated_at":"2025-12-29T15:12:25.321122711Z","closed_at":"2025-12-29T15:12:25.321122711Z","close_reason":"Created cli/migrate_to_postgres.py for one-time SQLite to Postgres migration","dependencies":[{"issue_id":"story-v4i7","depends_on_id":"story-ng3","type":"blocks","created_at":"2025-12-29T14:44:33.960611847Z","created_by":"daemon"},{"issue_id":"story-v4i7","depends_on_id":"story-2xmk","type":"blocks","created_at":"2025-12-29T14:44:33.974423962Z","created_by":"daemon"}]}
{"id":"story-v5lb","title":"Unit tests: image URL cache busting","description":"Test the cache-busting logic in api.ts and image rendering.\n\n## Test File\n`frontend/__tests__/lib/api.test.ts`\n\n## Test Cases for getSpreadImageUrl\n\n### test_returns_base_url_without_timestamp\n- Call getSpreadImageUrl('abc', 3)\n- Returns '/stories/abc/spreads/3/image'\n- No query params\n\n### test_appends_version_param_with_timestamp\n- Call getSpreadImageUrl('abc', 3, '2024-01-15T10:30:00Z')\n- Returns '/stories/abc/spreads/3/image?v=1705314600000'\n- Timestamp converted to milliseconds\n\n### test_handles_numeric_timestamp\n- Call getSpreadImageUrl('abc', 3, 1705314600000)\n- Returns '/stories/abc/spreads/3/image?v=1705314600000'\n\n### test_encodes_special_characters_in_story_id\n- Call getSpreadImageUrl('abc-123', 3)\n- URL is properly formed\n\n---\n\n## Test File\n`frontend/__tests__/app/read.test.tsx`\n\n## Test Cases for Image Rendering\n\n### test_image_url_includes_updated_at_timestamp\n- Render StoryReader with story containing spread.illustration_updated_at\n- Verify Image source.uri includes ?v= param\n\n### test_image_remounts_when_url_changes\n- Render with spread.illustration_updated_at = T1\n- Update to T2\n- Verify Image component remounted (key changed)\n- Use testID or key tracking\n\n### test_image_url_without_timestamp_when_not_set\n- Render with spread.illustration_updated_at = null\n- Verify Image source.uri has no ?v= param\n\n## Why These Tests Matter\nCache busting is critical for showing regenerated images. If the URL doesn't change, browser/RN will serve cached (old) image even after regeneration completes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:58:08.150887609Z","created_by":"kavin","updated_at":"2026-01-03T16:37:14.815957444Z","closed_at":"2026-01-03T16:37:14.815957444Z","close_reason":"Added 13 unit tests in __tests__/lib/api.test.ts covering getSpreadImageUrl cache busting","dependencies":[{"issue_id":"story-v5lb","depends_on_id":"story-bm9o","type":"blocks","created_at":"2026-01-01T17:58:18.83730058Z","created_by":"daemon"},{"issue_id":"story-v5lb","depends_on_id":"story-uhev","type":"blocks","created_at":"2026-01-01T17:58:18.853286244Z","created_by":"daemon"}]}
{"id":"story-ve1","title":"Move llm_evals/ to tests/integration/ using git mv","description":"Use git mv to move contents of llm_evals/ into tests/integration/. Check for fixture name conflicts with tests/unit/conftest.py. Includes conftest.py, test_image_generation.py, __init__.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:46.466302-08:00","updated_at":"2025-12-18T08:21:44.206755-08:00","closed_at":"2025-12-18T08:21:44.206755-08:00","dependencies":[{"issue_id":"story-ve1","depends_on_id":"story-r4p","type":"blocks","created_at":"2025-12-18T07:33:31.151876-08:00","created_by":"kavinstewart"}]}
{"id":"story-vof","title":"Update CLAUDE.md with new project structure","description":"Update the Project Structure section in CLAUDE.md to reflect the new directory layout: backend/, frontend/, cli/, tests/unit/, tests/integration/, etc.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:32:28.78106-08:00","updated_at":"2025-12-18T08:22:46.69703-08:00","closed_at":"2025-12-18T08:22:46.69703-08:00","dependencies":[{"issue_id":"story-vof","depends_on_id":"story-3y8","type":"blocks","created_at":"2025-12-18T07:34:14.911062-08:00","created_by":"kavinstewart"},{"issue_id":"story-vof","depends_on_id":"story-iaj","type":"blocks","created_at":"2025-12-18T07:34:20.073103-08:00","created_by":"kavinstewart"},{"issue_id":"story-vof","depends_on_id":"story-wn3","type":"blocks","created_at":"2025-12-18T07:34:25.236937-08:00","created_by":"kavinstewart"},{"issue_id":"story-vof","depends_on_id":"story-ve1","type":"blocks","created_at":"2025-12-18T07:34:30.415933-08:00","created_by":"kavinstewart"},{"issue_id":"story-vof","depends_on_id":"story-fu1","type":"blocks","created_at":"2025-12-18T07:34:35.576599-08:00","created_by":"kavinstewart"}]}
{"id":"story-vzv","title":"Set up TanStack Query + Zustand","description":"Install @tanstack/react-query v5, zustand. Create QueryClientProvider in root layout, create API client for FastAPI backend","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:50:37.935775-08:00","updated_at":"2025-12-18T09:09:19.390799-08:00","closed_at":"2025-12-18T09:09:19.390799-08:00","dependencies":[{"issue_id":"story-vzv","depends_on_id":"story-b69","type":"blocks","created_at":"2025-12-18T08:52:19.294046-08:00","created_by":"kavinstewart"}]}
{"id":"story-w025","title":"Rewrite db.py with asyncpg pool","description":"Replace SQLAlchemy engine with asyncpg pool. Create pool in lifespan handler, not at module import time. Add get_connection context manager.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T00:24:10.366704993Z","created_by":"kavin","updated_at":"2025-12-30T00:25:42.156857591Z","closed_at":"2025-12-30T00:25:42.156857591Z","close_reason":"Converted db.py to asyncpg pool, added init_pool/close_pool for lifespan, updated main.py","dependencies":[{"issue_id":"story-w025","depends_on_id":"story-taxl","type":"blocks","created_at":"2025-12-30T00:24:18.387272562Z","created_by":"daemon"}]}
{"id":"story-w4ub","title":"Create frontend caching system for story data and images","description":"Create a frontend caching system for story data and images to improve performance and offline capabilities.\n\n## Blocked on user decisions:\n- Caching strategy (in-memory, AsyncStorage, SQLite, etc.)\n- Storage limits and eviction policies\n- Cache invalidation approach\n- Which data to prioritize (images vs story text vs metadata)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-04T15:24:42.223853522Z","created_by":"kavin","updated_at":"2026-01-04T21:14:10.571473709Z","closed_at":"2026-01-04T21:14:10.571473709Z","close_reason":"Research complete. Architecture decided: expo-file-system + MMKV with custom StoryCacheManager for atomic story caching with controlled eviction. Implementation tracked in story-xx5t.","labels":["blocked-on-user"],"comments":[{"id":7,"issue_id":"story-w4ub","author":"kavin","text":"Blocked on user decisions regarding caching architecture. User needs to think through and decide on storage approach, limits, and invalidation strategy before implementation can begin.","created_at":"2026-01-04T15:25:32Z"}]}
{"id":"story-wep","title":"Add timeout to LLM API calls","description":"Set 120s timeout per LLM call in DSPy LM configuration. Fail fast on hanging connections rather than waiting indefinitely.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:08:34.537366-08:00","updated_at":"2025-12-19T15:26:24.293184-08:00","closed_at":"2025-12-19T15:26:24.293184-08:00"}
{"id":"story-whu9","title":"Unit tests: useRegenerateSpread React Query hook","description":"Test the frontend React Query mutation hook.\n\n## Test File\n`frontend/__tests__/hooks/useRegenerateSpread.test.ts`\n\n## Test Cases\n\n### test_mutation_calls_api_with_correct_params\n- Call mutate({ storyId: 'abc', spreadNumber: 3 })\n- Verify api.regenerateSpread called with 'abc', 3\n\n### test_optimistic_update_marks_spread_regenerating\n- Setup QueryClient with cached story data\n- Call mutate()\n- Immediately check cache (before API returns)\n- Verify spreads[spreadNumber]._regenerating === true\n\n### test_optimistic_update_cancels_inflight_queries\n- Start a refetch of story detail\n- Call mutate()\n- Verify cancelQueries was called for storyKeys.detail(storyId)\n- Prevents race condition where stale data overwrites optimistic update\n\n### test_success_invalidates_story_cache\n- Call mutate() and wait for success\n- Verify invalidateQueries called for storyKeys.detail(storyId)\n- This triggers refetch with new illustration_updated_at\n\n### test_error_refetches_story_to_restore_state\n- Mock api.regenerateSpread to reject\n- Call mutate()\n- Verify invalidateQueries called on error\n- Restores correct server state\n\n### test_mutation_returns_job_id_on_success\n- Mock api.regenerateSpread to return { job_id: 'xyz', status: 'pending' }\n- Call mutate()\n- Verify returned data contains job_id\n\n### test_isLoading_true_while_regenerating\n- Call mutate()\n- Check mutation.isPending === true\n- After resolve, isPending === false\n\n## Test Setup\n- Use @tanstack/react-query testing utilities\n- Mock api module\n- Wrap with QueryClientProvider","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-01T17:57:39.198776033Z","created_by":"kavin","updated_at":"2026-01-03T16:37:15.546284214Z","closed_at":"2026-01-03T16:37:15.546284214Z","close_reason":"Added 10 unit tests in __tests__/hooks/useRegenerateSpread.test.ts covering mutation, optimistic updates, error handling","dependencies":[{"issue_id":"story-whu9","depends_on_id":"story-uzi9","type":"blocks","created_at":"2026-01-01T17:58:18.807480399Z","created_by":"daemon"}]}
{"id":"story-wm7","title":"Remove non-illustrated story support","description":"Remove SIMPLE and STANDARD generation modes, keeping only ILLUSTRATED. This simplifies the codebase by removing branching logic for non-illustrated stories.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-17T11:45:20.581263-08:00","updated_at":"2025-12-17T11:50:45.37975-08:00","closed_at":"2025-12-17T11:50:45.37975-08:00"}
{"id":"story-wn3","title":"Move tests/ to tests/unit/ using git mv","description":"Use git mv to move contents of tests/ into tests/unit/. Includes conftest.py, test_api_stories.py, test_page_illustrator.py, test_image_extraction.py, __init__.py.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T07:31:39.937278-08:00","updated_at":"2025-12-18T08:21:44.206378-08:00","closed_at":"2025-12-18T08:21:44.206378-08:00","dependencies":[{"issue_id":"story-wn3","depends_on_id":"story-r4p","type":"blocks","created_at":"2025-12-18T07:33:24.648033-08:00","created_by":"kavinstewart"}]}
{"id":"story-wonw","title":"Config: Move generation defaults to config.py","description":"**Problem**: Generation defaults are hardcoded in story_service.py:16-19:\n```python\nDEFAULT_TARGET_AGE_RANGE = \"4-7\"\nDEFAULT_GENERATION_TYPE = \"illustrated\"\nDEFAULT_QUALITY_THRESHOLD = 7\nDEFAULT_MAX_ATTEMPTS = 3\n```\n\n**Fix**: Move these to `backend/api/config.py` alongside other settings like `MAX_CONCURRENT_JOBS`.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:39:48.547450155Z","created_by":"kavin","updated_at":"2026-01-03T22:48:08.86797433Z","closed_at":"2026-01-03T22:48:08.86797433Z","close_reason":"Fixed in commit 817e6c7"}
{"id":"story-woy","title":"Audit API models for dead code","description":"Review backend/api/models/ directory looking for redundant and/or dead code. Check for unused Pydantic models, deprecated fields, and models that are defined but never used.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:31:00.248783-08:00","updated_at":"2025-12-26T15:39:12.798399-08:00","closed_at":"2025-12-26T15:39:12.798399-08:00"}
{"id":"story-wpv","title":"Audit ImageQA for dead code","description":"Review backend/core/modules/image_qa.py execution path looking for redundant and/or dead code. Check for unused imports, unreachable code, deprecated patterns, and unused helper functions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:33.340932-08:00","updated_at":"2025-12-26T15:39:12.790555-08:00","closed_at":"2025-12-26T15:39:12.790555-08:00"}
{"id":"story-wre","title":"Audit LLM config for dead code","description":"Review backend/config/llm.py looking for redundant and/or dead code. Check for unused functions, deprecated configurations, and unused imports.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:45.755437-08:00","updated_at":"2025-12-26T15:39:12.793398-08:00","closed_at":"2025-12-26T15:39:12.793398-08:00"}
{"id":"story-x7f0","title":"Update StoryService for async repository","description":"Update StoryService to await async repository calls and handle async context","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T14:43:17.283298725Z","created_by":"kavin","updated_at":"2025-12-29T15:05:13.034947357Z","closed_at":"2025-12-29T15:05:13.034947357Z","close_reason":"Updated StoryService to use async session factory and new repository","dependencies":[{"issue_id":"story-x7f0","depends_on_id":"story-pd8","type":"blocks","created_at":"2025-12-29T14:44:16.50031991Z","created_by":"daemon"},{"issue_id":"story-x7f0","depends_on_id":"story-9b2","type":"blocks","created_at":"2025-12-29T14:44:16.514282109Z","created_by":"daemon"}]}
{"id":"story-x8y","title":"Clean up deprecated outline code","description":"Remove or deprecate: StoryOutlineSignature (or simplify dramatically), OutlineGenerator module, StoryOutline type fields that are no longer used. Keep only what's needed for the new workflow.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T19:44:23.724881-08:00","updated_at":"2025-12-20T09:50:02.11495-08:00","closed_at":"2025-12-20T09:50:02.11495-08:00","dependencies":[{"issue_id":"story-x8y","depends_on_id":"story-3li","type":"blocks","created_at":"2025-12-19T19:45:09.668276-08:00","created_by":"kavinstewart"}]}
{"id":"story-xfg","title":"Add VLMJudge evaluation logging","description":"Modify VLMJudge to log each evaluation with full context: image, prompt, character refs, raw VLM response, parsed result. Store in data/vlm_judge_evals/ with JSON metadata + image files.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T06:11:45.564173-08:00","updated_at":"2025-12-27T10:19:43.551052-08:00","closed_at":"2025-12-27T10:19:43.551052-08:00"}
{"id":"story-xfon","title":"Audit: CLI Entry Points","description":"**Code Path**: cli/\n\n**Files to examine**:\n- cli/generate_story.py\n- cli/run_api.py\n- cli/run_worker.py\n- cli/debug_page.py (if exists)\n- Any other CLI files\n\n**Investigation goals**:\n1. Look for duplicated argument parsing patterns\n2. Check for duplicated LLM/config initialization\n3. Identify non-KISS complexity in CLI tools\n4. Look for duplicated output formatting\n5. Check if CLI tools share enough common code or duplicate unnecessarily\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:46.995874203Z","created_by":"kavin","updated_at":"2026-01-03T19:28:46.995874203Z"}
{"id":"story-xnl","title":"Remove target_age_range from frontend API call","description":"Update the frontend createStory hook to only send 'goal' to the API (remove target_age_range and generation_type from the request).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T16:04:29.288538-08:00","updated_at":"2025-12-26T16:10:12.095138-08:00","closed_at":"2025-12-26T16:10:12.095138-08:00","dependencies":[{"issue_id":"story-xnl","depends_on_id":"story-6f5","type":"blocks","created_at":"2025-12-26T16:04:49.53144-08:00","created_by":"kavinstewart"}]}
{"id":"story-xrl","title":"Set up Reanimated v3 + Moti","description":"Install react-native-reanimated@3.x, moti. Configure babel plugin. Port float/wiggle/pageIn animations from prototypes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T08:50:44.372301-08:00","updated_at":"2025-12-18T09:09:19.391325-08:00","closed_at":"2025-12-18T09:09:19.391325-08:00","dependencies":[{"issue_id":"story-xrl","depends_on_id":"story-b69","type":"blocks","created_at":"2025-12-18T08:52:24.46073-08:00","created_by":"kavinstewart"}]}
{"id":"story-xv8s","title":"Dead code: Remove unused JobManager","description":"**Problem**: `backend/api/services/job_manager.py` defines a ThreadPoolExecutor-based JobManager, but it's never imported or used. The codebase uses ARQ for background jobs instead.\n\n**Evidence**: Grep for 'job_manager' only shows the definition file itself.\n\n**Fix**: Delete `job_manager.py` and remove from `__init__.py` if exported.\n\n**Parent**: story-qfgw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:39:50.75931233Z","created_by":"kavin","updated_at":"2026-01-04T00:26:02.713150387Z","closed_at":"2026-01-04T00:26:02.713150387Z","close_reason":"Deleted backend/api/services/job_manager.py and removed orphaned MAX_CONCURRENT_JOBS constant from config.py. Verified with unit tests (98 passed)."}
{"id":"story-xx5t","title":"Implement StoryCacheManager for offline story caching","description":"Implement a StoryCacheManager that provides atomic, controlled caching of stories for offline access on iPad.\n\n## Architecture\n\n```\nReact Query (in-memory, network)\n        ‚îÇ hydrates on app start\n        ‚ñº\nStoryCacheManager\n  ‚îú‚îÄ‚îÄ AsyncStorage (cache index + metadata)\n  ‚îî‚îÄ‚îÄ expo-file-system (FileSystem.documentDirectory/stories/{id}/)\n        ‚îú‚îÄ‚îÄ metadata.json\n        ‚îî‚îÄ‚îÄ spread_01.png ... spread_12.png\n```\n\n## Key Requirements\n\n1. **Atomic caching**: A story is either fully cached (metadata + all 12 images) or not at all\n2. **Controlled eviction**: LRU based on lastRead timestamp, enforced size limit (~500MB)\n3. **Story-level operations**: Cache, evict, and check status per-story\n\n## Implementation\n\n### Directory Structure\n```\n${FileSystem.documentDirectory}stories/\n  /{story-id}/\n    metadata.json    # Full story JSON from API (with file:// URLs)\n    spread_01.png\n    spread_02.png\n    ...\n    spread_12.png\n```\n\nUse `FileSystem.documentDirectory` (NOT cacheDirectory) - persists across app updates, not cleared by OS.\n\n### Cache Index (AsyncStorage)\n\nUse AsyncStorage (not MMKV) for web build compatibility. Follow pattern from `lib/auth-storage.ts`.\n\n```typescript\n// Key: 'story_cache_index'\n{\n  [storyId]: {\n    cachedAt: number,      // timestamp\n    lastRead: number,      // timestamp for LRU\n    sizeBytes: number,     // total size of story cache\n    spreadCount: number,   // for integrity check (typically 12)\n    title: string,         // for library display without full load\n  }\n}\n```\n\n### Core Operations\n\n1. **cacheStory(story)**: \n   - Create directory\n   - Download all images via `FileSystem.downloadAsync` (limit 4 concurrent)\n   - If ANY download fails, delete entire directory and return false\n   - Transform story object: rewrite `illustration_url` to `file://` paths\n   - Save transformed metadata.json\n   - Update AsyncStorage index\n   - Only mark complete if ALL downloads succeed\n\n2. **isStoryCached(storyId)**: Check AsyncStorage index AND verify directory exists with correct file count.\n\n3. **loadCachedStory(storyId)**: \n   - Read metadata.json (already has file:// URIs)\n   - Update `lastRead` timestamp in index\n   - Return Story object ready for React Query\n\n4. **evictStory(storyId)**: Delete directory, remove from AsyncStorage index.\n\n5. **invalidateStory(storyId)**: Same as evict - call after illustration regeneration to force re-download.\n\n6. **ensureCacheSpace(neededBytes)**: LRU eviction of oldest-read stories until space available.\n\n7. **hydrateQueryClient()**: \n   - Eager: Load cache index + populate story list query\n   - Lazy: Individual story details hydrated on access\n   - Don't block app start loading all 50 story objects\n\n8. **verifyCacheIntegrity()**: On app start, check each indexed story has all files. Remove orphaned entries.\n\n### URL Transformation\n\nWhen caching, transform the Story object so `illustration_url` fields become local paths:\n\n```typescript\n// Before (from API):\nspread.illustration_url = \"/stories/abc-123/spreads/1/image\"\n\n// After (in cached metadata.json):\nspread.illustration_url = \"file:///path/to/documentDirectory/stories/abc-123/spread_01.png\"\n```\n\nThis way the rest of the app renders cached stories without any changes.\n\n### Integration Points\n\n**1. QueryClient extraction** (`frontend/lib/query-client.ts` - NEW FILE):\n```typescript\nimport { QueryClient } from '@tanstack/react-query';\nexport const queryClient = new QueryClient();\n```\nImport in `_layout.tsx` and StoryCacheManager.\n\n**2. App startup** (`frontend/app/_layout.tsx`):\n- In AuthGate useEffect, after auth hydration:\n  ```typescript\n  await StoryCacheManager.verifyCacheIntegrity();\n  await StoryCacheManager.hydrateQueryClient();\n  ```\n\n**3. Story reader** (`frontend/app/read/[id].tsx`):\n- After useStory(id) resolves with story data:\n  ```typescript\n  useEffect(() =\u003e {\n    if (story?.is_illustrated \u0026\u0026 story.status === 'completed') {\n      StoryCacheManager.cacheStory(story); // background, don't await\n    }\n  }, [story?.id]);\n  ```\n\n**4. After regeneration** (`frontend/app/edit-prompt.tsx`):\n- When regeneration completes successfully:\n  ```typescript\n  await StoryCacheManager.invalidateStory(storyId);\n  ```\n  Forces re-download on next read with new illustration.\n\n**5. Settings screen** (NEW):\n- Show total cache size\n- \"Clear Cache\" button\n- Optional: list of cached stories with individual delete\n\n### Download Concurrency\n\nLimit parallel downloads to avoid saturating bandwidth:\n\n```typescript\nasync function downloadAllSpreads(story: Story, storyDir: string) {\n  const CONCURRENCY = 4;\n  const spreads = [...story.spreads];\n  \n  for (let i = 0; i \u003c spreads.length; i += CONCURRENCY) {\n    const batch = spreads.slice(i, i + CONCURRENCY);\n    const results = await Promise.all(\n      batch.map(spread =\u003e downloadSpread(story.id, spread, storyDir))\n    );\n    if (results.some(r =\u003e !r.success)) {\n      throw new Error('Download failed');\n    }\n  }\n}\n```\n\n### Error Handling\n\n- Wrap all FileSystem operations in try/catch\n- On partial download failure: delete entire story directory\n- Log errors with console.error for debugging\n- Never throw from background caching - just return false\n- Create `CacheError` class for typed errors if needed\n\n### File Structure\n\n```\nfrontend/\n  lib/\n    query-client.ts      # NEW - exported QueryClient singleton\n    cache-storage.ts     # NEW - AsyncStorage wrapper for cache index\n    story-cache.ts       # NEW - StoryCacheManager implementation\n  app/\n    _layout.tsx          # MODIFY - import queryClient, add hydration\n    read/[id].tsx        # MODIFY - trigger background caching\n    edit-prompt.tsx      # MODIFY - invalidate cache after regen\n    settings.tsx         # NEW - cache management UI\n```\n\n## Dependencies\n\n- expo-file-system (already available in Expo)\n- @react-native-async-storage/async-storage (already in package.json)\n- No MMKV needed (web compatibility)\n- No persistQueryClient needed (custom implementation)\n- No WatermelonDB needed\n\n## Storage Budget\n\n- Target: 500MB max cache\n- ~8.4MB per story average (12 images)\n- Capacity: ~50-60 stories\n\n## Not In Scope\n\n- Multi-device sync\n- Partial story caching\n- Background sync/refresh of cached content\n- Server-side story changes (completed stories treated as immutable except regeneration)","status":"closed","priority":2,"issue_type":"feature","created_at":"2026-01-04T21:14:00.610829877Z","created_by":"kavin","updated_at":"2026-01-04T21:36:45.574485118Z","closed_at":"2026-01-04T21:36:45.574485118Z","close_reason":"Split into 9 incremental beads: story-slt4, story-n04x, story-gso5, story-olko, story-hnta, story-o28s, story-i18e, story-ti3n, story-b80h","comments":[{"id":8,"issue_id":"story-xx5t","author":"kavin","text":"Updated based on expert review. Key additions:\n\n1. AsyncStorage instead of MMKV (web compatibility)\n2. FileSystem.documentDirectory explicitly specified\n3. URL transformation strategy (rewrite illustration_url to file://)\n4. invalidateStory() for regeneration cache busting\n5. QueryClient extraction to shared module\n6. Hydration strategy (eager index, lazy details)\n7. Download concurrency limit (4 parallel)\n8. Partial download cleanup\n9. Cache integrity verification on startup\n10. Settings UI for cache management\n\nSee expert discussion for rationale on each decision.","created_at":"2026-01-04T21:22:48Z"},{"id":9,"issue_id":"story-xx5t","author":"kavin","text":"**Concurrent downloads decision:** No story-level queuing for v1. Multiple concurrent story downloads are rare (user rapidly switching stories) and non-fatal (both complete, just slower). Atomic cleanup already handles partial failures.\n\n**Add progress indicator:** Show subtle 'Saving for offline...' indicator in story reader while caching is in progress. Gives user visibility into background activity and explains any slowness.\n\nExample placement: small text or icon near bottom of reader screen, disappears when caching completes.","created_at":"2026-01-04T21:28:32Z"}]}
{"id":"story-y1a7","title":"Remove surrogate key from character_references","description":"character_references has SERIAL id column that's never used. The natural key (story_id, character_name) is already UNIQUE.\n\nSteps:\n1. Create migration to:\n   - DROP the id column  \n   - DROP the UNIQUE constraint on (story_id, character_name)\n   - ADD PRIMARY KEY (story_id, character_name)\n2. Update repository.py if any code references the id column\n3. Run migration against dev database\n4. Run full test suite\n5. Verify character ref queries still work (list characters, get character image)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T21:39:28.184262533Z","created_by":"kavin","updated_at":"2025-12-30T21:58:58.260071665Z","closed_at":"2025-12-30T21:58:58.260071665Z","close_reason":"Migration 002 implemented. character_references now uses (story_id, character_name) as composite PK. All 54 tests pass.","dependencies":[{"issue_id":"story-y1a7","depends_on_id":"story-i4zq","type":"blocks","created_at":"2025-12-30T21:39:41.385361508Z","created_by":"daemon"}]}
{"id":"story-y2di","title":"E2E: Verify frontend logs reach backend","description":"Write an E2E test that verifies frontend logs are captured in backend logs. Test should: 1) Trigger an action in the frontend that logs something (e.g., open a story), 2) Check backend logs contain the [FRONTEND] marked entry, 3) Verify log includes expected context (level, message, timestamp).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T23:07:32.599821957Z","created_by":"kavin","updated_at":"2026-01-04T23:20:45.733429591Z","closed_at":"2026-01-04T23:20:45.733429591Z","close_reason":"Verified E2E: POST /logs/ingest returns 204, logs appear in journalctl with [FRONTEND] marker","dependencies":[{"issue_id":"story-y2di","depends_on_id":"story-guk2","type":"blocks","created_at":"2026-01-04T23:07:32.605319528Z","created_by":"daemon"}]}
{"id":"story-y54","title":"Remove unused imports in story_generator.py","description":"Remove STORY_CONSTANTS and get_default_lm imports - neither is used in the file","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T09:17:23.056585-08:00","updated_at":"2025-12-17T09:27:54.334735-08:00","closed_at":"2025-12-17T09:27:54.334735-08:00"}
{"id":"story-y8be","title":"Restart workers after asyncpg migration","description":"Workers started before bc62607 are still running old SQLAlchemy code. Need to restart to pick up asyncpg changes. Error: AsyncSession.execute() takes from 2 to 3 positional arguments but 7 were given","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T19:33:46.90953434Z","created_by":"kavin","updated_at":"2025-12-31T19:34:22.964960557Z","closed_at":"2025-12-31T19:34:22.964960557Z","close_reason":"Killed old workers (from Dec 29) and restarted with fresh process (PID 158925) that has asyncpg code"}
{"id":"story-ye1","title":"Audit DSPy signatures for dead code","description":"Review all files in backend/core/signatures/ looking for redundant and/or dead code. Check for unused signatures, deprecated fields, and signatures that are defined but never used in any module.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:27:45.864176-08:00","updated_at":"2025-12-26T15:39:12.791171-08:00","closed_at":"2025-12-26T15:39:12.791171-08:00"}
{"id":"story-yhz","title":"Children's Story Generator MVP","description":"Build an AI agent that generates high-quality children's picture books from brief goals/themes using DSPy and GEPA optimization. Pipeline: Outline ‚Üí Pages ‚Üí Quality Judge ‚Üí Iterate","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-11T09:36:40.107814-08:00","updated_at":"2025-12-11T13:56:50.445036-08:00","closed_at":"2025-12-11T13:56:50.445036-08:00"}
{"id":"story-ymv","title":"Create page illustrator module","description":"New module using gpt-image-1 images.edit() with character reference images + illustration prompt + locked style params to generate page illustrations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T10:35:20.18429-08:00","updated_at":"2025-12-13T10:41:54.62459-08:00","closed_at":"2025-12-13T10:41:54.62459-08:00","dependencies":[{"issue_id":"story-ymv","depends_on_id":"story-rtv","type":"blocks","created_at":"2025-12-13T10:35:52.25803-08:00","created_by":"kavinstewart"},{"issue_id":"story-ymv","depends_on_id":"story-68t","type":"blocks","created_at":"2025-12-13T10:35:57.423501-08:00","created_by":"kavinstewart"}]}
{"id":"story-z6r","title":"Rewrite page_illustrator for Nano Banana Pro","description":"Replace gpt-image-1 edit endpoint with Nano Banana Pro multimodal prompts. Pass all character reference images (up to 14) plus scene description in single generate_content call.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-16T11:13:05.054272-08:00","updated_at":"2025-12-16T11:20:48.849348-08:00","closed_at":"2025-12-16T11:20:48.849348-08:00","dependencies":[{"issue_id":"story-z6r","depends_on_id":"story-1f5","type":"blocks","created_at":"2025-12-16T11:13:37.686089-08:00","created_by":"kavinstewart"}]}
{"id":"story-zchu","title":"Audit: Database Layer","description":"**Code Path**: backend/api/database/\n\n**Files to examine**:\n- backend/api/database/db.py\n- backend/api/database/repository.py\n- backend/api/database/vlm_eval_repository.py\n- backend/api/database/schema.sql\n\n**Investigation goals**:\n1. Look for duplicated SQL query patterns\n2. Check for duplicated connection/pool management\n3. Identify non-KISS complexity in repository methods\n4. Look for duplicated row-to-model conversion logic\n5. Check for SRP violations (repository doing too much)\n\n**Deliverable**: Create sub-beads for each identified issue with proposed KISS/SRP-compliant fixes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T19:28:37.572794107Z","created_by":"kavin","updated_at":"2026-01-04T00:55:48.956956664Z","closed_at":"2026-01-04T00:55:48.956956664Z","close_reason":"Audit complete. 4 issues identified:\n- story-zchu.1: _record_to_response() is 90 lines with multiple responsibilities (P2)\n- story-zchu.2: StoryRepository has 8 regen job methods mixed in - SRP violation (P2)\n- story-zchu.3: Business logic (composed_prompt building) in repository layer (P2)\n- story-zchu.4: Duplicated filter logic in list_stories (P3)\n\nPositives: db.py is clean, schema is well-designed with proper indexes and FK cascades, pool management is solid."}
{"id":"story-zchu.1","title":"DB: Split _record_to_response (90 lines, SRP violation)","description":"**File**: backend/api/database/repository.py:423-513\n\n**Problem**: The `_record_to_response()` method is 90 lines and does too much:\n- Parses outline_json ‚Üí StoryMetadataResponse\n- Parses judgment_json ‚Üí QualityJudgmentResponse  \n- Converts spreads with complex logic (style extraction, composed_prompt building)\n- Converts character refs\n- Parses progress_json\n- Builds final StoryResponse\n\n**SRP violation**: Mixing JSON parsing, domain mapping, and URL building.\n\n**Fix options**:\n1. Extract private helper methods: `_parse_metadata()`, `_parse_judgment()`, `_build_spreads()`, etc.\n2. Create a dedicated `StoryResponseMapper` class\n\nRecommend option 1 for simplicity.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T00:55:36.159223136Z","created_by":"kavin","updated_at":"2026-01-04T01:06:16.754043242Z","closed_at":"2026-01-04T01:06:16.754043242Z","close_reason":"Split _record_to_response into 5 focused methods: _parse_metadata(), _parse_judgment(), _parse_progress(), _build_spread_responses(), _build_character_ref_responses(). Main method now 40 lines (was 91). All 105 unit tests pass.","dependencies":[{"issue_id":"story-zchu.1","depends_on_id":"story-zchu","type":"parent-child","created_at":"2026-01-04T00:55:36.164422931Z","created_by":"daemon"}]}
{"id":"story-zchu.2","title":"DB: Extract SpreadRegenJobRepository","description":"**File**: backend/api/database/repository.py\n\n**Problem**: `StoryRepository` has 8 methods for spread regeneration jobs mixed with story CRUD:\n- `create_spread_regen_job()` (283-298)\n- `get_spread_regen_job()` (300-306)\n- `get_active_spread_regen_job()` (308-331)\n- `cleanup_stale_spread_regen_jobs()` (333-352)\n- `update_spread_regen_status()` (354-377)\n- `update_spread_regen_progress()` (379-389)\n- `save_regenerated_spread()` (391-409)\n- `get_spread()` (411-421)\n\n**SRP violation**: Story CRUD and regen job management are separate concerns.\n\n**Fix**: Extract to `SpreadRegenJobRepository` class in same file or new file.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T00:55:36.910330822Z","created_by":"kavin","updated_at":"2026-01-04T01:21:51.325285737Z","closed_at":"2026-01-04T01:21:51.325285737Z","close_reason":"Extracted SpreadRegenJobRepository with 8 methods (create_job, get_job, get_active_job, cleanup_stale_jobs, update_status, update_progress, save_regenerated_spread, get_spread). Updated callers in spread_regeneration.py, worker.py, story_service.py, stories.py routes, and dependencies.py. All 105 unit tests pass.","dependencies":[{"issue_id":"story-zchu.2","depends_on_id":"story-zchu","type":"parent-child","created_at":"2026-01-04T00:55:36.915875696Z","created_by":"daemon"}]}
{"id":"story-zchu.3","title":"DB: Remove business logic from repository (composed_prompt)","description":"**File**: backend/api/database/repository.py:461-466\n\n**Problem**: Repository imports and uses `build_illustration_prompt()` to construct composed prompts during response mapping:\n```python\nfrom backend.core.types import build_illustration_prompt, DEFAULT_STYLE_PREFIX, DEFAULT_LIGHTING\n...\ncomposed_prompt=build_illustration_prompt(\n    illustration_prompt=s['illustration_prompt'] or '',\n    setting=setting,\n    style_prefix=style.prompt_prefix if style else DEFAULT_STYLE_PREFIX,\n    lighting=style.lighting_direction if style and style.lighting_direction else DEFAULT_LIGHTING,\n) if s['illustration_prompt'] else None,\n```\n\n**Issue**: This is business/presentation logic in the data access layer. The repository should just return data; prompt composition belongs in a service or response builder.\n\n**Fix**: Either:\n1. Move to a service layer that wraps repository calls\n2. Move to a dedicated response mapper\n3. Store composed_prompt in the database (denormalization)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T00:55:38.055265743Z","created_by":"kavin","updated_at":"2026-01-04T01:33:40.450395177Z","closed_at":"2026-01-04T01:33:40.450395177Z","close_reason":"Acceptable trade-off: pure function call for debug-only field. Added docstring noting rationale and future path if complexity grows.","dependencies":[{"issue_id":"story-zchu.3","depends_on_id":"story-zchu","type":"parent-child","created_at":"2026-01-04T00:55:38.060046799Z","created_by":"daemon"}]}
{"id":"story-zchu.4","title":"DB: Simplify list_stories duplicated filter logic","description":"**File**: backend/api/database/repository.py:200-236\n\n**Problem**: `list_stories()` has duplicated code paths for status filter vs no filter:\n```python\nif status:\n    total = await self.conn.fetchval(\n        'SELECT COUNT(*) FROM stories WHERE status = $1', status)\n    stories = await self.conn.fetch(\n        '''SELECT * FROM stories WHERE status = $1 ORDER BY created_at DESC LIMIT $2 OFFSET $3''',\n        status, limit, offset)\nelse:\n    total = await self.conn.fetchval('SELECT COUNT(*) FROM stories')\n    stories = await self.conn.fetch(\n        '''SELECT * FROM stories ORDER BY created_at DESC LIMIT $1 OFFSET $2''',\n        limit, offset)\n```\n\n**Fix**: Build query conditionally or use a helper. Low priority since it's not severe.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T00:55:38.940405746Z","created_by":"kavin","updated_at":"2026-01-05T03:49:59.255444495Z","closed_at":"2026-01-05T03:49:59.255444495Z","close_reason":"Refactored to build query conditionally instead of duplicate code paths","dependencies":[{"issue_id":"story-zchu.4","depends_on_id":"story-zchu","type":"parent-child","created_at":"2026-01-04T00:55:38.945368957Z","created_by":"daemon"}]}
{"id":"story-zgo","title":"Audit StoryService for dead code","description":"Review backend/api/services/story_service.py looking for redundant and/or dead code. Check for unused methods, deprecated code paths, unreachable branches, and redundant logic.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T15:28:14.312477-08:00","updated_at":"2025-12-26T15:39:12.791813-08:00","closed_at":"2025-12-26T15:39:12.791813-08:00"}
