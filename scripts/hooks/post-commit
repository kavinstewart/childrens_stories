#!/bin/bash
# Post-commit hook with bd compatibility
# Runs bd hooks first (if available), then custom worker restart logic

# Run bd hooks if available
if command -v bd >/dev/null 2>&1; then
    bd hooks run post-commit "$@" 2>/dev/null || true
fi

# === Custom: Auto-restart ARQ workers when backend code changes ===
CHANGED=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Check if worker-related files changed
if echo "$CHANGED" | grep -qE "^backend/(worker\.py|api/services/|core/modules/)"; then
  echo ""
  echo "=== Worker code changed, restarting workers ==="

  # Kill any orphaned workers not managed by systemd
  # (Don't kill the systemd-managed one - systemctl restart handles that)
  for pid in $(pgrep -f "arq backend.worker" 2>/dev/null); do
    # Check if this PID is the systemd-managed worker
    systemd_pid=$(systemctl --user show -p MainPID --value stories-worker.service 2>/dev/null)
    if [ "$pid" != "$systemd_pid" ]; then
      kill "$pid" 2>/dev/null || true
      echo "Killed orphan worker (PID: $pid)"
    fi
  done
  sleep 1

  # Restart via user-level systemd (the correct service name)
  if systemctl --user is-active --quiet stories-worker.service 2>/dev/null; then
    systemctl --user restart stories-worker.service && \
      echo "Workers restarted via systemd --user" || \
      echo "Warning: Failed to restart workers via systemd"
  else
    echo "Warning: stories-worker.service not active, starting directly..."
    cd /home/kavin/childrens_stories
    nohup poetry run arq backend.worker.WorkerSettings > /tmp/worker.log 2>&1 &
    echo "Worker started (PID: $!)"
  fi

  echo "=== Worker restart complete ==="
  echo ""
fi
