#!/bin/bash
# Pre-commit hook: bd hooks + Claude code review for source files
#
# Runs:
# 1. bd hooks (beads sync)
# 2. Claude code review (only for source code changes)

# Run bd hooks first
if command -v bd >/dev/null 2>&1; then
    bd hooks run pre-commit "$@"
    BD_EXIT=$?
    if [ $BD_EXIT -ne 0 ]; then
        exit $BD_EXIT
    fi
fi

# === Claude Code Review for Source Files ===

# Skip if SKIP_REVIEW is set
if [ -n "$SKIP_REVIEW" ]; then
    exit 0
fi

# Get staged diff for source code files only
SOURCE_PATTERNS="*.py *.ts *.tsx *.js *.jsx *.go *.rs *.java *.rb *.sh"
DIFF=$(git diff --cached --diff-filter=ACMR -- $SOURCE_PATTERNS 2>/dev/null)

# Skip if no source code changes
if [ -z "$DIFF" ]; then
    exit 0
fi

# Skip if claude command not available
if ! command -v claude >/dev/null 2>&1; then
    echo "Warning: claude command not found, skipping code review" >&2
    exit 0
fi

# Run Claude review
echo "Running Claude code review on source files..."
RESPONSE=$(claude -p "Review this diff for bugs, security issues, and obvious problems. Focus only on serious issues, not style.

If you find issues, respond with:
ISSUES_FOUND
- issue 1
- issue 2

If no issues, respond with exactly:
NO_ISSUES

$DIFF" 2>/dev/null)

# Check if claude succeeded
if [ $? -ne 0 ]; then
    echo "Warning: Claude review failed, continuing anyway" >&2
    exit 0
fi

# Check for explicit NO_ISSUES response
if echo "$RESPONSE" | grep -q "^NO_ISSUES"; then
    echo "Code review passed."
    exit 0
fi

# Check for ISSUES_FOUND marker
if echo "$RESPONSE" | grep -q "^ISSUES_FOUND"; then
    echo ""
    echo "=== CODE REVIEW: Issues Found ==="
    echo "$RESPONSE" | tail -n +2
    echo ""
    echo "Fix issues above or bypass with: SKIP_REVIEW=1 git commit ..."
    exit 1
fi

# Fallback: if response doesn't match expected format, pass through
echo "Code review passed (unstructured response)."
exit 0
